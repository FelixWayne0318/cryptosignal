#!/bin/bash
#
# ==========================================
# CryptoSignal VultræœåŠ¡å™¨å®Œæ•´éƒ¨ç½²è„šæœ¬
# ==========================================
# âš ï¸  é‡è¦å®‰å…¨è­¦å‘Šï¼š
#    - æ­¤æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Keys, Tokensï¼‰
#    - ä»…ä¿å­˜åœ¨æœ¬åœ°ç”µè„‘ï¼Œä¸¥ç¦æäº¤åˆ°Git
#    - éƒ¨ç½²æ—¶å¤åˆ¶åˆ°æœåŠ¡å™¨ï¼Œä½¿ç”¨åç«‹å³åˆ é™¤
# ==========================================
#
# ä½¿ç”¨æ–¹æ³•ï¼š
#   1. å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ°VultræœåŠ¡å™¨
#   2. chmod +x vultr_deploy_complete.sh
#   3. ./vultr_deploy_complete.sh
#   4. éƒ¨ç½²å®Œæˆååˆ é™¤æ­¤æ–‡ä»¶ï¼šrm vultr_deploy_complete.sh
#
# ä½œè€…ï¼šClaude AI
# æ—¥æœŸï¼š2025-11-10
# ç‰ˆæœ¬ï¼šv7.2
# ==========================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# ==========================================
# é…ç½®åŒºåŸŸ - æ‰€æœ‰æ•æ„Ÿä¿¡æ¯é›†ä¸­åœ¨æ­¤
# ==========================================

# GitHubé…ç½®
GITHUB_TOKEN="YOUR_GITHUB_TOKEN_HERE"
GIT_USER_NAME="FelixWayne0318"
GIT_USER_EMAIL="felixwayne0318@gmail.com"

# å½“å‰å¼€å‘åˆ†æ”¯ï¼ˆå¯ä¿®æ”¹ï¼‰
TARGET_BRANCH="claude/system-refactor-v7.2-011CUyBts14z3AdVhv9BSubr"

# Binance APIé…ç½®
BINANCE_API_KEY="YOUR_BINANCE_API_KEY_HERE"
BINANCE_API_SECRET="YOUR_BINANCE_API_SECRET_HERE"
BINANCE_TESTNET="false"

# Telegramé…ç½®
TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN_HERE"
TELEGRAM_CHAT_ID="YOUR_TELEGRAM_CHAT_ID_HERE"
TELEGRAM_ENABLED="true"

# æœåŠ¡å™¨é…ç½®
SERVER_IP_WHITELIST="YOUR_SERVER_IP_HERE"

# å®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆå°æ—¶ï¼‰
AUTO_RESTART_INTERVAL=2

# ==========================================
# é¢œè‰²å®šä¹‰
# ==========================================
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ==========================================
# è¾…åŠ©å‡½æ•°
# ==========================================
print_header() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${CYAN}â„¹ï¸  $1${NC}"
}

# ==========================================
# å¼€å§‹éƒ¨ç½²
# ==========================================
clear
echo -e "${CYAN}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                           â•‘
â•‘       CryptoSignal v7.2 æœåŠ¡å™¨è‡ªåŠ¨éƒ¨ç½²ç³»ç»Ÿ                â•‘
â•‘                                                           â•‘
â•‘       Powered by Claude AI                                â•‘
â•‘                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"

print_info "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
print_info "æœåŠ¡å™¨IPç™½åå•: $SERVER_IP_WHITELIST"
echo ""

# ç¡®è®¤ç»§ç»­
read -p "æ˜¯å¦ç»§ç»­éƒ¨ç½²ï¼Ÿ(y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_warning "éƒ¨ç½²å·²å–æ¶ˆ"
    exit 0
fi

# ==========================================
# æ­¥éª¤0ï¼šç¯å¢ƒæ£€æŸ¥
# ==========================================
print_header "æ­¥éª¤ 0/10: ç¯å¢ƒæ£€æŸ¥"

# æ£€æŸ¥Python
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
    print_success "Pythonç‰ˆæœ¬: $PYTHON_VERSION"
else
    print_error "æœªå®‰è£…Python3ï¼Œæ­£åœ¨å®‰è£…..."
    sudo apt-get update
    sudo apt-get install -y python3 python3-pip
fi

# æ£€æŸ¥pip
if command -v pip3 &> /dev/null; then
    print_success "pip3å·²å®‰è£…"
else
    print_error "æœªå®‰è£…pip3ï¼Œæ­£åœ¨å®‰è£…..."
    sudo apt-get install -y python3-pip
fi

# æ£€æŸ¥git
if command -v git &> /dev/null; then
    print_success "gitå·²å®‰è£…"
else
    print_error "æœªå®‰è£…gitï¼Œæ­£åœ¨å®‰è£…..."
    sudo apt-get install -y git
fi

# æ£€æŸ¥screenï¼ˆå¯é€‰ï¼‰
if command -v screen &> /dev/null; then
    print_success "screenå·²å®‰è£…"
else
    print_warning "screenæœªå®‰è£…ï¼Œå°†ä½¿ç”¨nohupè¿è¡Œ"
fi

# è·å–å½“å‰æœåŠ¡å™¨IP
CURRENT_IP=$(curl -s ifconfig.me 2>/dev/null || curl -s icanhazip.com 2>/dev/null || echo "æœªçŸ¥")
print_info "å½“å‰æœåŠ¡å™¨IP: $CURRENT_IP"

if [ "$CURRENT_IP" != "$SERVER_IP_WHITELIST" ] && [ "$CURRENT_IP" != "æœªçŸ¥" ]; then
    print_warning "æœåŠ¡å™¨IPä¸é…ç½®çš„ç™½åå•IPä¸ä¸€è‡´"
    print_warning "é…ç½®IP: $SERVER_IP_WHITELIST"
    print_warning "å½“å‰IP: $CURRENT_IP"
    print_warning "è¯·æ£€æŸ¥Binance APIçš„IPç™½åå•è®¾ç½®"
    echo ""
fi

# ==========================================
# æ­¥éª¤1ï¼šåœæ­¢æ—§è¿›ç¨‹
# ==========================================
print_header "æ­¥éª¤ 1/10: åœæ­¢æ—§è¿›ç¨‹"

# åœæ­¢Pythonè¿›ç¨‹
if ps aux | grep -v grep | grep "python.*cryptosignal" > /dev/null; then
    print_info "å‘ç°è¿è¡Œä¸­çš„Pythonè¿›ç¨‹ï¼Œæ­£åœ¨åœæ­¢..."
    pkill -f "python.*cryptosignal" 2>/dev/null || true
    sleep 2
    pkill -9 -f "python.*cryptosignal" 2>/dev/null || true
    print_success "Pythonè¿›ç¨‹å·²åœæ­¢"
else
    print_info "æ— è¿è¡Œä¸­çš„Pythonè¿›ç¨‹"
fi

# åœæ­¢Screenä¼šè¯
if command -v screen &> /dev/null; then
    if screen -ls 2>/dev/null | grep -q cryptosignal; then
        print_info "å‘ç°Screenä¼šè¯ï¼Œæ­£åœ¨åœæ­¢..."
        screen -S cryptosignal -X quit 2>/dev/null || true
        print_success "Screenä¼šè¯å·²åœæ­¢"
    fi
fi

# ==========================================
# æ­¥éª¤2ï¼šå¤‡ä»½æ—§é…ç½®
# ==========================================
print_header "æ­¥éª¤ 2/10: å¤‡ä»½æ—§é…ç½®"

BACKUP_DIR="$HOME/cryptosignal_backup_$(date +%Y%m%d_%H%M%S)"

if [ -d ~/cryptosignal ]; then
    print_info "å‘ç°æ—§å®‰è£…ï¼Œæ­£åœ¨å¤‡ä»½..."
    mkdir -p "$BACKUP_DIR"

    # å¤‡ä»½é…ç½®æ–‡ä»¶
    if [ -d ~/cryptosignal/config ]; then
        cp -r ~/cryptosignal/config "$BACKUP_DIR/" 2>/dev/null || true
        print_success "é…ç½®æ–‡ä»¶å·²å¤‡ä»½"
    fi

    # å¤‡ä»½æ•°æ®åº“
    if [ -d ~/cryptosignal/data ]; then
        cp -r ~/cryptosignal/data "$BACKUP_DIR/" 2>/dev/null || true
        print_success "æ•°æ®åº“å·²å¤‡ä»½"
    fi

    # å¤‡ä»½æ—¥å¿—
    if [ -f ~/cryptosignal/cryptosignal.log ]; then
        cp ~/cryptosignal/cryptosignal.log "$BACKUP_DIR/" 2>/dev/null || true
        print_success "æ—¥å¿—å·²å¤‡ä»½"
    fi

    print_success "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"

    # åˆ é™¤æ—§ä»£ç 
    print_info "åˆ é™¤æ—§ä»£ç ..."
    rm -rf ~/cryptosignal
    print_success "æ—§ä»£ç å·²åˆ é™¤"
else
    print_info "æœªå‘ç°æ—§å®‰è£…ï¼Œè·³è¿‡å¤‡ä»½"
fi

# å¤‡ä»½å…¶ä»–é…ç½®æ–‡ä»¶
if [ -f ~/.cryptosignal-github.env ]; then
    cp ~/.cryptosignal-github.env "$BACKUP_DIR/" 2>/dev/null || true
fi

# ==========================================
# æ­¥éª¤3ï¼šå…‹éš†ä»“åº“
# ==========================================
print_header "æ­¥éª¤ 3/10: å…‹éš†ä»“åº“"

cd ~

print_info "æ­£åœ¨å…‹éš†ä»“åº“..."
if git clone https://github.com/FelixWayne0318/cryptosignal.git; then
    print_success "ä»“åº“å…‹éš†æˆåŠŸ"
else
    print_error "ä»“åº“å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
    exit 1
fi

# ==========================================
# æ­¥éª¤4ï¼šåˆ‡æ¢åˆ†æ”¯
# ==========================================
print_header "æ­¥éª¤ 4/10: åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯"

cd ~/cryptosignal

print_info "åˆ‡æ¢åˆ°åˆ†æ”¯: $TARGET_BRANCH"
if git checkout "$TARGET_BRANCH"; then
    print_success "åˆ†æ”¯åˆ‡æ¢æˆåŠŸ"

    print_info "æ‹‰å–æœ€æ–°ä»£ç ..."
    if git pull origin "$TARGET_BRANCH"; then
        print_success "ä»£ç å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
    else
        print_warning "æ‹‰å–å¤±è´¥ï¼Œä½¿ç”¨å½“å‰ç‰ˆæœ¬"
    fi

    CURRENT_BRANCH=$(git branch --show-current)
    LATEST_COMMIT=$(git log --oneline -1)

    echo ""
    print_info "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
    print_info "æœ€æ–°æäº¤: $LATEST_COMMIT"
    echo ""

    print_success "åˆ†æ”¯åŠŸèƒ½åŒ…å«:"
    echo "   â€¢ P1.2: å›æµ‹éªŒè¯åŸºç¡€è®¾æ–½"
    echo "   â€¢ P1.1: Få› å­æ•°å€¼æ˜ å°„éªŒè¯"
    echo "   â€¢ v7.2: ç³»ç»Ÿè§„èŒƒåŒ–é‡æ„"
    echo "   â€¢ çµæ´»åˆ†æ”¯éƒ¨ç½²è„šæœ¬"
    echo "   â€¢ å®Œæ•´çš„æ–‡æ¡£ä½“ç³»"
else
    print_error "åˆ†æ”¯åˆ‡æ¢å¤±è´¥"
    print_warning "å¯ç”¨åˆ†æ”¯åˆ—è¡¨:"
    git branch -r | head -10
    exit 1
fi

# ==========================================
# æ­¥éª¤5ï¼šé…ç½®GitHubè®¿é—®
# ==========================================
print_header "æ­¥éª¤ 5/10: é…ç½®GitHubè®¿é—®æƒé™"

# åˆ›å»ºGitHubé…ç½®æ–‡ä»¶
cat > ~/.cryptosignal-github.env <<EOF
GITHUB_TOKEN="$GITHUB_TOKEN"
GIT_USER_NAME="$GIT_USER_NAME"
GIT_USER_EMAIL="$GIT_USER_EMAIL"
EOF
chmod 600 ~/.cryptosignal-github.env

print_success "GitHubé…ç½®æ–‡ä»¶å·²åˆ›å»º"
print_info "ä½ç½®: ~/.cryptosignal-github.env"
print_info "æƒé™: $(ls -la ~/.cryptosignal-github.env | awk '{print $1}')"

# é…ç½®Gitå…¨å±€è®¾ç½®
git config --global user.name "$GIT_USER_NAME"
git config --global user.email "$GIT_USER_EMAIL"
git config --global credential.helper store

# é…ç½®Gitå‡­è¯
echo "https://$GIT_USER_NAME:$GITHUB_TOKEN@github.com" > ~/.git-credentials
chmod 600 ~/.git-credentials

print_success "Gitå…¨å±€é…ç½®å·²åº”ç”¨"
print_info "user.name: $(git config user.name)"
print_info "user.email: $(git config user.email)"

# ==========================================
# æ­¥éª¤6ï¼šé…ç½®Binance API
# ==========================================
print_header "æ­¥éª¤ 6/10: é…ç½®Binance APIå‡­è¯"

mkdir -p ~/cryptosignal/config

cat > ~/cryptosignal/config/binance_credentials.json <<EOF
{
  "_comment": "Binance Futures APIå‡­è¯é…ç½® - è‡ªåŠ¨ç”Ÿæˆäº $(date)",
  "binance": {
    "api_key": "$BINANCE_API_KEY",
    "api_secret": "$BINANCE_API_SECRET",
    "testnet": $BINANCE_TESTNET,
    "_security": "åªè¯»æƒé™API Key",
    "_ip_whitelist": "$SERVER_IP_WHITELIST",
    "_current_ip": "$CURRENT_IP"
  }
}
EOF
chmod 600 ~/cryptosignal/config/binance_credentials.json

print_success "Binance APIé…ç½®å·²åˆ›å»º"
print_info "ä½ç½®: ~/cryptosignal/config/binance_credentials.json"
print_info "API Key: ${BINANCE_API_KEY:0:20}...${BINANCE_API_KEY: -4}"
print_info "é…ç½®IPç™½åå•: $SERVER_IP_WHITELIST"
print_info "å½“å‰æœåŠ¡å™¨IP: $CURRENT_IP"
print_info "æƒé™: $(ls -la ~/cryptosignal/config/binance_credentials.json | awk '{print $1}')"

if [ "$CURRENT_IP" != "$SERVER_IP_WHITELIST" ] && [ "$CURRENT_IP" != "æœªçŸ¥" ]; then
    echo ""
    print_warning "IPä¸åŒ¹é…ï¼è¯·åœ¨Binanceæ·»åŠ å½“å‰IPåˆ°ç™½åå•"
    print_info "è®¿é—®: https://www.binance.com/en/my/settings/api-management"
    print_info "æ·»åŠ IP: $CURRENT_IP"
fi

# ==========================================
# æ­¥éª¤7ï¼šé…ç½®Telegramé€šçŸ¥
# ==========================================
print_header "æ­¥éª¤ 7/10: é…ç½®Telegramé€šçŸ¥"

cat > ~/cryptosignal/config/telegram.json <<EOF
{
  "_comment": "Telegram Boté…ç½® - è‡ªåŠ¨ç”Ÿæˆäº $(date)",
  "enabled": $TELEGRAM_ENABLED,
  "bot_token": "$TELEGRAM_BOT_TOKEN",
  "chat_id": "$TELEGRAM_CHAT_ID",
  "_bot_name": "é‡çµé€š@analysis_token_bot",
  "_channel": "é“¾ä¸Šæœ›è¿œé•œ"
}
EOF
chmod 600 ~/cryptosignal/config/telegram.json

print_success "Telegramé…ç½®å·²åˆ›å»º"
print_info "ä½ç½®: ~/cryptosignal/config/telegram.json"
print_info "Bot: é‡çµé€š@analysis_token_bot"
print_info "é¢‘é“: é“¾ä¸Šæœ›è¿œé•œ"
print_info "å¯ç”¨çŠ¶æ€: $TELEGRAM_ENABLED"
print_info "æƒé™: $(ls -la ~/cryptosignal/config/telegram.json | awk '{print $1}')"

# ==========================================
# æ­¥éª¤8ï¼šåˆ›å»ºè‡ªåŠ¨é‡å¯è„šæœ¬
# ==========================================
print_header "æ­¥éª¤ 8/10: åˆ›å»ºè‡ªåŠ¨é‡å¯è„šæœ¬"

cat > ~/cryptosignal/auto_restart.sh <<'EOF'
#!/bin/bash
#
# CryptoSignal è‡ªåŠ¨é‡å¯è„šæœ¬
# ç”±å®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼Œç¡®ä¿ç³»ç»ŸæŒç»­è¿è¡Œ
#

LOG_FILE="$HOME/cryptosignal/auto_restart.log"

echo "========================================" >> "$LOG_FILE"
echo "è‡ªåŠ¨é‡å¯æ—¶é—´: $(date)" >> "$LOG_FILE"
echo "========================================" >> "$LOG_FILE"

# åœæ­¢æ—§è¿›ç¨‹
pkill -f "python.*cryptosignal" 2>/dev/null || true
sleep 2

# å¯åŠ¨æ–°è¿›ç¨‹
cd ~/cryptosignal
./setup.sh >> "$LOG_FILE" 2>&1 &

echo "é‡å¯å®Œæˆ" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"
EOF

chmod +x ~/cryptosignal/auto_restart.sh

print_success "è‡ªåŠ¨é‡å¯è„šæœ¬å·²åˆ›å»º"
print_info "ä½ç½®: ~/cryptosignal/auto_restart.sh"

# ==========================================
# æ­¥éª¤9ï¼šé…ç½®å®šæ—¶ä»»åŠ¡
# ==========================================
print_header "æ­¥éª¤ 9/10: é…ç½®å®šæ—¶ä»»åŠ¡"

# æ¸…ç†æ—§çš„å®šæ—¶ä»»åŠ¡
crontab -l 2>/dev/null | grep -v "cryptosignal" | grep -v "auto_restart" > /tmp/crontab.tmp || true

# æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡
cat >> /tmp/crontab.tmp <<EOF

# ==========================================
# CryptoSignal è‡ªåŠ¨åŒ–ä»»åŠ¡
# æ·»åŠ æ—¶é—´: $(date)
# ==========================================

# æ¯${AUTO_RESTART_INTERVAL}å°æ—¶è‡ªåŠ¨é‡å¯ç³»ç»Ÿ
0 */${AUTO_RESTART_INTERVAL} * * * ~/cryptosignal/auto_restart.sh

# æ¯å¤©å‡Œæ™¨1ç‚¹æ¸…ç†7å¤©å‰çš„æ—¥å¿—
0 1 * * * find ~ -name 'cryptosignal_*.log' -mtime +7 -delete

# æ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†è‡ªåŠ¨é‡å¯æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘100è¡Œï¼‰
0 2 * * * tail -n 100 ~/cryptosignal/auto_restart.log > ~/cryptosignal/auto_restart.log.tmp && mv ~/cryptosignal/auto_restart.log.tmp ~/cryptosignal/auto_restart.log

EOF

crontab /tmp/crontab.tmp
rm /tmp/crontab.tmp

print_success "å®šæ—¶ä»»åŠ¡å·²é…ç½®"
echo ""
print_info "å®šæ—¶ä»»åŠ¡åˆ—è¡¨:"
crontab -l | grep -A 10 "CryptoSignal" || crontab -l | tail -5

# ==========================================
# æ­¥éª¤10ï¼šéªŒè¯é…ç½®
# ==========================================
print_header "æ­¥éª¤ 10/10: éªŒè¯é…ç½®å®Œæ•´æ€§"

VALIDATION_ERRORS=0

echo "ğŸ” æ‰§è¡Œé…ç½®éªŒè¯..."
echo ""

# éªŒè¯1: é…ç½®æ–‡ä»¶å­˜åœ¨æ€§
echo "1ï¸âƒ£  é…ç½®æ–‡ä»¶æ£€æŸ¥:"
FILES_TO_CHECK=(
    "$HOME/.cryptosignal-github.env:GitHubé…ç½®"
    "$HOME/cryptosignal/config/binance_credentials.json:Binanceé…ç½®"
    "$HOME/cryptosignal/config/telegram.json:Telegramé…ç½®"
    "$HOME/cryptosignal/auto_restart.sh:é‡å¯è„šæœ¬"
    "$HOME/cryptosignal/setup.sh:å¯åŠ¨è„šæœ¬"
)

for item in "${FILES_TO_CHECK[@]}"; do
    IFS=':' read -r file desc <<< "$item"
    if [ -f "$file" ]; then
        print_success "$desc"
    else
        print_error "$desc ä¸å­˜åœ¨"
        ((VALIDATION_ERRORS++))
    fi
done

echo ""

# éªŒè¯2: æ–‡ä»¶æƒé™
echo "2ï¸âƒ£  æ–‡ä»¶æƒé™æ£€æŸ¥:"
SECURE_FILES=(
    "$HOME/.cryptosignal-github.env"
    "$HOME/cryptosignal/config/binance_credentials.json"
    "$HOME/cryptosignal/config/telegram.json"
)

for file in "${SECURE_FILES[@]}"; do
    if [ -f "$file" ]; then
        PERM=$(stat -c "%a" "$file" 2>/dev/null || stat -f "%Lp" "$file" 2>/dev/null)
        if [ "$PERM" = "600" ]; then
            print_success "$(basename $file): $PERM âœ“"
        else
            print_warning "$(basename $file): $PERM (å»ºè®®600)"
        fi
    fi
done

echo ""

# éªŒè¯3: Gité…ç½®
echo "3ï¸âƒ£  Gité…ç½®æ£€æŸ¥:"
if [ "$(git config user.name)" = "$GIT_USER_NAME" ]; then
    print_success "user.name: $(git config user.name)"
else
    print_error "user.nameé…ç½®é”™è¯¯"
    ((VALIDATION_ERRORS++))
fi

if [ "$(git config user.email)" = "$GIT_USER_EMAIL" ]; then
    print_success "user.email: $(git config user.email)"
else
    print_error "user.emailé…ç½®é”™è¯¯"
    ((VALIDATION_ERRORS++))
fi

echo ""

# éªŒè¯4: å®šæ—¶ä»»åŠ¡
echo "4ï¸âƒ£  å®šæ—¶ä»»åŠ¡æ£€æŸ¥:"
if crontab -l 2>/dev/null | grep -q "auto_restart.sh"; then
    print_success "è‡ªåŠ¨é‡å¯ä»»åŠ¡å·²é…ç½®"
else
    print_error "è‡ªåŠ¨é‡å¯ä»»åŠ¡æœªé…ç½®"
    ((VALIDATION_ERRORS++))
fi

if crontab -l 2>/dev/null | grep -q "cryptosignal_.*\.log"; then
    print_success "æ—¥å¿—æ¸…ç†ä»»åŠ¡å·²é…ç½®"
else
    print_warning "æ—¥å¿—æ¸…ç†ä»»åŠ¡æœªé…ç½®"
fi

echo ""

# éªŒè¯5: åˆ†æ”¯å’Œæäº¤
echo "5ï¸âƒ£  ä»£ç ç‰ˆæœ¬æ£€æŸ¥:"
CURRENT_BRANCH=$(cd ~/cryptosignal && git branch --show-current)
if [ "$CURRENT_BRANCH" = "$TARGET_BRANCH" ]; then
    print_success "åˆ†æ”¯: $CURRENT_BRANCH"
else
    print_warning "å½“å‰åˆ†æ”¯ ($CURRENT_BRANCH) ä¸ç›®æ ‡åˆ†æ”¯ ($TARGET_BRANCH) ä¸ä¸€è‡´"
fi

LATEST_COMMIT=$(cd ~/cryptosignal && git log --oneline -1)
print_info "æœ€æ–°æäº¤: $LATEST_COMMIT"

echo ""

# éªŒè¯6: å…³é”®æ–‡ä»¶
echo "6ï¸âƒ£  ç³»ç»Ÿæ–‡ä»¶æ£€æŸ¥:"
CRITICAL_FILES=(
    "scripts/realtime_signal_scanner.py"
    "ats_core/pipeline/analyze_symbol_v72.py"
    "ats_core/outputs/telegram_fmt.py"
    "setup.sh"
)

cd ~/cryptosignal
for file in "${CRITICAL_FILES[@]}"; do
    if [ -f "$file" ]; then
        print_success "$file"
    else
        print_error "$file ä¸å­˜åœ¨"
        ((VALIDATION_ERRORS++))
    fi
done

echo ""

# ==========================================
# éƒ¨ç½²å®Œæˆæ€»ç»“
# ==========================================
print_header "éƒ¨ç½²å®Œæˆ"

if [ $VALIDATION_ERRORS -eq 0 ]; then
    echo -e "${GREEN}"
    cat << "EOF"
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                       â•‘
    â•‘            âœ… éƒ¨ç½²æˆåŠŸï¼æ‰€æœ‰éªŒè¯é€šè¿‡ï¼                 â•‘
    â•‘                                                       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo -e "${NC}"
else
    echo -e "${YELLOW}"
    cat << "EOF"
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                       â•‘
    â•‘      âš ï¸  éƒ¨ç½²å®Œæˆï¼Œä½†æœ‰éªŒè¯é”™è¯¯ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°è¾“å‡º        â•‘
    â•‘                                                       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo -e "${NC}"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  ğŸ“‚ å®‰è£…ç›®å½•:  ~/cryptosignal"
echo "  ğŸŒ¿ å½“å‰åˆ†æ”¯:  $CURRENT_BRANCH"
echo "  ğŸ“ æœ€æ–°æäº¤:  $LATEST_COMMIT"
echo "  ğŸ”‘ é…ç½®æ–‡ä»¶:  å·²åˆ›å»ºå¹¶è®¾ç½®æƒé™"
echo "  â° å®šæ—¶ä»»åŠ¡:  æ¯${AUTO_RESTART_INTERVAL}å°æ—¶è‡ªåŠ¨é‡å¯"
echo "  ğŸŒ æœåŠ¡å™¨IP:  $CURRENT_IP"
echo "  ğŸ“¦ å¤‡ä»½ä½ç½®:  ${BACKUP_DIR:-æ— æ—§å®‰è£…}"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ==========================================
# ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
# ==========================================
print_header "ä¸‹ä¸€æ­¥æ“ä½œ"

echo "ğŸš€ å¯åŠ¨ç³»ç»Ÿ:"
echo ""
echo "   cd ~/cryptosignal"
echo "   ./setup.sh"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š æŸ¥çœ‹è¿è¡ŒçŠ¶æ€:"
echo ""
echo "   # æŸ¥çœ‹å®æ—¶æ—¥å¿—"
echo "   tail -f ~/cryptosignal/cryptosignal.log"
echo ""
echo "   # æŸ¥çœ‹è¿›ç¨‹"
echo "   ps aux | grep python | grep cryptosignal"
echo ""
echo "   # æŸ¥çœ‹å®šæ—¶ä»»åŠ¡"
echo "   crontab -l"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ é‡è¦æç¤º:"
echo ""
echo "   âœ“ é¦–æ¬¡è¿è¡Œsetup.shä¼šå®‰è£…Pythonä¾èµ–ï¼ˆçº¦3-5åˆ†é’Ÿï¼‰"
echo "   âœ“ ç³»ç»Ÿä¼šè‡ªåŠ¨è¿æ¥Binance WebSocketè·å–å®æ—¶æ•°æ®"
echo "   âœ“ Telegramä¼šæ”¶åˆ°ç³»ç»Ÿå¯åŠ¨å’Œä¿¡å·é€šçŸ¥"
echo "   âœ“ æ¯${AUTO_RESTART_INTERVAL}å°æ—¶è‡ªåŠ¨é‡å¯ç¡®ä¿ç¨³å®šè¿è¡Œ"
echo "   âœ“ æ—¥å¿—æ–‡ä»¶ä¼šè‡ªåŠ¨æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘7å¤©"
echo ""

if [ "$CURRENT_IP" != "$SERVER_IP_WHITELIST" ] && [ "$CURRENT_IP" != "æœªçŸ¥" ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    print_warning "IPåœ°å€ä¸åŒ¹é…è­¦å‘Š"
    echo ""
    echo "   é…ç½®çš„IPç™½åå•: $SERVER_IP_WHITELIST"
    echo "   å½“å‰æœåŠ¡å™¨IP:   $CURRENT_IP"
    echo ""
    echo "   âš ï¸  è¯·åœ¨Binance APIç®¡ç†ä¸­æ·»åŠ å½“å‰IPåˆ°ç™½åå•"
    echo "   ğŸ”— è®¿é—®: https://www.binance.com/en/my/settings/api-management"
    echo ""
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
print_warning "å®‰å…¨æé†’"
echo ""
echo "   âš ï¸  æ­¤éƒ¨ç½²è„šæœ¬åŒ…å«æ•æ„Ÿä¿¡æ¯"
echo "   âš ï¸  å»ºè®®ç«‹å³åˆ é™¤æ­¤è„šæœ¬: rm $(basename $0)"
echo "   âš ï¸  æ‰€æœ‰é…ç½®å·²ä¿å­˜åœ¨ç³»ç»Ÿä¸­ï¼Œä¸éœ€è¦ä¿ç•™æ­¤è„šæœ¬"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# è¯¢é—®æ˜¯å¦ç«‹å³å¯åŠ¨
echo -n "æ˜¯å¦ç«‹å³å¯åŠ¨ç³»ç»Ÿï¼Ÿ(y/N): "
read -r START_NOW

if [[ $START_NOW =~ ^[Yy]$ ]]; then
    echo ""
    print_info "æ­£åœ¨å¯åŠ¨ç³»ç»Ÿ..."
    cd ~/cryptosignal
    ./setup.sh
else
    echo ""
    print_info "ç¨åæ‰‹åŠ¨å¯åŠ¨ç³»ç»Ÿ:"
    echo "   cd ~/cryptosignal && ./setup.sh"
fi

echo ""
print_success "éƒ¨ç½²è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼"
echo ""

# æç¤ºåˆ é™¤è„šæœ¬
echo -e "${RED}"
echo "âš ï¸âš ï¸âš ï¸ é‡è¦å®‰å…¨æé†’ âš ï¸âš ï¸âš ï¸"
echo ""
echo "æ­¤è„šæœ¬åŒ…å«æ•æ„Ÿçš„APIå¯†é’¥å’Œè®¿é—®ä»¤ç‰Œ"
echo "å¼ºçƒˆå»ºè®®ç«‹å³åˆ é™¤æ­¤æ–‡ä»¶ï¼"
echo ""
echo "åˆ é™¤å‘½ä»¤: rm $(realpath $0)"
echo -e "${NC}"
echo ""
