# v6.6 系统测试指南

## 🚀 快速测试（推荐）

### 方法1: 使用新的v6.6测试脚本（5个币种）

```bash
cd ~/cryptosignal
git pull

# 运行v6.6测试（测试5个主流币）
python3 tests/test_v66_5coins.py
```

**测试内容**:
- ✅ 6个核心因子 (T/M/C/V/O/B) 范围验证
- ✅ 4个调制器 (L/S/F/I) 范围验证
- ✅ 废弃因子 (Q/E) 清理验证
- ✅ 软约束系统验证
- ✅ 详细因子输出验证

**预期输出示例**:
```
🧪 v6.6架构测试 - 5个币种因子系统验证
======================================================================

测试币种: BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, ADAUSDT

[1/5] 分析 BTCUSDT...
📊 [BTCUSDT] v6.6因子详细分析:
   A层-核心因子(6): T=+45.2(24%→+10.8), M=+23.1(17%→+3.9), C=+67.8(24%→+16.3), V=-12.3(12%→-1.5), O=+34.5(17%→+5.9), B=+8.9(6%→+0.5)
   B层-调制器(4):   L=+56.7, S=+23.4, F=-12.1, I=+45.6
   加权总分: +35.90 | 置信度: 72.3 | Edge: +0.2156
   方向: LONG | P=0.623 | Prime强度: 68.4/60.0
   调制链输出: 仓位倍数=0.85, Teff=6.2h, Cost=0.0042
   软约束: ✅ 通过
   发布状态: 🟢 Prime

  ✅ 成功分析
     加权分数: +35.9 | 置信度: 72.3 | Edge: +0.2156
     概率: 62.3% | 发布状态: 🟢Prime

     【A层核心因子(6) - 权重100%】
       T: +45.2  ✅
       M: +23.1  ✅
       C: +67.8  ✅
       V: -12.3  ✅
       O: +34.5  ✅
       B:  +8.9  ✅

     【B层调制器(4) - 权重0%】
       L: +56.7  ✅
       S: +23.4  ✅
       F: -12.1  ✅
       I: +45.6  ✅

     ✅ 废弃因子检查通过 (Q/E未参与评分)

     【软约束检查】
       EV: +0.0234 (✅>0)
       P门槛: ✅通过
       软过滤: ✅否

     【调制器输出】
       仓位倍数: 0.85
       有效时间: 6.2h
       调制成本: 0.0042

... (其他4个币种) ...

======================================================================
📊 v6.6架构验证汇总
======================================================================

成功分析: 5/5
核心因子范围正常: 5/5
调制器范围正常: 5/5
废弃因子清理: 5/5
Prime信号: 2/5
Watch信号: 1/5

✅ 所有测试通过！v6.6架构完全合规
   - 6个核心因子在±100范围内
   - 4个调制器在±100范围内
   - 废弃因子(Q/E)未参与评分
```

---

### 方法2: 测试自定义币种

编辑测试脚本中的币种列表：

```bash
# 编辑测试文件
nano tests/test_v66_5coins.py

# 修改第26行
test_symbols = ['YOUR1USDT', 'YOUR2USDT', 'YOUR3USDT', ...]

# 运行测试
python3 tests/test_v66_5coins.py
```

---

## 📊 详细因子日志

系统现在会为每个分析的币种输出详细的因子信息：

### 输出格式说明

```
📊 [SYMBOL] v6.6因子详细分析:
   A层-核心因子(6): T=±XX(权重%→贡献), M=..., C=..., V=..., O=..., B=...
   B层-调制器(4):   L=±XX, S=±XX, F=±XX, I=±XX
   加权总分: ±XX | 置信度: XX | Edge: ±X.XXXX
   方向: LONG/SHORT | P=X.XXX | Prime强度: XX/XX
   调制链输出: 仓位倍数=X.XX, Teff=X.Xh, Cost=X.XXXX
   软约束: ✅通过 / ⚠️ EV=..., P=...
   发布状态: 🟢Prime / 🟡Watch / ⚪不发布
   拒绝原因: ...（如有）
```

**字段解释**:
- **T/M/C/V/O/B**: 6个核心因子分数（-100到+100）
- **权重%**: 每个因子的权重百分比
- **贡献**: 因子对总分的实际贡献（分数×权重）
- **L/S/F/I**: 4个调制器分数（不参与评分）
- **加权总分**: 6个核心因子的加权和（-100到+100）
- **仓位倍数**: L调制器调制后的仓位系数（0.30-1.00）
- **Teff**: F/I调制器调制后的有效时间
- **Cost**: L调制器调制后的交易成本
- **软约束**: EV和P检查结果（仅标记，不拒绝）

---

## 🔍 问题排查

### 问题1: 所有币种分析失败

**症状**:
```
⚠️  BTCUSDT 分析失败: local variable 'publish_cfg' referenced before assignment
```

**解决**:
```bash
git pull  # 获取最新修复
```

**原因**: 变量引用顺序错误，已在 commit `496242a` 修复

---

### 问题2: 缺失Q因子错误

**症状**:
```
❌ 配置错误: 缺少必需的因子权重
缺失因子: Q
```

**解决**:
```bash
git pull  # 获取最新修复
```

**原因**: cfg.py仍检查v6.0因子列表，已在 commit `71c2a09` 修复

---

### 问题3: agg_trades参数错误

**症状**:
```
⚠️  BTCUSDT 分析失败: analyze_symbol_with_preloaded_klines() got an unexpected keyword argument 'agg_trades'
```

**解决**:
```bash
git pull  # 获取最新修复
```

**原因**: 批量扫描器传递已移除的参数，已在 commit `3c9dba0` 修复

---

### 问题4: 缺少numpy模块

**症状**:
```
ModuleNotFoundError: No module named 'numpy'
```

**解决**:
```bash
# 在实际部署环境中运行（应已安装依赖）
cd ~/cryptosignal
pip install -r requirements.txt
```

---

## 📝 v6.6架构要点

### 核心原则

1. **A层核心因子 (6个, 权重100%)**
   - T (趋势): 24%
   - M (动量): 17%
   - C (CVD资金流): 24%
   - V (量能): 12%
   - O (持仓量): 17%
   - B (基差): 6%

2. **B层调制器 (4个, 权重0%)**
   - L (流动性): 调制仓位倍数
   - S (结构): 调制置信度
   - F (资金领先): 调制有效时间
   - I (独立性): 调制有效时间

3. **废弃因子**
   - Q (清算密度): 数据不可靠
   - E (环境): 收益率低
   - S从A层移至B层（调制器）

4. **软约束系统**
   - EV ≤ 0: 仅标记，不硬拒绝
   - P < p_min: 仅标记，不硬拒绝
   - soft_filtered=True 但 success=True

---

## 🎯 预期测试结果

### 成功标准

✅ **所有核心因子在±100范围**
```
T: +45.2  ✅
M: +23.1  ✅
... (6个因子全部✅)
```

✅ **所有调制器在±100范围**
```
L: +56.7  ✅
S: +23.4  ✅
F: -12.1  ✅
I: +45.6  ✅
```

✅ **废弃因子未参与评分**
```
✅ 废弃因子检查通过 (Q/E未参与评分)
```

✅ **权重配置正确**
```
核心因子权重总和 = 100%
调制器权重 = 0%
```

---

## 📞 技术支持

如遇到其他问题，请：
1. 检查 `tests/README.md` 了解测试文件状态
2. 查看最新的commit历史
3. 确保使用最新代码：`git pull`
4. 查看系统日志获取详细错误信息

---

## 🔗 相关文档

- `tests/README.md` - 测试目录说明
- `standards/00_INDEX.md` - v6.6架构规范
- `docs/v6.6/` - v6.6设计文档
