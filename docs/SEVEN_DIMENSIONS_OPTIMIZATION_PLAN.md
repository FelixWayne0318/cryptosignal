# 七维指标系统性优化方案

## 执行计划

基于CVD优化经验，对T/V/O/F四个指标进行系统性验证和优化。

## 一、F（资金领先）优化方案

### 当前问题

**用户反馈**：
> "资金领先 35，这种方式让人看不懂，35也让人看不明白，具体领先到什么程度"

**当前实现**：
```python
F = 50 + 50 * tanh((资金动量 - 价格动量) / 20)
范围：0-100
```

**问题分析**：
1. ❌ F=35 无法直观理解是资金领先还是价格领先
2. ❌ 数值35不能反映领先程度
3. ❌ 没有正负号区分方向

### 改进方案

**新设计**：
```python
F = 100 * tanh((资金动量 - 价格动量) / 20)
范围：-100 到 +100
```

**物理意义**：
- **F > 0**：资金领先价格（蓄势待发）
- **F < 0**：价格领先资金（追高风险）
- **|F| 大小**：领先程度

**描述映射**：
```
F >= +60：资金强势领先 (蓄势待发)
F >= +30：资金温和领先 (机会较好)
-30 < F < +30：资金价格同步
F <= -30：价格温和领先 (追高风险)
F <= -60：价格强势领先 (风险很大)
```

**Telegram显示**：
```
旧版：⚡ 资金领先 35 → 概率调整 ×0.90
新版：⚡ 价格领先资金 (F=-15, 追高风险) → 概率调整 ×0.90
或：  ⚡ 资金领先价格 (F=+45, 蓄势待发) → 概率调整 ×1.08
```

---

## 二、V（量能）优化方案

### 验证清单检查

#### ✅ 物理意义验证
当前：V = v5/v20 比值
- 定义清晰 ✓
- v5/v20 > 1 = 放量 ✓

#### ⚠️ 方向性问题
- 当前无正负号
- 无法区分"放量上涨"vs"放量下跌"

### 改进方案

**新增量价配合度**：
```python
# 当前只有量能比值
v5v20 = v5 / v20

# 新增：量价配合
if 做多:
    期望：量能上升 + 价格上涨
   不利：量能上升 + 价格下跌（可能见顶）

if 做空:
    期望：量能上升 + 价格下跌
   不利：量能上升 + 价格上涨（可能见底）
```

**建议保持当前设计**：
- V本身是中性指标（多空都需要量能）
- 量价配合已经在F（资金领先）中体现
- 不需要改为带符号

---

## 三、O（持仓）优化方案

### 验证清单检查

#### ✅ 物理意义验证
当前：O = OI变化率
- 定义清晰 ✓
- OI上升 = 持仓增加 ✓

#### ⚠️ 方向性问题
- 当前逻辑：
  - 做多时，OI上升好（多头持仓增加）
  - 做空时，OI下降好（多头平仓）

### 改进方案

**当前实现已合理**：
```python
if side_long:
    O_score = directional_score(oi_change_pct, ...)  # OI上升好
else:
    O_score = directional_score(-oi_change_pct, ...) # OI下降好
```

**建议保持**：
- 逻辑已经考虑方向
- 持仓与价格的配合已在F中体现
- 不需要改为带符号

---

## 四、T（趋势）优化方案

### 验证清单检查

#### ✅ 物理意义验证
当前：基于EMA30的趋势判断
- 定义清晰 ✓

#### ⚠️ 持续性验证
- 是否被单根K线主导？
- 是否有滞后性？
- 需要详细验证

### 待验证问题

1. 趋势计算是否使用斜率？
2. 是否存在震荡误判？
3. 是否需要类似CVD的R²验证？

---

## 五、统一描述风格

参考CVD的描述方式，统一其他指标：

### CVD（资金流）✅ 已完成
```
• 资金流 🟢 +85 —— 强劲资金流入 (CVD+2.3%, 持续✓)
```

### F（资金领先）→ 待改进
```
旧：⚡ 资金领先 35 → 概率调整 ×0.90
新：⚡ 价格领先资金 (F=-15, 追高风险) → 概率调整 ×0.90
```

### V（量能）→ 保持
```
• 量能 🟢 87 —— 放量明显 (v5/v20=1.42)
```

### O（持仓）→ 保持
```
• 持仓 🟢 67 —— 多头持仓温和上升 (OI+47.0%)
```

### T（趋势）→ 待验证
```
• 趋势 🟢 78 —— 强势/上行倾向 [多头]
```

---

## 六、执行步骤

### 步骤1：优化F（资金领先）✅ 已完成
1. [x] 改为-100到+100带符号
2. [x] 更新描述函数
3. [x] 更新Telegram显示
4. [x] 更新概率调整逻辑
5. [x] 测试验证（test_fund_leading_signed.py）

**改动文件**：
- ats_core/features/fund_leading.py
- ats_core/outputs/telegram_fmt.py
- ats_core/pipeline/analyze_symbol.py

### 步骤2：验证T（趋势）✅ 已完成
1. [x] 读取trend.py代码
2. [x] 用验证清单检查
3. [x] 确认不需要修改（当前设计合理）
4. [x] 创建验证报告（TREND_VALIDATION_REPORT.md）

**结论**：T保持0-100 + Tm方向标记，不改为带符号

### 步骤3：验证V和O ✅ 已完成
1. [x] 确认V和O不需要改为带符号
2. [x] 确认与价格的配合已在F中体现
3. [x] 创建验证报告（VO_VALIDATION_REPORT.md）

**结论**：V和O保持当前实现，无需代码改动

### 步骤4：统一文档 ✅ 已完成
1. [x] 创建F的测试文件（test_fund_leading_signed.py）
2. [x] 创建T的验证报告（TREND_VALIDATION_REPORT.md）
3. [x] 创建V/O的验证报告（VO_VALIDATION_REPORT.md）
4. [x] 更新优化计划文档（本文件）

---

## 七、关键决策

### Q1：哪些指标需要带符号？
- ✅ C（CVD）：需要，区分流入/流出
- ✅ F（资金领先）：需要，区分谁领先谁
- ❌ V（量能）：不需要，多空都需要量能
- ❌ O（持仓）：不需要，已在打分时考虑方向
- ❌ T（趋势）：不需要，已有Tm标记方向

### Q2：F的概率调整系数如何计算？
```python
# 旧版（基于0-100）
if F >= 60: adj = 1.05
elif F >= 40: adj = 1.0
else: adj = 0.90 + (F/40) * 0.1

# 新版（基于-100到+100）
F_normalized = (F + 100) / 200  # 映射到0-1
if F > 0:
    # 资金领先，加分
    adj = 1.0 + 0.1 * (F / 100)  # 1.0-1.1
else:
    # 价格领先，减分
    adj = 0.9 + 0.1 * ((F + 100) / 100)  # 0.9-1.0
```

### Q3：V和O是否需要与价格的领先关系？
**决定：不需要**
- F已经综合考虑了资金（包含V、O、C）vs 价格的领先关系
- V和O保持独立评分，在F中组合
- 避免重复计算

---

## 八、验证标准

所有优化必须通过：

### 功能测试
- [ ] 极端值测试（F=+100, F=-100）
- [ ] 边界测试（F=0附近）
- [ ] 反例测试（能否构造不合理的情况）

### 显示测试
- [ ] Telegram消息格式正确
- [ ] 描述文字直观易懂
- [ ] 符号显示正确

### 逻辑测试
- [ ] 与其他指标无冲突
- [ ] Prime判定逻辑正确
- [ ] 概率调整合理

---

## 当前状态

- [x] 创建优化方案文档
- [x] 实现F的改进（带符号-100到+100）
- [x] 验证T（保持当前设计）
- [x] 验证V和O（保持当前设计）
- [x] 创建验证报告和测试文件
- [x] 更新优化计划文档
- [ ] 提交代码到Git

---

## 完成总结

### ✅ 已完成的改进

#### 1. F（资金领先）优化 ✅
**改动**：
- 从 0-100 改为 -100 到 +100（带符号）
- 正数 = 资金领先价格（蓄势待发）
- 负数 = 价格领先资金（追高风险）

**文件**：
- `ats_core/features/fund_leading.py` - 核心计算逻辑
- `ats_core/outputs/telegram_fmt.py` - 显示描述
- `ats_core/pipeline/analyze_symbol.py` - 概率调整逻辑

**测试**：
- `test_fund_leading_signed.py` - 全部测试通过 ✅

**显示效果**：
```
旧版：⚡ 资金领先 35 → 概率调整 ×0.90
新版：⚡ 价格领先资金 (F=-35, 追高风险) → 概率调整 ×0.90
```

#### 2. T（趋势）验证 ✅
**结论**：
- 当前实现已经使用线性回归斜率（与CVD一致）
- 使用 R² 进行置信度加权
- 不存在单根K线主导问题
- 保持 T(0-100) + Tm(-1/0/1) 设计
- **无需代码改动**

**文档**：
- `docs/TREND_VALIDATION_REPORT.md` - 详细验证报告

#### 3. V（量能）验证 ✅
**结论**：
- V 是中性指标（多空都需要量能）
- 量价配合已在 F（资金领先）中体现
- 不需要改为带符号
- **无需代码改动**

**文档**：
- `docs/VO_VALIDATION_REPORT.md` - 详细验证报告

#### 4. O（持仓）验证 ✅
**结论**：
- 方向性已正确处理（内部取反）
- 价格OI配合已在 align_score 中体现
- 也在 F（资金领先）中参与计算
- 不需要改为带符号
- **无需代码改动**

**文档**：
- `docs/VO_VALIDATION_REPORT.md` - 详细验证报告

---

### 📊 七维指标最终设计

| 维度 | 范围 | 符号 | 说明 |
|------|------|------|------|
| **C（资金流）** | -100 到 +100 | ✅ 有 | 正=流入，负=流出 |
| **F（资金领先）** | -100 到 +100 | ✅ 有 | 正=资金领先，负=价格领先 |
| **V（量能）** | 0 到 100 | ❌ 无 | 中性指标（多空都需要） |
| **O（持仓）** | 0 到 100 | ❌ 无 | 内部处理方向 |
| **T（趋势）** | 0 到 100 | ❌ 无 | + Tm标记方向 |
| **M（动量）** | 0 到 100 | ❌ 无 | 方向感知 |
| **S（结构）** | 0 到 100 | ❌ 无 | 支撑/阻力 |
| **E（环境）** | 0 到 100 | ❌ 无 | Chop指数 |

**设计原则**：
- **绝对方向的指标**（C、F）：使用带符号
- **适配度指标**（V、O、T、M）：使用 0-100（内部处理方向）
- **中性指标**（E）：使用 0-100

---

### 🎯 用户问题解决情况

#### 问题1：资金领先 35 让人看不懂 ✅
**解决**：
```
旧版：资金领先 35
新版：价格领先资金 (F=-35, 追高风险)
或：  资金领先价格 (F=+45, 蓄势待发)
```
✅ 一眼就能看懂谁领先谁，领先程度如何

#### 问题2：V和O是否需要与价格比较 ✅
**解决**：
- V 和 O 已经在 F（资金领先）中与价格比较
- F = fund_momentum - price_momentum
- fund_momentum = 0.4×OI + 0.3×V + 0.3×CVD
- ✅ 不需要重复计算

#### 问题3：用同样方法优化T/V/O/F ✅
**解决**：
- 使用统一的验证清单（7步验证法）
- 验证了所有指标的物理意义、方向性、持续性
- 确认了哪些需要带符号、哪些不需要
- ✅ 所有指标验证完成

---

### 📝 下一步

**建议操作**：
1. 运行一次完整测试确保所有功能正常
2. 提交代码到Git分支
3. 观察实际运行效果
4. 根据用户反馈进一步调整

**可选优化**（未来）：
- 统一V和O的描述风格（参考CVD的简洁风格）
- 在Telegram显示中强调T的Tm方向和R²
- 添加更多测试用例
