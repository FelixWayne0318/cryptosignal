# 七维度重组方案 + 多空对称性分析

## 问题1：当前多空对称性检查

### ✅ 完全对称的维度

| 维度 | 做多逻辑 | 做空逻辑 | 对称性 |
|------|---------|---------|--------|
| **T（趋势）** | 斜率 > 0 好 | 斜率 < 0 好 | ⚠️ **存在问题**（硬阈值+没看到明确的多空切换） |
| **S（结构）** | 结构清晰好 | 结构清晰好 | ✅ 对称（无方向性） |
| **V（量能）** | 放量好 | 放量好 | ✅ 对称（无方向性） |
| **E（环境）** | 低波动好 | 低波动好 | ✅ 对称（无方向性） |

### ✅ 已实现多空切换的维度

| 维度 | 做多逻辑 | 做空逻辑 | 实现方式 |
|------|---------|---------|----------|
| **A（加速）** | 斜率↑ + CVD↑ | 斜率↓ + CVD↓ | `directional_score()` 自动处理方向 |
| **O（持仓）** | OI↑ + (价格↑&OI↑) | OI↓ + (价格↓&OI↑) | `if side_long` 明确区分 |
| **F（资金领先）** | 资金↑价格→ | 资金↓价格→ | `if side_long` 明确区分 |

### ❌ T（趋势）维度的问题

**当前实现**：
```python
# trend.py line 135-138
if slope_per_bar >= slope_atr_min_long:
    T += 25; dir_flag = 1
elif slope_per_bar <= -slope_atr_min_long:
    T -= 25; dir_flag = -1
```

**问题**：
1. ❌ 使用硬阈值（阶梯式加分）
2. ❌ 做空时没有对称处理：`slope < 0` 时 `T -= 25` → T会变成25分
3. ❌ 返回值是 `(T, Tm)`，但调用方没有根据 `side_long` 调整

**正确逻辑应该是**：
- 做多信号：slope↑ → T↑（0-100分）
- 做空信号：slope↓ → T↑（0-100分）← 注意：分数都是0-100，方向由side决定

---

## 问题2：七维重组方案

### 当前七维的重叠矩阵

|  | T | A | S | V | O | E | F |
|--|---|---|---|---|---|---|---|
| **价格趋势** | ✅ | ✅ |  |  |  |  | ✅ |
| **价格结构** |  |  | ✅ |  |  |  |  |
| **价格斜率** | ✅ | ✅ |  |  |  |  | ✅ |
| **成交量** |  |  |  | ✅ |  |  | ✅ |
| **CVD** |  | ✅ |  |  |  |  | ✅ |
| **OI** |  |  |  |  | ✅ |  | ✅ |
| **波动性** |  |  |  |  |  | ✅ |  |

**重叠严重的指标**：
- **价格趋势/斜率**：T、A、F 都在用（3次）
- **CVD**：A、F 都在用（2次）
- **Volume**：V、F 都在用（2次）
- **OI**：O、F 都在用（2次）

---

### 🔥 方案1：因果分离模型（推荐）

**核心思想**：区分"原因"和"结果"，F作为唯一的因果关联维度

#### 价格维度（结果，3个）
1. **T（Trend 趋势）**：价格趋势的方向和强度
   - 指标：EMA排列 + 价格斜率/ATR + R²置信度
   - 改进：**改用软映射**，区分多空方向
   - 输出：0-100分（做多时上涨好，做空时下跌好）

2. **S（Structure 结构）**：价格结构的质量
   - 指标：ZigZag一致性、ICR、回撤深度、时序
   - 改进：改用软映射
   - 输出：0-100分（结构清晰=高分）

3. **M（Momentum 动量）**：价格的动量/加速度
   - 指标：价格加速度（30小时斜率变化）
   - **去掉CVD**（移到资金维度）
   - 改进：使用软映射
   - 输出：0-100分（加速强=高分）

#### 资金维度（原因，3个）
4. **V（Volume 量能）**：成交量
   - 指标：v5/v20 + 量能变化率
   - 保持软映射
   - 输出：0-100分（放量=高分）

5. **O（Open Interest 持仓）**：持仓量变化
   - 指标：OI 24h变化 + 价格-OI对齐度
   - 保持软映射
   - 改进：多空对称检查
   - 输出：0-100分（持仓增长=高分）

6. **C（CVD 资金流）**：买卖压力
   - 指标：CVD 6小时变化
   - **从A中分离出来**
   - 使用软映射
   - 输出：0-100分（买压强=高分，做空时卖压强=高分）

#### 环境维度（1个）
7. **E（Environment 环境）**：市场环境
   - 指标：Chop指数 + Room空间
   - 改进：改用软映射
   - 输出：0-100分（趋势性强=高分）

#### 元维度（1个）
8. **F（Fund Leading 资金领先）**：因果关系
   - 公式：`fund_momentum(V+O+C) - price_momentum(T+M)`
   - 保持软映射
   - **这是唯一允许重叠的维度**，因为它提供因果视角
   - 输出：0-100分（资金领先价格=高分）

**总结**：8个维度（7+1元维度）
- **价格类（3）**：T、S、M
- **资金类（3）**：V、O、C
- **环境类（1）**：E
- **元类（1）**：F（允许重叠）

**优点**：
✅ 逻辑清晰：因（资金）vs 果（价格）
✅ 减少重叠：CVD单独成维度
✅ 保留F的价值：因果关系分析
✅ 全部软映射：无硬阈值

**缺点**：
❌ 从7维变成8维
❌ 需要调整权重配置

---

### 🔧 方案2：精简五维模型

**核心思想**：合并相似维度，去掉元维度F

1. **P（Price 价格）**：T + S + M 合并
   - 指标：趋势 + 结构 + 动量
   - 权重：40%

2. **V（Volume 资金流）**：V + O + CVD 合并
   - 指标：成交量 + OI + CVD
   - 权重：40%

3. **E（Environment 环境）**：保持
   - 指标：波动性 + 空间
   - 权重：10%

4. **Q（Quality 质量）**：信号质量
   - 指标：R²置信度、结构清晰度、时序质量
   - 权重：10%

5. **L（Leading 领先性）**：V领先P的程度
   - 指标：资金动量 - 价格动量
   - 权重：bonus维度，用于最终筛选

**优点**：
✅ 简洁：只有5个维度
✅ 无重叠：每个维度职责清晰
✅ 全部软映射

**缺点**：
❌ 信息粒度降低
❌ 不利于调试（单个维度包含太多信息）

---

### 💡 方案3：保持七维但优化（最小改动）

**核心思想**：保持当前结构，只修复问题

1. **T（趋势）**：改用软映射 + 多空对称 ✅
2. **A（加速）**：去掉CVD，只保留价格加速度 ✅
3. **S（结构）**：改用软映射 ✅
4. **V（量能）**：保持 ✅
5. **O（持仓）**：保持 ✅
6. **C（CVD）**：**新增维度**，从A中分离 ✅
7. **E（环境）**：改用软映射 ✅
8. **F（资金领先）**：保持，允许重叠 ✅

等等，这还是8维...

**改进版**：去掉F，合并到发布逻辑
1. **T（趋势）**：改用软映射 + 多空对称
2. **A（加速）**：去掉CVD，只保留价格加速度
3. **S（结构）**：改用软映射
4. **V（量能）**：保持
5. **O（持仓）**：保持
6. **C（CVD）**：新增维度
7. **E（环境）**：改用软映射

**发布逻辑增加F检查**：
```python
# 计算 F（不作为评分维度，只作为筛选条件）
F = calc_fund_leading(...)
if F < 30:  # 价格领先资金，追高风险
    # 降低概率或标记为 WATCH
    P = P * 0.8
```

**优点**：
✅ 保持7维
✅ 减少重叠
✅ F作为筛选器而非评分维度

**缺点**：
❌ F的信息不在Telegram消息中显示

---

## 问题3：多空对称性修复

### 需要修复的问题

#### 1. T（趋势）维度
**当前问题**：
```python
if slope >= threshold:
    T += 25  # 多头好
elif slope <= -threshold:
    T -= 25  # 空头时T会变成25分
```

**修复方案**：
```python
def score_trend(..., side_long: bool):
    # 使用软映射
    slope_normalized = slope_per_bar / slope_scale

    if side_long:
        # 做多：斜率越大越好
        slope_score = directional_score(slope_normalized, neutral=0.0, scale=1.0)
    else:
        # 做空：斜率越小（负值越大）越好
        slope_score = directional_score(-slope_normalized, neutral=0.0, scale=1.0)

    # EMA排列也要区分方向
    if side_long:
        ema_bonus = 15 if ema_up else 0
    else:
        ema_bonus = 15 if ema_dn else 0

    T = 50 + slope_score * 0.5 + ema_bonus
    return T, Tm
```

#### 2. 验证其他维度
需要验证：
- ✅ A（加速）：已对称
- ✅ S（结构）：无方向性，对称
- ✅ V（量能）：无方向性，对称
- ✅ O（持仓）：已对称
- ✅ E（环境）：无方向性，对称
- ✅ F（资金领先）：已对称

---

## 推荐方案

### 🎯 推荐：方案1（因果分离模型）

**理由**：
1. ✅ **逻辑最清晰**：因（资金）vs 果（价格）vs 环境
2. ✅ **CVD独立**：解决重叠问题
3. ✅ **保留F**：因果关系是重要视角
4. ✅ **便于理解**：用户在Telegram中能看到完整信息

**实施步骤**：
1. 修复T维度：改软映射 + 多空对称
2. 拆分A维度：A只保留价格加速度，CVD独立成C
3. 优化S、E：改用软映射
4. 调整权重：
   ```json
   {
     "T": 15,  // 趋势
     "S": 10,  // 结构
     "M": 10,  // 动量（原A）
     "V": 15,  // 量能
     "O": 12,  // 持仓
     "C": 8,   // CVD（新）
     "E": 10,  // 环境
     "F": 20   // 资金领先（提高权重，因为它是关键）
   }
   ```

### 🔄 备选：方案3（最小改动）

如果不想增加维度，可以选方案3：
- 保持7维
- 把F从评分维度改为筛选条件
- 修复T、S、E的软映射
- CVD从A分离独立

---

## 用户决策

请选择：
1. **方案1（8维因果分离）**：逻辑最清晰，CVD独立，保留F显示
2. **方案2（5维精简）**：最简洁，但信息粒度降低
3. **方案3（7维优化）**：最小改动，F作为筛选器

以及：
- 是否同意修复 T 维度的多空对称性？
- 是否全部改为软映射（无硬阈值）？

**关键权衡**：
- 方案1：信息最完整，但8维可能复杂
- 方案2：最简洁，但调试困难
- 方案3：折中方案，但F信息不可见

您倾向哪个方案？
