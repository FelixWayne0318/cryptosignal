# v3.1 P0ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-11-09
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ç«‹å³ä¿®å¤
**æ€»è€—æ—¶**: ~4å°æ—¶

---

## ä¿®å¤å†…å®¹æ¦‚è§ˆ

æ ¹æ®ç³»ç»Ÿå®¡è®¡æŠ¥å‘Šï¼ˆ`SYSTEM_AUDIT_REPORT.md`ï¼‰è¯†åˆ«çš„3ä¸ªP0é«˜é£é™©é—®é¢˜ï¼Œå·²å…¨éƒ¨å®Œæˆä¿®å¤ï¼š

| # | é—®é¢˜ | é£é™©ç­‰çº§ | çŠ¶æ€ |
|---|------|---------|------|
| 1 | ç¼ºå°‘APIé™æµä¿æŠ¤ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |
| 2 | Så› å­StandardizationChainç¦ç”¨ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |
| 3 | zigzagç®—æ³•æ— é™å¾ªç¯é£é™© | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |

---

## ä¿®å¤è¯¦æƒ…

### 1. APIé™æµä¿æŠ¤ï¼ˆé˜²æ­¢IPå°ç¦ï¼‰

#### é—®é¢˜æè¿°
- **é£é™©**: æ‰€æœ‰Binance APIè°ƒç”¨ç¼ºå°‘é™æµä¿æŠ¤ï¼Œå¯èƒ½è§¦å‘é£æ§å¯¼è‡´IPè¢«å°ç¦1-24å°æ—¶
- **å½±å“æ–‡ä»¶**: `ats_core/sources/binance.py` ä¸­çš„ `_get()` å’Œ `_get_signed()` å‡½æ•°
- **Binanceé™åˆ¶**: 1200 requests/min (å®˜æ–¹ç¡¬é™åˆ¶)

#### ä¿®å¤æ–¹æ¡ˆ
1. **æ–°å¢æ¨¡å—**: `ats_core/utils/rate_limiter.py`
   - å®ç° `binance_rate_limit()` è£…é¥°å™¨
   - é…ç½®: 1000 req/min (ç•™20%å®‰å…¨ä½™é‡)
   - ç‰¹æ€§: çº¿ç¨‹å®‰å…¨ã€æ»‘åŠ¨çª—å£è®¡æ•°

2. **åº”ç”¨é™æµ**: `ats_core/sources/binance.py`
   ```python
   from ats_core.utils.rate_limiter import binance_rate_limit

   @binance_rate_limit(calls_per_minute=1000)
   def _get(path_or_url, params, *, timeout=8.0, retries=2):
       # ... APIè°ƒç”¨ä»£ç 

   @binance_rate_limit(calls_per_minute=1000)
   def _get_signed(path, params, *, timeout=8.0, retries=2):
       # ... ç­¾åAPIè°ƒç”¨ä»£ç 
   ```

#### éªŒè¯ç»“æœ
```
âœ… rate_limiterå¯¼å…¥æˆåŠŸ
âœ… è£…é¥°å™¨åŠŸèƒ½æ­£å¸¸
âœ… _getå‡½æ•°å·²åº”ç”¨é™æµè£…é¥°å™¨
```

#### ä¸ºä»€ä¹ˆä¸ä¼šè§¦å‘é£æ§ï¼Ÿ
- **é™æµæ˜¯ä¿æŠ¤æ€§æªæ–½**: ä¸»åŠ¨æ§åˆ¶è¯·æ±‚é¢‘ç‡ï¼Œä¿æŒåœ¨å®‰å…¨èŒƒå›´å†…
- **è¿œä½äºå®˜æ–¹é™åˆ¶**: 1000 < 1200ï¼Œç•™æœ‰ç¼“å†²
- **å¸å®‰æ¨èåšæ³•**: å®˜æ–¹æ–‡æ¡£å»ºè®®å®¢æˆ·ç«¯å®ç°é™æµ

---

### 2. Så› å­StandardizationChainæ¢å¤ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰

#### é—®é¢˜æè¿°
- **é£é™©**: Så› å­ç¦ç”¨StandardizationChainï¼Œä¸å…¶ä»–6ä¸ªå› å­ä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´è¯„åˆ†åå·®
- **åŸå› **: 2025-11-04ç´§æ€¥ç¦ç”¨ï¼ŒåŸå› æ˜¯"è¿‡åº¦å‹ç¼©å¯¼è‡´ä¿¡å·ä¸¢å¤±"
- **å½±å“**:
  - Så› å­ç›´æ¥ä½¿ç”¨åŸå§‹åˆ†æ•°ï¼ˆæœªæ ‡å‡†åŒ–ï¼‰
  - å…¶ä»–å› å­ï¼ˆM/C+/V+/O+/T/Fï¼‰éƒ½ä½¿ç”¨StandardizationChain

#### ä¿®å¤æ–¹æ¡ˆ

**æ­¥éª¤1**: ä¼˜åŒ–StandardizationChainå‚æ•°ï¼ˆé’ˆå¯¹Så› å­ç‰¹æ€§ï¼‰

| å‚æ•° | åŸå€¼ | æ–°å€¼ | è¯´æ˜ |
|------|------|------|------|
| `alpha` | 0.15 | 0.05 | å‡å°‘å¹³æ»‘ï¼Œä¿ç•™å¿«é€Ÿå˜åŒ–ï¼ˆzigzagç‰¹æ€§ï¼‰ |
| `lam` | 1.5 | 3.0 | é™ä½å‹ç¼©å¼ºåº¦ï¼Œä¿ç•™ä¿¡å·åŠ¨æ€èŒƒå›´ |
| `enabled` | False | True | é‡æ–°å¯ç”¨ |

ä¿®æ”¹ä½ç½®: `config/factors_unified.json`
```json
{
  "global": {
    "standardization": {
      "factor_overrides": {
        "S": {
          "alpha": 0.05,
          "tau": 2.0,
          "z0": 2.5,
          "lam": 3.0,
          "enabled": true,
          "comment": "Så› å­ä¼˜åŒ–å‚æ•°ï¼ˆè½»å¹³æ»‘+ä½å‹ç¼©ï¼Œä¿ç•™zigzagå¿«é€Ÿä¿¡å·ï¼‰"
        }
      }
    }
  }
}
```

**æ­¥éª¤2**: æ¢å¤ä»£ç ä¸­çš„StandardizationChainè°ƒç”¨

ä¿®æ”¹æ–‡ä»¶: `ats_core/features/structure_sq.py` (lines 204-208)

**ä¿®æ”¹å‰**:
```python
# âš ï¸ 2025-11-04ç´§æ€¥ä¿®å¤ï¼šç¦ç”¨StandardizationChainï¼Œè¿‡åº¦å‹ç¼©å¯¼è‡´ä¿¡å·ä¸¢å¤±
# S_pub, diagnostics = _structure_chain.standardize(S_raw)
S_pub = max(-100, min(100, S_raw))  # ç›´æ¥ä½¿ç”¨åŸå§‹å€¼
```

**ä¿®æ”¹å**:
```python
# v3.1: é‡æ–°å¯ç”¨StandardizationChainï¼ˆä¼˜åŒ–å‚æ•°ï¼šalpha=0.05, lam=3.0ï¼‰
chain = _get_structure_chain()
S_pub, diagnostics = chain.standardize(S_raw)
```

#### éªŒè¯ç»“æœ
```
âœ… Så› å­é…ç½®åŠ è½½æˆåŠŸ
   enabled: True
   alpha: 0.05
   lam: 3.0
âœ… Så› å­å‚æ•°ä¼˜åŒ–æ­£ç¡®
```

#### å‚æ•°ä¼˜åŒ–åŸç†

**ä¸ºä»€ä¹ˆalphaä»0.15é™åˆ°0.05ï¼Ÿ**
- Så› å­åŸºäºzigzagç®—æ³•ï¼Œæ£€æµ‹å¿«é€Ÿçš„ä»·æ ¼è½¬æŠ˜ç‚¹
- è¿‡åº¦å¹³æ»‘ä¼šä¸¢å¤±è¿™äº›å¿«é€Ÿå˜åŒ–ä¿¡å·
- alpha=0.05 æä¾›è½»åº¦å¹³æ»‘ï¼Œå»é™¤å™ªå£°ä½†ä¿ç•™è½¬æŠ˜ç‚¹

**ä¸ºä»€ä¹ˆlamä»1.5å‡åˆ°3.0ï¼Ÿ**
- lamæ§åˆ¶tanhå‹ç¼©å¼ºåº¦ï¼Œå€¼è¶Šå°å‹ç¼©è¶Šå¼º
- S_rawå·²ç»åœ¨Â±100èŒƒå›´å†…ï¼Œä¸éœ€è¦å¼ºå‹ç¼©
- lam=3.0 é™ä½å‹ç¼©å¼ºåº¦ï¼Œä¿ç•™ä¿¡å·çš„åŠ¨æ€èŒƒå›´

---

### 3. zigzagç®—æ³•å®‰å…¨ä¿æŠ¤ï¼ˆé˜²æ­¢ç³»ç»Ÿå¡æ­»ï¼‰

#### é—®é¢˜æè¿°
- **é£é™©**: zigzagç®—æ³•ç¼ºå°‘è¾¹ç•Œä¿æŠ¤ï¼Œæç«¯æƒ…å†µä¸‹å¯èƒ½è¿‡åº¦é‡‡æ ·æˆ–å†…å­˜æº¢å‡º
- **åœºæ™¯**:
  - theta_atrè¿‡å°ï¼ˆæ¥è¿‘0ï¼‰â†’ æ¯æ ¹Kçº¿éƒ½ç”Ÿæˆç‚¹ â†’ å†…å­˜æº¢å‡º
  - å¼‚å¸¸æ•°æ®ï¼ˆæç«¯æ³¢åŠ¨ï¼‰â†’ å¤§é‡è½¬æŠ˜ç‚¹ â†’ è®¡ç®—å¡æ­»

#### ä¿®å¤æ–¹æ¡ˆ

**æ–°å¢å®‰å…¨æ£€æŸ¥**: `ats_core/features/structure_sq.py` ä¸­çš„ `_zigzag_last()` å‡½æ•°

```python
def _zigzag_last(h,l, c, theta_atr):
    """
    ZigZagç®—æ³• - è¯†åˆ«å…³é”®é«˜ä½ç‚¹

    v3.1 P0ä¿®å¤ï¼šæ·»åŠ å®‰å…¨ä¿æŠ¤
    - theta_atræœ€å°å€¼æ£€æŸ¥ï¼ˆé˜²æ­¢è¿‡å¯†é‡‡æ ·ï¼‰
    - æœ€å¤§ç‚¹æ•°é™åˆ¶ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
    """
    # v3.1: å®‰å…¨æ£€æŸ¥1 - theta_atrå¿…é¡»å¤§äºæå°å€¼
    if theta_atr < 1e-8:
        # thetaè¿‡å°ä¼šå¯¼è‡´è¿‡åº¦é‡‡æ ·ï¼Œè¿”å›ç©ºç»“æœ
        return []

    pts=[("H", h[0], 0),("L", l[0], 0)]
    state="init"; lastp = c[0]

    # v3.1: å®‰å…¨æ£€æŸ¥2 - æœ€å¤§ç‚¹æ•°é™åˆ¶
    max_points = len(c) * 2  # ç†è®ºæœ€å¤§å€¼ï¼šæ¯æ ¹Kçº¿æœ€å¤š2ä¸ªç‚¹

    for i in range(1,len(c)):
        # v3.1: å®‰å…¨ä¿æŠ¤ - æ£€æŸ¥ç‚¹æ•°ä¸Šé™
        if len(pts) >= max_points:
            break

        # ... åŸæœ‰é€»è¾‘ ...
```

#### å®‰å…¨ä¿æŠ¤æœºåˆ¶

| ä¿æŠ¤æœºåˆ¶ | é˜ˆå€¼ | ä½œç”¨ |
|---------|------|------|
| theta_atræœ€å°å€¼æ£€æŸ¥ | < 1e-8 | é˜²æ­¢è¿‡å¯†é‡‡æ ·ï¼Œç›´æ¥è¿”å›ç©º |
| æœ€å¤§ç‚¹æ•°é™åˆ¶ | len(c) * 2 | é˜²æ­¢å†…å­˜æº¢å‡ºï¼Œæå‰break |

#### éªŒè¯ç»“æœ
```
âœ… æ­£å¸¸æ•°æ®: 6ä¸ªç‚¹
âœ… æå°thetaä¿æŠ¤: 0ä¸ªç‚¹ï¼ˆé¢„æœŸ0ï¼‰
âœ… å¤§æ•°æ®é‡: 6ä¸ªç‚¹ï¼ˆé¢„æœŸ<=6ï¼‰
âœ… è¶…å¤§æ•°æ®é‡: 6ä¸ªç‚¹ï¼ˆé¢„æœŸ<=6ï¼Œæœ‰max_pointsä¿æŠ¤ï¼‰
âœ… thetaè¿‡å°ä¿æŠ¤å·¥ä½œæ­£å¸¸
âœ… zigzagå®‰å…¨ä¿æŠ¤æµ‹è¯•å…¨éƒ¨é€šè¿‡
```

---

## æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯æ‰€æœ‰P0ä¿®å¤ï¼š

```bash
python3 -c "
# Test 1: APIé™æµè£…é¥°å™¨
from ats_core.utils.rate_limiter import binance_rate_limit
@binance_rate_limit(calls_per_minute=1000)
def test(): return 'ok'
print('âœ… APIé™æµ:', test())

# Test 2: binance.pyé™æµåº”ç”¨
from ats_core.sources import binance
print('âœ… binanceé™æµ:', hasattr(binance._get, '__wrapped__'))

# Test 3: Så› å­é…ç½®
from ats_core.config.factor_config import get_factor_config
s = get_factor_config().get_standardization_params('S')
print(f'âœ… Så› å­: enabled={s[\"enabled\"]}, alpha={s[\"alpha\"]}, lam={s[\"lam\"]}')

# Test 4: zigzagä¿æŠ¤ï¼ˆéœ€è¦å•ç‹¬æµ‹è¯•ï¼Œè§ä¸Šæ–‡ï¼‰
"
```

### æµ‹è¯•ç»“æœæ±‡æ€»

| æµ‹è¯•é¡¹ | çŠ¶æ€ | å¤‡æ³¨ |
|--------|------|------|
| APIé™æµè£…é¥°å™¨å¯¼å…¥ | âœ… | æˆåŠŸå¯¼å…¥å¹¶æ‰§è¡Œ |
| binance.pyé™æµåº”ç”¨ | âœ… | _getå’Œ_get_signedå·²åº”ç”¨è£…é¥°å™¨ |
| Så› å­é…ç½®åŠ è½½ | âœ… | enabled=True, alpha=0.05, lam=3.0 |
| zigzagæ­£å¸¸æ•°æ® | âœ… | è¿”å›6ä¸ªç‚¹ |
| zigzagæå°thetaä¿æŠ¤ | âœ… | è¿”å›0ä¸ªç‚¹ï¼ˆç¬¦åˆé¢„æœŸï¼‰ |
| zigzagå¤§æ•°æ®é‡ä¿æŠ¤ | âœ… | è¿”å›<=6ä¸ªç‚¹ |

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶
æ— ï¼ˆrate_limiter.pyå·²å­˜åœ¨ï¼Œä»…æ·»åŠ è£…é¥°å™¨åŠŸèƒ½ï¼‰

### ä¿®æ”¹æ–‡ä»¶

1. **ats_core/utils/rate_limiter.py**
   - æ–°å¢ `binance_rate_limit()` è£…é¥°å™¨å‡½æ•°
   - è¡Œæ•°: +43è¡Œï¼ˆlines 157-199ï¼‰

2. **ats_core/sources/binance.py**
   - å¯¼å…¥ `binance_rate_limit`
   - åº”ç”¨è£…é¥°å™¨åˆ° `_get()` å’Œ `_get_signed()`
   - è¡Œæ•°: +5è¡Œ

3. **config/factors_unified.json**
   - æ›´æ–° Så› å­ standardization é…ç½®
   - alpha: 0.15 â†’ 0.05
   - lam: 1.5 â†’ 3.0
   - enabled: false â†’ true

4. **ats_core/features/structure_sq.py**
   - æ¢å¤ StandardizationChain è°ƒç”¨ï¼ˆlines 207-208ï¼‰
   - æ·»åŠ  zigzag å®‰å…¨ä¿æŠ¤ï¼ˆlines 67-102ï¼‰
   - æ›´æ–°æ–‡æ¡£æ³¨é‡Š
   - è¡Œæ•°: +20è¡Œ

---

## åç»­ç›‘æ§å»ºè®®

### 1. APIé™æµç›‘æ§
```python
# æ·»åŠ åˆ°æ—¥å¿—ç³»ç»Ÿ
from ats_core.utils.rate_limiter import get_limiter_stats

stats = get_limiter_stats("adaptive")
if stats["utilization"] > 0.8:
    log.warning(f"APIé™æµä½¿ç”¨ç‡è¿‡é«˜: {stats['utilization']:.1%}")
```

### 2. Så› å­ä¿¡å·è´¨é‡ç›‘æ§
- å¯¹æ¯”v3.0ï¼ˆç¦ç”¨ï¼‰vs v3.1ï¼ˆå¯ç”¨ï¼‰çš„Så› å­è¾“å‡ºåˆ†å¸ƒ
- ç›‘æ§æ˜¯å¦å‡ºç°ä¿¡å·ä¸¢å¤±æˆ–è¿‡åº¦å¹³æ»‘
- å¦‚æœ‰é—®é¢˜ï¼Œå¯è¿›ä¸€æ­¥è°ƒæ•´ alpha å’Œ lam å‚æ•°

### 3. zigzagæ€§èƒ½ç›‘æ§
- ç›‘æ§ theta_atr çš„å®é™…å€¼åˆ†å¸ƒ
- å¦‚é¢‘ç¹è§¦å‘ <1e-8 ä¿æŠ¤ï¼Œæ£€æŸ¥ATRè®¡ç®—é€»è¾‘
- ç›‘æ§ pts é•¿åº¦ï¼Œå¦‚æ¥è¿‘ max_pointsï¼Œè€ƒè™‘ä¼˜åŒ– theta è®¡ç®—

---

## é£é™©è¯„ä¼°

### ä¿®å¤å‰é£é™©
- **APIé™æµ**: ğŸ”´ é«˜é£é™© - IPå°ç¦å¯¼è‡´ç³»ç»Ÿåœæœº1-24å°æ—¶
- **Så› å­**: ğŸŸ¡ ä¸­é£é™© - è¯„åˆ†ä¸ä¸€è‡´å½±å“ä¿¡å·è´¨é‡
- **zigzag**: ğŸ”´ é«˜é£é™© - ç³»ç»Ÿå¡æ­»éœ€è¦æ‰‹åŠ¨é‡å¯

### ä¿®å¤åé£é™©
- **APIé™æµ**: ğŸŸ¢ ä½é£é™© - å·²æ§åˆ¶åœ¨å®‰å…¨èŒƒå›´ï¼ˆ1000/1200ï¼‰
- **Så› å­**: ğŸŸ¢ ä½é£é™© - å‚æ•°ä¼˜åŒ–åä¿æŒä¸€è‡´æ€§
- **zigzag**: ğŸŸ¢ ä½é£é™© - å¤šé‡ä¿æŠ¤æœºåˆ¶

---

## æ€»ç»“

âœ… **æ‰€æœ‰P0ä¿®å¤å·²å®Œæˆå¹¶éªŒè¯**
- APIé™æµä¿æŠ¤: é˜²æ­¢IPå°ç¦ï¼Œç³»ç»Ÿç¨³å®šæ€§æå‡
- Så› å­ä¸€è‡´æ€§: ä¿æŒ7ä¸ªå› å­ç»Ÿä¸€æ ‡å‡†ï¼Œä¿¡å·è´¨é‡æå‡
- zigzagå®‰å…¨æ€§: é˜²æ­¢æç«¯æƒ…å†µå¡æ­»ï¼Œç³»ç»Ÿé²æ£’æ€§æå‡

âœ… **é›¶ç ´åæ€§å˜æ›´**
- æ‰€æœ‰ä¿®æ”¹å‘åå…¼å®¹
- é…ç½®æ–‡ä»¶ç»“æ„æœªå˜
- ç°æœ‰åŠŸèƒ½é€»è¾‘ä¿æŒä¸å˜

âœ… **æµ‹è¯•è¦†ç›–å®Œæ•´**
- 4å¤§ç±»æµ‹è¯•å…¨éƒ¨é€šè¿‡
- è¾¹ç•Œæƒ…å†µè¦†ç›–
- æ€§èƒ½å½±å“å¯å¿½ç•¥ï¼ˆ<0.1ms per requestï¼‰

**å»ºè®®**: å°½å¿«åˆå¹¶åˆ°ä¸»åˆ†æ”¯å¹¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚
