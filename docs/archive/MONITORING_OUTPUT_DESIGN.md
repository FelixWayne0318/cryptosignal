# 实时监控输出设计方案

> **分析日期**: 2025-10-31
> **需求**: 显示所有因子、调节器、Prime值、权重，方便实时监控

---

## 一、当前输出的不足

### 当前Telegram消息格式

```
🔥 BTCUSDT @ 42,530.50 USDT
📊 Trade | LONG | 置信度 72% | TTL 8h

━━━━━ 10维因子分析 ━━━━━
🟢T趋势 +80/100: 强势上行
🟡M动量 +52/100: 温和上涨
🟢C资金流 +75/100: 强劲流入
...
```

### 缺少的信息

1. ❌ 没有显示各因子的**权重**
2. ❌ 没有显示**F和I调节器**的值和影响
3. ❌ 没有显示**Prime评分**详情
4. ❌ 没有显示**四门系统**通过情况
5. ❌ 没有显示**EV（期望值）**
6. ❌ 没有显示**概率基础值**和**调整后概率**
7. ❌ 没有显示**市场过滤器**的影响

---

## 二、设计目标

### 1. 分层展示

```
层次1：核心信息（保持现有）
  - 币种、价格、方向、置信度

层次2：因子详情（增强）
  - 每个因子：分数 + 权重 + 贡献度

层次3：调制器详情（新增）
  - F调制器：分数、调整系数
  - I调制器：分数、阈值调整

层次4：Prime评分详情（新增）
  - Prime strength：总分 + 分解
  - 四门系统：每门的通过情况

层次5：概率详情（新增）
  - 基础概率 → 调整后概率
  - 调整原因（F/I/市场过滤）
```

### 2. 显示模式

**模式1：简洁模式（默认）**
- 适用于：Telegram推送
- 内容：核心信息 + 因子摘要

**模式2：详细模式（调试）**
- 适用于：本地日志、调试
- 内容：全部信息

**模式3：监控模式（新增）**
- 适用于：实时监控、仪表盘
- 内容：因子+权重+贡献+Prime+四门

---

## 三、完整输出格式设计

### 模式1：简洁模式（Telegram）

```
━━━━━━━━━━━━━━━━━━━━━━━
🔥 BTCUSDT @ 42,530.50 USDT
━━━━━━━━━━━━━━━━━━━━━━━

📊 Signal: LONG | 置信度 72% | TTL 8h
🎯 Prime: 85/100 | EV: +2.3% | 概率: 68%

━━━━━ A层：方向因子 ━━━━━
🟢 T趋势 +80 (18.0%) → +14.4  强势上行
🟡 M动量 +52 (12.0%) → +6.2   温和上涨
🟢 C资金流 +75 (18.0%) → +13.5  强劲流入
🟡 S结构 +45 (10.0%) → +4.5   结构尚可
🟢 V量能 +60 (10.0%) → +6.0   放量明显
🟢 O持仓 +70 (18.0%) → +12.6  多头建仓
🟡 L流动性 +35 (8.0%) → +2.8   流动性良好
🟢 B基差 +55 (2.0%) → +1.1   正溢价
🟡 Q清算 +40 (4.0%) → +1.6   空单压力
━━━━━━━━━━━━━━━━━━━━━━━
加权总分: +62.7 → 四舍五入 +63

━━━━━ B层：调制器 ━━━━━
F资金领先 +45: 资金略微领先价格 (调整×1.0)
I独立性 +25: 跟随大盘 (p_min: 0.62→0.62)

━━━━━ C层：执行指标 ━━━━━
Spread: 5.2 bps | Impact: 3.8 bps | OBI: 0.52

━━━━━ D层：四门验证 ━━━━━
✅ Gate1: DataQual 0.95 >= 0.90
✅ Gate2: EV +2.3% > 0
✅ Gate3: Spread/Impact ✓
✅ Gate4: P=68% >= 62% ✓

━━━━━ 价格建议 ━━━━━
入场区间: 42,350 - 42,710
止损: 41,200 (-3.1%)
目标1: 43,800 (+3.0%)
目标2: 44,900 (+5.6%)

#trade #BTCUSDT
```

---

### 模式2：详细模式（日志）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 完整分析报告：BTCUSDT @ 42,530.50 USDT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

═══════════════════════════════════════════
一、基础信息
═══════════════════════════════════════════
币种: BTCUSDT
价格: 42,530.50 USDT
EMA30: 41,850.20
ATR: 1,240.50
币龄: 成熟币（>30天）

═══════════════════════════════════════════
二、A层 - 方向评分层（9因子，权重100%）
═══════════════════════════════════════════

【价格行为维度 36.1%】
────────────────────────────────────
T 趋势 (18.0%):
  原始分数: +80/100
  贡献度: +80 × 18.0% = +14.4
  元数据:
    - Tm方向: +1 (多头)
    - 斜率/ATR: 0.065
    - EMA排列: 5>20 (持续6根)
    - R²拟合度: 0.88
  解释: 🟢 强势上行 [多头]

M 动量 (12.0%):
  原始分数: +52/100
  贡献度: +52 × 12.0% = +6.2
  元数据:
    - 斜率: 0.042 ATR/bar
    - 加速度: 0.018 ATR/bar²
    - EMA30斜率: +0.035
  解释: 🟡 温和上涨

S 结构 (10.0%):
  原始分数: +45/100
  贡献度: +45 × 10.0% = +4.5
  元数据:
    - Theta角度: 0.38
    - ICR(冲量比): 0.62
    - Retracement: 0.42
  解释: 🟡 结构尚可/回踩确认

V 量能 (10.0%):
  原始分数: +60/100
  贡献度: +60 × 10.0% = +6.0
  元数据:
    - v5/v20: 1.42
    - vROC: 0.18
    - 解释: 🟢 放量明显/跟随积极

【资金流维度 36.0%】
────────────────────────────────────
C CVD资金流 (18.0%):
  原始分数: +75/100
  贡献度: +75 × 18.0% = +13.5
  元数据:
    - CVD 6h变化: +0.038
    - 斜率: +0.0065/h
    - R²: 0.82 (持续性强)
    - 拥挤度警告: 否
  解释: 🟢 强劲流入

O 持仓量 (18.0%):
  原始分数: +70/100
  贡献度: +70 × 18.0% = +12.6
  元数据:
    - OI 1h: +2.3%
    - OI 24h: +8.5%
    - up_up次数: 9/12 (价格涨+OI涨)
    - dn_up次数: 2/12
    - 拥挤度警告: 否
    - R²: 0.78
  解释: 🟢 多头持仓增加

【微观结构维度 14.0%】
────────────────────────────────────
L 流动性 (8.0%):
  原始分数: +35/100 (raw: 67.5/100)
  贡献度: +35 × 8.0% = +2.8
  元数据:
    - 订单簿深度: 良好
    - Bid/Ask不平衡: 0.52
    - 滑点估算: 3.8 bps
  解释: 🟡 流动性良好

B 基差+资金费 (2.0%):
  原始分数: +55/100
  贡献度: +55 × 2.0% = +1.1
  元数据:
    - 基差: +12.5 bps
    - 资金费率: +0.012%
    - 正溢价: 看涨情绪
  解释: 🟢 正溢价

Q 清算密度 (4.0%):
  原始分数: +40/100
  贡献度: +40 × 4.0% = +1.6
  元数据:
    - 多单清算: 低
    - 空单清算: 中等
    - 清算压力: 空头
  解释: 🟡 空单清算压力

────────────────────────────────────
加权总分计算:
  Sum = +14.4 +6.2 +13.5 +4.5 +6.0 +12.6 +2.8 +1.1 +1.6
      = +62.7
  四舍五入 = +63/100
  置信度 = |+63| = 63%
  优势度 = +63/100 = 0.63
────────────────────────────────────

═══════════════════════════════════════════
三、B层 - 调制器层（F/I，不参与评分）
═══════════════════════════════════════════

F 资金领先性调制器:
  原始分数: +45/100
  F_aligned: +45 (与交易方向一致)

  调制作用:
    1. 概率调整:
       - F >= -70: 不调整 (adjustment = 1.0)
       - 最终调整系数: ×1.0

    2. Teff调整: (未显示，内部使用)

    3. cost_eff调整: (未显示，内部使用)

  元数据:
    - OI变化24h: +8.5%
    - 价格变化24h: +5.2%
    - 量能比率: 1.42
    - CVD 6h: +0.038

  解释: 资金略微领先价格（正常范围）

I 独立性调制器:
  原始分数: +25/100 (raw: 62.5/100)

  调制作用:
    1. 概率阈值调整:
       - p_min基础: 0.62
       - I调整: 0（跟随大盘，无奖励）
       - p_min最终: 0.62

    2. Δp_min调整:
       - 基础: 0.05
       - I调整: 0
       - 最终: 0.05

  元数据:
    - BTC相关性: 0.72
    - ETH相关性: 0.68
    - Beta总和: 1.40
    - 数据点: 48h

  解释: 跟随大盘走势（无独立性加成）

═══════════════════════════════════════════
四、概率映射
═══════════════════════════════════════════

基础概率计算:
  Edge: 0.63
  Prior: 0.50 (中性)
  Quality: 0.95
  Temperature: 0.20 (自适应)

  Sigmoid映射:
    P_long_base = sigmoid((0.63 + 0.50 - 0.50) / 0.20)
                = sigmoid(3.15)
                = 0.9589
    P_short_base = 1 - 0.9589 = 0.0411

调整过程:
  1. F调制器调整:
     F_aligned = +45 >= -70
     → adjustment_F = 1.0 (不调整)

  2. 市场过滤器调整:
     市场趋势: +35 (偏多)
     交易方向: LONG
     → adjustment_market = 1.0 (顺势，不调整)

  3. 综合调整:
     adjustment_final = min(1.0, 1.0) = 1.0

     P_long = min(0.95, 0.9589 × 1.0) = 0.95 (截断)
     P_short = 0.0411

最终概率:
  P_chosen = 0.95 → 95% (做多)

  但系统限制最高95%，实际显示:
    → 实际输出: 95% (截断后)

═══════════════════════════════════════════
五、C层 - 执行指标
═══════════════════════════════════════════

订单簿分析:
  Spread: 5.2 bps (良好)
  Impact (买入100K USDT): 3.8 bps (优秀)
  OBI (Order Book Imbalance): 0.52 (买盘略强)

流动性评估:
  5档深度 (bid): $1,250,000
  5档深度 (ask): $1,180,000
  总深度: $2,430,000 (充足)

Gate 3 判定:
  ✅ Spread 5.2 bps <= 20 bps
  ✅ Impact 3.8 bps <= 10 bps
  ✅ OBI 0.52 ∈ [0.4, 0.6]
  → Gate 3 通过

═══════════════════════════════════════════
六、D层 - 四门验证系统
═══════════════════════════════════════════

Gate 1 - 数据质量门:
  DataQual = 0.95
  阈值: 0.90
  判定: 0.95 >= 0.90 → ✅ 通过

  质量因子:
    - 样本完备性: 1.0 (300根K线)
    - OI数据: 1.0 (200个数据点)
    - 弱证据维度: 0 (无<40分因子)
    → Q = 1.0 × 1.0 × 1.0 = 1.0 → 截断到0.95

Gate 2 - 期望值门:
  EV = P × μ_win - (1-P) × μ_loss - cost_eff

  参数:
    P = 0.95 (做多概率)
    μ_win = 3.0% (平均盈利)
    μ_loss = 3.1% (平均亏损)
    cost_eff = 0.15% (有效成本：手续费+滑点)

  计算:
    EV = 0.95 × 3.0% - 0.05 × 3.1% - 0.15%
       = 2.85% - 0.155% - 0.15%
       = +2.545%

  判定: +2.545% > 0 → ✅ 通过

Gate 3 - 执行指标门:
  (见上文C层分析)
  判定: ✅ 通过

Gate 4 - 概率阈值门:
  P = 95%
  p_min = 0.62 (经F/I调制后)
  ΔP = P - prior = 0.95 - 0.50 = 0.45
  Δp_min = 0.05

  判定:
    ✅ P = 0.95 >= p_min = 0.62
    ✅ ΔP = 0.45 >= Δp_min = 0.05
  → Gate 4 通过

四门系统总判定:
  ✅ Gate 1: 数据质量 ✓
  ✅ Gate 2: 期望值 ✓
  ✅ Gate 3: 执行指标 ✓
  ✅ Gate 4: 概率阈值 ✓
  → **ALL GATES PASSED**

═══════════════════════════════════════════
七、Prime评分系统
═══════════════════════════════════════════

Prime Strength计算:
  公式: base_strength + prob_bonus

  1. 基础强度 (0-60分):
     confidence = |weighted_score| = 63
     base_strength = 63 × 0.6 = 37.8

  2. 概率加成 (0-40分):
     P_chosen = 0.95
     prob_bonus = min(40, (0.95 - 0.60) / 0.15 × 40)
                = min(40, 93.3)
                = 40.0

  3. 总分:
     prime_strength = 37.8 + 40.0 = 77.8 → 四舍五入 = 78

Prime判定:
  prime_strength = 78 >= 35 → ✅ is_prime = True

Prime评分分解:
  - 置信度贡献: 37.8/60 (63%)
  - 概率贡献: 40.0/40 (100%)
  - 综合评分: 78/100 (优秀)

═══════════════════════════════════════════
八、市场环境过滤器
═══════════════════════════════════════════

BTC/ETH大盘分析:
  BTC趋势: +42 (偏多)
  ETH趋势: +28 (偏多)
  市场regime: +35 (偏多环境)

过滤逻辑:
  交易方向: LONG
  市场趋势: +35 (偏多)
  判定: 顺势 → 不惩罚，保持概率

  市场调整: 无 (顺势交易)

═══════════════════════════════════════════
九、价格建议
═══════════════════════════════════════════

入场区间:
  基准价: 42,530.50
  ATR: 1,240.50
  建议区间: 42,350 - 42,710 (±0.4 ATR)

止损设置:
  止损价: 41,200 (-3.1%, -1.07 ATR)
  风险额度: 按1%仓位计算

目标设置:
  目标1: 43,800 (+3.0%, +1.02 ATR) [概率65%]
  目标2: 44,900 (+5.6%, +1.91 ATR) [概率35%]

  建议: 目标1减半仓，目标2全清

═══════════════════════════════════════════
十、总结
═══════════════════════════════════════════

信号质量: ⭐⭐⭐⭐⭐ (5/5星)
  - Prime评分: 78/100 (优秀)
  - 四门验证: 全部通过
  - EV: +2.545% (正期望)
  - 概率: 95% (高置信)

交易建议: 🟢 强烈推荐做多
  - 方向: LONG
  - 置信度: 63%
  - 入场: 42,350 - 42,710
  - 止损: 41,200 (-3.1%)
  - 目标: 43,800 (+3.0%) / 44,900 (+5.6%)

风险提示:
  - 市场处于偏多环境，注意回调风险
  - 建议轻仓试探，目标1减半仓
  - 严格执行止损

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
报告生成时间: 2025-10-31 14:35:22
分析版本: v6.0 newstandards
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 模式3：监控模式（实时监控仪表盘）

```
┌─────────────────────────────────────────────────────┐
│ 📊 实时监控面板 - BTCUSDT                             │
│ 时间: 2025-10-31 14:35:22 | 价格: 42,530.50 USDT   │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ A层：方向因子（权重100%）                           │
├──────┬───────┬────────┬──────────┬──────────────────┤
│ 因子 │ 分数  │ 权重   │ 贡献度   │ 状态             │
├──────┼───────┼────────┼──────────┼──────────────────┤
│ T 趋 │ +80   │ 18.0%  │ +14.4    │ 🟢 强势上行      │
│ M 动 │ +52   │ 12.0%  │ +6.2     │ 🟡 温和上涨      │
│ C 资 │ +75   │ 18.0%  │ +13.5    │ 🟢 强劲流入      │
│ S 结 │ +45   │ 10.0%  │ +4.5     │ 🟡 结构尚可      │
│ V 量 │ +60   │ 10.0%  │ +6.0     │ 🟢 放量明显      │
│ O 持 │ +70   │ 18.0%  │ +12.6    │ 🟢 多头建仓      │
│ L 流 │ +35   │  8.0%  │ +2.8     │ 🟡 流动性良好    │
│ B 基 │ +55   │  2.0%  │ +1.1     │ 🟢 正溢价        │
│ Q 清 │ +40   │  4.0%  │ +1.6     │ 🟡 空单压力      │
├──────┴───────┴────────┴──────────┴──────────────────┤
│ 加权总分: +62.7 → +63 | 置信度: 63% | 优势度: 0.63  │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ B层：调制器（不参与评分）                           │
├──────────┬────────┬────────────────────────────────┤
│ 调制器   │ 分数   │ 影响                           │
├──────────┼────────┼────────────────────────────────┤
│ F 资金   │ +45    │ 概率调整: ×1.0 (不调整)       │
│ I 独立   │ +25    │ p_min: 0.62→0.62 (无加成)     │
└──────────┴────────┴────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ C层：执行指标                                        │
├──────────────┬──────────┬────────────────────────┤
│ Spread       │ 5.2 bps  │ ✅ <= 20 bps           │
│ Impact       │ 3.8 bps  │ ✅ <= 10 bps           │
│ OBI          │ 0.52     │ ✅ ∈ [0.4, 0.6]        │
└──────────────┴──────────┴────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ D层：四门验证                                        │
├──────┬────────────────────────────┬─────────────────┤
│ Gate │ 指标                       │ 状态            │
├──────┼────────────────────────────┼─────────────────┤
│ G1   │ DataQual: 0.95 >= 0.90     │ ✅ PASS         │
│ G2   │ EV: +2.55% > 0             │ ✅ PASS         │
│ G3   │ Execution Metrics          │ ✅ PASS         │
│ G4   │ P: 95% >= 62%, ΔP: 45% >= 5%│ ✅ PASS        │
└──────┴────────────────────────────┴─────────────────┘

┌─────────────────────────────────────────────────────┐
│ Prime评分                                            │
├──────────────────────┬──────────────────────────────┤
│ Prime Strength       │ 78/100 ⭐⭐⭐⭐⭐            │
│ 基础强度 (置信度×0.6)│ 37.8/60                      │
│ 概率加成             │ 40.0/40                      │
│ is_prime             │ ✅ TRUE (>= 35)             │
└──────────────────────┴──────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ 概率映射                                             │
├──────────────────┬──────────────────────────────────┤
│ 基础概率 (P_base)│ 95.89% (sigmoid映射)             │
│ F调整            │ ×1.0 (无调整)                    │
│ 市场过滤         │ ×1.0 (顺势)                      │
│ 最终概率 (P)     │ 95% (截断)                       │
└──────────────────┴──────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ 信号评级: ⭐⭐⭐⭐⭐ (5/5星)                          │
│ 建议: 🟢 强烈推荐做多                               │
│ 入场: 42,350-42,710 | 止损: 41,200 | 目标: 43,800  │
└─────────────────────────────────────────────────────┘
```

---

## 四、实现方案

### 4.1 修改Telegram消息格式

```python
# ats_core/outputs/telegram_fmt.py

def render_signal_detailed(r: Dict[str, Any], is_watch: bool = False) -> str:
    """
    详细模式：显示所有因子、权重、调制器、Prime、四门

    适用于：
    - 本地日志
    - 调试模式
    - 实时监控
    """
    # ... 实现见下文 ...
```

### 4.2 修改日志输出

```python
# scripts/realtime_signal_scanner.py

# 在扫描完成后输出详细信息
for signal in prime_signals:
    if self.detailed_log:
        # 输出完整的因子信息
        log("\n" + "="*60)
        log(f"详细分析：{signal['symbol']}")
        log("="*60)
        log_detailed_factors(signal)
```

---

## 五、配置选项

```python
# config/params.json

{
  "output": {
    "telegram_mode": "simplified",  // simplified | detailed | monitoring
    "console_mode": "detailed",     // simplified | detailed
    "show_weights": true,           // 显示因子权重
    "show_modulators": true,        // 显示F/I调制器
    "show_prime_breakdown": true,   // 显示Prime评分分解
    "show_four_gates": true,        // 显示四门详情
    "show_probability_flow": true   // 显示概率调整流程
  }
}
```

---

## 六、实现代码（核心部分）

```python
# ats_core/outputs/telegram_fmt.py

def format_factor_with_weight(
    factor: str,
    score: int,
    weight: float,
    contribution: float,
    emoji: str,
    description: str
) -> str:
    """
    格式化单个因子信息（包含权重和贡献）

    Returns:
        "🟢 T趋势 +80 (18.0%) → +14.4  强势上行"
    """
    return (
        f"{emoji} {factor} "
        f"{score:+d} "
        f"({weight:.1f}%) → "
        f"{contribution:+.1f}  "
        f"{description}"
    )


def render_factors_with_weights(r: Dict[str, Any]) -> str:
    """
    渲染因子列表（包含权重和贡献）
    """
    scores = r.get('scores', {})
    weights = r.get('optimization_meta', {}).get('final_weights', {})
    contributions = r.get('factor_contributions', {})

    lines = []
    lines.append("━━━━━ A层：方向因子 ━━━━━")

    # 9个因子
    factors = [
        ('T', '趋势', _desc_trend),
        ('M', '动量', _desc_momentum),
        ('C', '资金流', _desc_cvd),
        ('S', '结构', _desc_structure),
        ('V', '量能', _desc_volume),
        ('O', '持仓', _desc_oi),
        ('L', '流动性', _desc_liquidity),
        ('B', '基差', _desc_basis),
        ('Q', '清算', _desc_liquidation),
    ]

    for code, name, desc_func in factors:
        score = _as_int_score(scores.get(code, 0))
        weight = weights.get(code, 0)
        contrib = contributions.get(code, {}).get('contribution', 0)
        emoji = _emoji_by_score(score)
        description = desc_func(score, r.get('scores_meta', {}).get(code, {}))

        line = format_factor_with_weight(
            f"{code}{name}",
            score,
            weight,
            contrib,
            emoji,
            description
        )
        lines.append(line)

    # 加权总分
    weighted_score = r.get('weighted_score', 0)
    lines.append("━" * 40)
    lines.append(f"加权总分: {weighted_score:+d}")

    return "\n".join(lines)


def render_modulators(r: Dict[str, Any]) -> str:
    """
    渲染调制器详情
    """
    F_score = r.get('F_score', 0)
    F_adjustment = r.get('F_adjustment', 1.0)

    I_score = r.get('scores', {}).get('I', 0)
    I_meta = r.get('scores_meta', {}).get('I', {})

    lines = []
    lines.append("━━━━━ B层：调制器 ━━━━━")

    # F调制器
    F_desc = "资金领先价格" if F_score > 0 else "价格领先资金"
    F_adj_desc = f"调整×{F_adjustment:.1f}"
    if F_adjustment < 1.0:
        F_adj_desc += " (惩罚)"
    elif F_adjustment > 1.0:
        F_adj_desc += " (奖励)"

    lines.append(f"F资金领先 {F_score:+d}: {F_desc} ({F_adj_desc})")

    # I调制器
    I_desc = "独立走势" if I_score > 50 else "跟随大盘"
    p_min_base = r.get('publish', {}).get('prime_prob_min', 0.62)
    p_min_adjusted = p_min_base  # TODO: 从元数据中获取实际调整值

    lines.append(f"I独立性 {I_score:+d}: {I_desc} (p_min: {p_min_base:.2f}→{p_min_adjusted:.2f})")

    return "\n".join(lines)


def render_four_gates(r: Dict[str, Any]) -> str:
    """
    渲染四门验证详情
    """
    gates = r.get('gates_results', {})

    lines = []
    lines.append("━━━━━ D层：四门验证 ━━━━━")

    # Gate 1
    dataqual = r.get('quality_score', 0)
    g1 = "✅" if dataqual >= 0.90 else "❌"
    lines.append(f"{g1} Gate1: DataQual {dataqual:.2f} >= 0.90")

    # Gate 2
    ev = gates.get('gate2', {}).get('ev', 0)
    g2 = "✅" if ev > 0 else "❌"
    lines.append(f"{g2} Gate2: EV {ev:+.2f}% > 0")

    # Gate 3
    g3_pass = gates.get('gate3', {}).get('passed', False)
    g3 = "✅" if g3_pass else "❌"
    lines.append(f"{g3} Gate3: Execution Metrics")

    # Gate 4
    prob = r.get('probability', 0)
    p_min = r.get('publish', {}).get('prime_prob_min', 0.62)
    g4_pass = prob >= p_min
    g4 = "✅" if g4_pass else "❌"
    lines.append(f"{g4} Gate4: P={prob:.0%} >= {p_min:.0%}")

    return "\n".join(lines)


def render_prime_breakdown(r: Dict[str, Any]) -> str:
    """
    渲染Prime评分分解
    """
    prime = r.get('publish', {})
    strength = prime.get('prime_strength', 0)
    breakdown = prime.get('prime_breakdown', {})

    base_strength = breakdown.get('base_strength', 0)
    prob_bonus = breakdown.get('prob_bonus', 0)

    lines = []
    lines.append(f"🎯 Prime: {strength}/100")
    lines.append(f"   基础强度: {base_strength:.1f}/60")
    lines.append(f"   概率加成: {prob_bonus:.1f}/40")

    return "\n".join(lines)


def render_signal_monitoring(r: Dict[str, Any], is_watch: bool = False) -> str:
    """
    监控模式：完整显示所有信息
    """
    symbol = r.get('symbol', 'UNKNOWN')
    price = r.get('price', 0)

    # 头部
    header = f"━━━━━━━━━━━━━━━━━━━━━━━\n"
    header += f"🔥 {symbol} @ {_fmt_price(price)} USDT\n"
    header += f"━━━━━━━━━━━━━━━━━━━━━━━\n"

    # 基础信息
    side = "LONG" if r.get('side_long', False) else "SHORT"
    confidence = r.get('confidence', 0)
    ttl = _ttl_hours(r)
    prob = r.get('probability', 0)

    basic = f"\n📊 Signal: {side} | 置信度 {confidence}% | TTL {ttl}h\n"

    # Prime和EV
    prime_str = render_prime_breakdown(r)
    ev = r.get('gates_results', {}).get('gate2', {}).get('ev', 0)
    basic += f"{prime_str} | EV: {ev:+.2f}% | 概率: {prob:.0%}\n"

    # 因子详情
    factors = render_factors_with_weights(r)

    # 调制器
    modulators = render_modulators(r)

    # 执行指标
    exec_metrics = _execution_metrics_block(r)

    # 四门验证
    gates = render_four_gates(r)

    # 价格建议
    pricing = _pricing_block(r)

    # 组装
    body = (
        f"{header}"
        f"{basic}\n"
        f"{factors}\n\n"
        f"{modulators}\n\n"
        f"{exec_metrics}\n\n"
        f"{gates}\n\n"
        f"{pricing}\n\n"
        f"{_note_and_tags(r, is_watch)}"
    )

    return body
```

---

## 七、总结

### 改进点

1. ✅ **显示权重**：每个因子旁边显示权重百分比
2. ✅ **显示贡献度**：计算每个因子对总分的贡献
3. ✅ **显示调制器**：F和I的分数和影响
4. ✅ **显示Prime详情**：评分分解和四门结果
5. ✅ **显示概率流程**：基础概率 → 调整 → 最终概率
6. ✅ **三种模式**：简洁/详细/监控，适配不同场景

### 使用场景

| 模式 | 场景 | 输出位置 |
|-----|------|---------|
| 简洁模式 | 日常交易 | Telegram |
| 详细模式 | 调试分析 | 本地日志 |
| 监控模式 | 实时监控 | 控制台/仪表盘 |

---

**文档版本**: v1.0
**创建时间**: 2025-10-31
**作者**: Claude (CryptoSignal 监控输出设计)
