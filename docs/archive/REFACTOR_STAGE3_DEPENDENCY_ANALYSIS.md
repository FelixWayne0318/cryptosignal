# é˜¶æ®µ3ä¾èµ–åˆ†ææŠ¥å‘Š

## ğŸ¯ ç›®æ ‡

æ¶ˆé™¤åŸºç¡€å±‚çš„é‡å¤è®¡ç®—ï¼š
- ç§»é™¤åŸºç¡€å±‚çš„æ¦‚ç‡è®¡ç®—ï¼ˆP_long/P_short/probabilityï¼‰
- ç§»é™¤åŸºç¡€å±‚çš„EVè®¡ç®—ï¼ˆEV/EV_positiveï¼‰
- ç§»é™¤åŸºç¡€å±‚çš„weighted_scoreè®¡ç®—

## ğŸ“Š ä¾èµ–åˆ†æç»“æœ

### 1. å…³é”®ç”Ÿäº§ä»£ç ä¾èµ–

#### 1.1 æ•°æ®åº“å±‚ï¼ˆé«˜é£é™©ï¼‰

**æ–‡ä»¶**: `ats_core/data/analysis_db.py`

**ä½¿ç”¨æƒ…å†µ**:
```python
# L507: write_analysis() - å­˜å‚¨weighted_score
data.get('weighted_score', 0)

# L570: write_signal_analysis() - å­˜å‚¨raw_probability
data.get('probability', 0.5)  â†’ raw_probabilityå­—æ®µ

# L578: write_signal_analysis() - å­˜å‚¨calibrated_probability
v72.get('P_calibrated', 0.5)  â†’ calibrated_probabilityå­—æ®µ

# L584: write_signal_analysis() - å­˜å‚¨weighted_score
data.get('weighted_score', 0)
```

**æ•°æ®åº“schema**:
```sql
CREATE TABLE analysis (
    weighted_score REAL,          -- åŸºç¡€å±‚çš„weighted_score
    raw_probability REAL,         -- åŸºç¡€å±‚çš„probability
    calibrated_probability REAL,  -- v7.2å±‚çš„P_calibrated
    ...
)
```

**é—®é¢˜**:
- æ•°æ®åº“è®¾è®¡ä¸ºåŒæ—¶å­˜å‚¨åŸºç¡€å±‚å’Œv7.2å±‚çš„å€¼
- raw_probabilityç”¨äºå¯¹æ¯”è¯Šæ–­
- å¦‚æœç§»é™¤åŸºç¡€å±‚çš„probabilityï¼Œraw_probabilityä¼šå˜æˆé»˜è®¤å€¼0.5
- **å½±å“**: å¤±å»è¯Šæ–­å’Œå¯¹æ¯”èƒ½åŠ›

---

#### 1.2 Telegramè¾“å‡ºï¼ˆä½é£é™©ï¼‰

**æ–‡ä»¶**: `ats_core/outputs/telegram_fmt.py`

**ä½¿ç”¨æƒ…å†µ**:
```python
# L2238-2240: render_signal_v72()
P_calibrated = _get(v72, "P_calibrated") or _get(r, "probability") or 0.5
EV_net = _get(v72, "EV_net") or _get(r, "expected_value") or 0
```

**é—®é¢˜**:
- å·²ç»åšäº†å‘åå…¼å®¹å¤„ç†
- ä¼˜å…ˆä½¿ç”¨v7.2çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°åŸºç¡€å±‚
- **å½±å“**: ä½ï¼Œä¼šå›é€€åˆ°é»˜è®¤å€¼

---

#### 1.3 å…¶ä»–æ•°æ®åº“æ“ä½œï¼ˆä¸­é£é™©ï¼‰

**æ–‡ä»¶**: `ats_core/database/operations.py`

éœ€è¦æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†è¿™äº›å­—æ®µã€‚

---

#### 1.4 æ‰¹é‡æ‰«æå™¨ï¼ˆä½é£é™©ï¼‰

**æ–‡ä»¶**: `ats_core/pipeline/batch_scan_optimized.py`

**æ£€æŸ¥ç»“æœ**: æœªç›´æ¥ä½¿ç”¨åºŸå¼ƒå­—æ®µ

---

### 2. æµ‹è¯•ä»£ç ä¾èµ–ï¼ˆå¯æ›´æ–°ï¼‰

ä»¥ä¸‹æµ‹è¯•æ–‡ä»¶ä½¿ç”¨äº†åºŸå¼ƒå­—æ®µï¼š
- `tests/test_v66_5coins.py`
- `tests/test_phase1_data_freshness.py`
- `tests/diagnose_v66.py`
- `tests/test_5_coins_old.py`
- `diagnose/diagnostic_scan.py`

**å½±å“**: æµ‹è¯•ä¼šå¤±è´¥ï¼Œéœ€è¦æ›´æ–°

---

## ğŸ’¡ é‡æ„ç­–ç•¥åˆ†æ

### æ–¹æ¡ˆAï¼šå®Œå…¨ç§»é™¤ï¼ˆæ¿€è¿›ï¼‰

**æ“ä½œ**:
1. ä»åŸºç¡€å±‚å®Œå…¨ç§»é™¤probability/EV/weighted_scoreçš„è®¡ç®—
2. ç§»é™¤ç›¸å…³å¯¼å…¥å’Œå‡½æ•°
3. æ›´æ–°æ•°æ®åº“schemaï¼Œç§»é™¤raw_*å­—æ®µ
4. æ›´æ–°æ‰€æœ‰ä¾èµ–ä»£ç 
5. æ›´æ–°æ‰€æœ‰æµ‹è¯•

**ä¼˜ç‚¹**:
- âœ… å½»åº•æ¶ˆé™¤é‡å¤è®¡ç®—
- âœ… ä»£ç æœ€ç®€æ´
- âœ… æ€§èƒ½æœ€ä¼˜

**ç¼ºç‚¹**:
- âŒ ç ´åæ€§æå¼º
- âŒ å¤±å»è¯Šæ–­å’Œå¯¹æ¯”èƒ½åŠ›
- âŒ å†å²æ•°æ®ä¸å…¼å®¹
- âŒ éœ€è¦å¤§é‡ä»£ç æ›´æ–°
- âŒ é£é™©é«˜ï¼Œå¯èƒ½é—æ¼ä¾èµ–

**é¢„è®¡å·¥ä½œé‡**: 6-8å°æ—¶

---

### æ–¹æ¡ˆBï¼šç®€åŒ–è®¡ç®—ï¼ˆæ¸©å’Œï¼‰

**æ“ä½œ**:
1. ä¿ç•™åŸºç¡€å±‚çš„å­—æ®µï¼Œä½†ç®€åŒ–è®¡ç®—é€»è¾‘
2. ç§»é™¤å¤æ‚çš„è°ƒæ•´å’Œæ ¡å‡†ï¼ˆä½¿ç”¨æœ€ç®€åŒ–å…¬å¼ï¼‰
3. ä¿æŒæ•°æ®åº“schemaä¸å˜
4. æ·»åŠ æ—¥å¿—è­¦å‘Šï¼Œå¼•å¯¼ä½¿ç”¨v7.2å€¼

**å…·ä½“ç®€åŒ–**:
```python
# æ¦‚ç‡ï¼šä½¿ç”¨æœ€ç®€åŒ–çš„sigmoidæ˜ å°„
P_long, P_short = map_probability_sigmoid(edge, 0.5, 1.0, 1.0)
# ä¸å†åº”ç”¨è°ƒåˆ¶å™¨è°ƒæ•´

# EVï¼šä½¿ç”¨æœ€ç®€åŒ–å…¬å¼
EV = P_chosen * abs(edge) - (1 - P_chosen) * 0.02
# ä¸å†ä½¿ç”¨å¤æ‚çš„costè®¡ç®—

# weighted_scoreï¼šä½¿ç”¨åŸºç¡€æƒé‡
weighted_score = T*0.24 + M*0.17 + C*0.24 + V*0.12 + O*0.17 + B*0.06
# ä¸å†åº”ç”¨è°ƒåˆ¶å™¨
```

**ä¼˜ç‚¹**:
- âœ… å‡å°‘50%ä»¥ä¸Šçš„è®¡ç®—é‡
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… ä¿ç•™è¯Šæ–­èƒ½åŠ›
- âœ… é£é™©ä½
- âœ… æ•°æ®åº“ä¸éœ€è¦æ”¹åŠ¨

**ç¼ºç‚¹**:
- âš ï¸ ä»ç„¶æœ‰å°‘é‡é‡å¤è®¡ç®—
- âš ï¸ ä»£ç ä¸­ä»ç„¶ä¿ç•™åºŸå¼ƒé€»è¾‘

**é¢„è®¡å·¥ä½œé‡**: 2-3å°æ—¶

---

### æ–¹æ¡ˆCï¼šæ ‡è®°+è­¦å‘Šï¼ˆä¿å®ˆï¼‰

**æ“ä½œ**:
1. ä¿æŒé˜¶æ®µ2çš„çŠ¶æ€ï¼ˆå·²æ ‡è®°DEPRECATEDï¼‰
2. æ·»åŠ è¿è¡Œæ—¶è­¦å‘Šæ—¥å¿—
3. ä¸åšä»»ä½•ç ´åæ€§ä¿®æ”¹
4. ç­‰å¾…ç”¨æˆ·åé¦ˆåå†å†³å®š

**ä¼˜ç‚¹**:
- âœ… 100%å‘åå…¼å®¹
- âœ… é›¶é£é™©
- âœ… å¯éšæ—¶å›æ»š

**ç¼ºç‚¹**:
- âŒ ä»ç„¶æœ‰é‡å¤è®¡ç®—
- âŒ æ²¡æœ‰å®è´¨æ€§æ”¹è¿›

**é¢„è®¡å·¥ä½œé‡**: 0.5å°æ—¶

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### ç»¼åˆè¯„ä¼°

| æ–¹æ¡ˆ | å…¼å®¹æ€§ | é£é™© | æ€§èƒ½æå‡ | ä»£ç æ¸…æ´åº¦ | å·¥ä½œé‡ |
|------|--------|------|----------|------------|--------|
| Aå®Œå…¨ç§»é™¤ | âŒ ç ´å | ğŸ”´ é«˜ | â­â­â­â­â­ | â­â­â­â­â­ | 6-8h |
| Bç®€åŒ–è®¡ç®— | âœ… å…¼å®¹ | ğŸŸ¢ ä½ | â­â­â­â­ | â­â­â­ | 2-3h |
| Cæ ‡è®°è­¦å‘Š | âœ… å…¼å®¹ | ğŸŸ¢ ä½ | â­ | â­ | 0.5h |

### æ¨èï¼š**æ–¹æ¡ˆB - ç®€åŒ–è®¡ç®—**

**ç†ç”±**:
1. **å¹³è¡¡**: åœ¨æ€§èƒ½ã€é£é™©ã€å…¼å®¹æ€§ä¹‹é—´å–å¾—æœ€ä½³å¹³è¡¡
2. **å®ç”¨**: ä¿ç•™è¯Šæ–­èƒ½åŠ›ï¼ˆraw vs calibratedå¯¹æ¯”ï¼‰
3. **å®‰å…¨**: ä¸ç ´åç°æœ‰æ•°æ®åº“å’Œä¾èµ–
4. **æœ‰æ•ˆ**: å‡å°‘50%+è®¡ç®—é‡
5. **æ¸è¿›**: å¯ä»¥åœ¨åç»­ç‰ˆæœ¬ä¸­è¿›ä¸€æ­¥ä¼˜åŒ–

### å®æ–½è®¡åˆ’ï¼ˆæ–¹æ¡ˆBï¼‰

#### ç¬¬1æ­¥ï¼šç®€åŒ–æ¦‚ç‡è®¡ç®—ï¼ˆ30åˆ†é’Ÿï¼‰
```python
# ç§»é™¤å‰ï¼šå¤æ‚çš„è°ƒåˆ¶å™¨è°ƒæ•´
P_long_base, P_short_base = map_probability_sigmoid(edge, prior_up, quality_score, temperature)
P_long = min(0.95, P_long_base)
P_short = min(0.95, P_short_base)

# ç®€åŒ–åï¼šåŸºç¡€sigmoidæ˜ å°„
P_long, P_short = map_probability_sigmoid(edge, 0.5, 1.0, 1.0)
P_chosen = P_long if side_long else P_short
```

#### ç¬¬2æ­¥ï¼šç®€åŒ–EVè®¡ç®—ï¼ˆ30åˆ†é’Ÿï¼‰
```python
# ç§»é™¤å‰ï¼šä½¿ç”¨è°ƒåˆ¶åçš„cost
EV = P_chosen * abs(edge) - (1 - P_chosen) * modulator_output.cost_final

# ç®€åŒ–åï¼šä½¿ç”¨å›ºå®šæˆæœ¬
EV = P_chosen * abs(edge) - (1 - P_chosen) * 0.02  # 2%å›ºå®šæˆæœ¬
```

#### ç¬¬3æ­¥ï¼šç®€åŒ–weighted_scoreï¼ˆ30åˆ†é’Ÿï¼‰
```python
# ä¿æŒå½“å‰è®¡ç®—ï¼ˆå·²ç»å¾ˆç®€å•ï¼‰
weighted_score = (T*w['T'] + M*w['M'] + C*w['C'] +
                  V*w['V'] + O*w['O'] + B*w['B'])
# æ³¨æ„ï¼šè¿™ä¸ªè®¡ç®—å·²ç»ä¸ä¾èµ–è°ƒåˆ¶å™¨ï¼Œæ— éœ€ç®€åŒ–
```

#### ç¬¬4æ­¥ï¼šæ·»åŠ åºŸå¼ƒè­¦å‘Šï¼ˆ30åˆ†é’Ÿï¼‰
```python
import warnings

# åœ¨è¿”å›ç»“æœæ—¶æ·»åŠ è­¦å‘Š
warnings.warn(
    "åŸºç¡€å±‚çš„probability/EVè®¡ç®—å·²ç®€åŒ–ï¼Œç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨v7.2å±‚çš„P_calibrated/EV_net",
    DeprecationWarning,
    stacklevel=2
)
```

#### ç¬¬5æ­¥ï¼šæ›´æ–°æ–‡æ¡£ï¼ˆ30åˆ†é’Ÿï¼‰
- æ›´æ–°æ¶æ„æ–‡æ¡£
- è¯´æ˜ç®€åŒ–é€»è¾‘
- å¼•å¯¼ç”¨æˆ·ä½¿ç”¨v7.2å€¼

---

## âš ï¸ é£é™©è¯„ä¼°

### æ–¹æ¡ˆBé£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| ç®€åŒ–åæ¦‚ç‡ä¸å‡†ç¡® | ä½ | ä¸­ | åŸºç¡€å±‚ä»…ç”¨äºè¯Šæ–­ï¼Œä¸å½±å“æœ€ç»ˆåˆ¤å®š |
| æ•°æ®åº“å¯¹æ¯”å¤±æ•ˆ | ä½ | ä½ | raw vs calibratedä»ç„¶æœ‰æ„ä¹‰ |
| æµ‹è¯•å¤±è´¥ | ä½ | ä½ | åŸºç¡€å€¼ä»ç„¶å­˜åœ¨ï¼Œåªæ˜¯ç®€åŒ–äº† |

---

## ğŸ“‹ å¾…ç¡®è®¤é—®é¢˜

1. **æ˜¯å¦æ¥å—æ–¹æ¡ˆB**ï¼ˆç®€åŒ–è®¡ç®—è€Œéå®Œå…¨ç§»é™¤ï¼‰ï¼Ÿ
2. **æ˜¯å¦ä¿ç•™æ•°æ®åº“çš„raw_probabilityå­—æ®µ**ï¼ˆç”¨äºè¯Šæ–­ï¼‰ï¼Ÿ
3. **æ˜¯å¦éœ€è¦æ›´æ–°æµ‹è¯•**ï¼ˆä½¿ç”¨v7.2å­—æ®µè€ŒéåŸºç¡€å±‚å­—æ®µï¼‰ï¼Ÿ

---

## ğŸ”„ å¦‚æœé€‰æ‹©æ–¹æ¡ˆAï¼ˆå®Œå…¨ç§»é™¤ï¼‰

éœ€è¦é¢å¤–å®Œæˆçš„ä»»åŠ¡ï¼š

### æ•°æ®åº“è¿ç§»
```sql
-- ç§»é™¤åºŸå¼ƒå­—æ®µ
ALTER TABLE analysis DROP COLUMN raw_probability;
ALTER TABLE analysis DROP COLUMN weighted_score;
-- ä¿ç•™calibrated_probabilityï¼ˆé‡å‘½åä¸ºprobabilityï¼‰
ALTER TABLE analysis RENAME COLUMN calibrated_probability TO probability;
```

### ä»£ç æ›´æ–°æ¸…å•
- [x] `ats_core/pipeline/analyze_symbol.py` - ç§»é™¤è®¡ç®—é€»è¾‘
- [ ] `ats_core/data/analysis_db.py` - ç§»é™¤åºŸå¼ƒå­—æ®µå­˜å‚¨
- [ ] `ats_core/database/operations.py` - æ›´æ–°æŸ¥è¯¢
- [ ] `ats_core/outputs/telegram_fmt.py` - ç§»é™¤fallbacké€»è¾‘
- [ ] `ats_core/data/trade_recorder.py` - æ›´æ–°å­—æ®µè¯»å–
- [ ] `ats_core/publishing/calibration.py` - æ›´æ–°å­—æ®µè¯»å–
- [ ] `ats_core/analysis/scan_statistics.py` - æ›´æ–°å­—æ®µè¯»å–
- [ ] `ats_core/scoring/scorecard.py` - æ›´æ–°å­—æ®µè¯»å–
- [ ] `tests/` - æ›´æ–°æ‰€æœ‰æµ‹è¯•

**é¢„è®¡å·¥ä½œé‡**: 6-8å°æ—¶

---

**æ—¥æœŸ**: 2025-11-09
**åˆ†æè€…**: Claude
**çŠ¶æ€**: å¾…ç”¨æˆ·ç¡®è®¤æ–¹æ¡ˆ
