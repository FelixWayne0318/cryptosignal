# v7.2.36 CVDæ•°æ®è·å–æ»¡è¶³åº¦åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-11-12
**åˆ†æç‰ˆæœ¬**: v7.2.36 CVDå¢å¼ºç‰ˆ
**åˆ†æèŒƒå›´**: æ•°æ®è·å–æ¨¡å—æ˜¯å¦æ»¡è¶³CVDè®¡ç®—éœ€æ±‚

---

## æ‰§è¡Œæ‘˜è¦

âœ… **åŸºç¡€æ•°æ®è·å–æ»¡è¶³è¦æ±‚**ï¼ˆKçº¿ã€OIã€ç°è´§ï¼‰
âš ï¸ **å­˜åœ¨4ä¸ªé›†æˆgapéœ€ä¿®å¤**ï¼ˆå‚æ•°ã€è¿‡æ»¤ã€å¼‚å¸¸å¤„ç†ã€metaæ”¶é›†ï¼‰
ğŸ”§ **å»ºè®®ç«‹å³å®æ–½6é¡¹æ”¹è¿›**ï¼ˆè¯¦è§ç¬¬4ç« ï¼‰

---

## 1. v7.2.36 CVDè®¡ç®—æ•°æ®éœ€æ±‚

### 1.1 åˆçº¦Kçº¿æ•°æ®ï¼ˆå¿…éœ€ï¼‰

**æ ¼å¼è¦æ±‚**ï¼šBinance 12åˆ—æ ‡å‡†æ ¼å¼

| åˆ—å· | å­—æ®µå | ç”¨é€” | v7.2.36å…³é”®åŠŸèƒ½ |
|------|--------|------|----------------|
| 0 | openTime | Kçº¿èµ·å§‹æ—¶é—´ | âœ… å¯¹é½æ£€æŸ¥ã€å»é‡æ£€æµ‹ï¼ˆæ¡ä»¶6ï¼‰ |
| 1-5 | OHLCV | ä»·æ ¼ä¸æˆäº¤é‡ | âœ… åŸºç¡€CVDè®¡ç®— |
| 6 | closeTime | Kçº¿ç»“æŸæ—¶é—´ | âœ… OIå¯¹é½ï¼ˆæ¡ä»¶2ï¼‰ã€æœªæ”¶ç›˜è¿‡æ»¤ï¼ˆæ¡ä»¶5ï¼‰ |
| 7 | quoteAssetVolume | æ€»æˆäº¤é¢ï¼ˆUSDTï¼‰ | âœ… imbalance_ratioåˆ†æ¯ï¼ˆæ¡ä»¶1ï¼‰ |
| 9 | takerBuyBaseVolume | ä¸»åŠ¨ä¹°å…¥é‡ï¼ˆå¸ï¼‰ | âœ… Base CVDå¤‡ç”¨ |
| 10 | takerBuyQuoteVolume | ä¸»åŠ¨ä¹°å…¥é¢ï¼ˆUSDTï¼‰ | âœ… Quote CVDæ ¸å¿ƒï¼ˆæ¡ä»¶1ï¼‰ |

**æ ¸å¿ƒè®¡ç®—å…¬å¼**ï¼š
```python
delta = 2.0 * takerBuyQuote - quoteAssetVolume  # CVDå¢é‡
imbalance_ratio = delta / max(quoteAssetVolume, 1.0)  # æ¡ä»¶1: å°ºåº¦å¯¹å†²
```

### 1.2 OIå†å²æ•°æ®ï¼ˆå¿…éœ€ï¼‰

**æ ¼å¼è¦æ±‚**ï¼š
```json
[
  {"symbol": "BTCUSDT", "sumOpenInterest": "1234.5", "timestamp": 1700000000000},
  ...
]
```

**å…³é”®å­—æ®µ**ï¼š
- `timestamp`: **æ¯«ç§’çº§ç²¾åº¦**ï¼ˆç”¨äº"å–å‰ä¸å–å"å¯¹é½ï¼‰
- `sumOpenInterest` / `sumOpenInterestValue` / `openInterest`: OIå€¼

**v7.2.36éœ€æ±‚**ï¼š
- âœ… æ¡ä»¶2: å¯¹æ¯ä¸ªcloseTimeï¼Œæ‰¾æœ€è¿‘çš„ `oi_ts <= closeTime`
- âœ… å®¹å¿åº¦: `|oi_ts - closeTime| <= tolerance_ms`

### 1.3 ç°è´§Kçº¿æ•°æ®ï¼ˆå¯é€‰ï¼‰

**æ ¼å¼è¦æ±‚**ï¼šä¸åˆçº¦Kçº¿ç›¸åŒï¼ˆ12åˆ—ï¼‰

**ä½œç”¨**ï¼š
- åˆçº¦+ç°è´§CVDç»„åˆï¼ˆåŠ¨æ€æƒé‡ï¼‰
- æ— ç°è´§æ—¶è‡ªåŠ¨é™çº§ï¼ˆdegraded=Trueï¼‰

### 1.4 å®æ—¶æ•°æ®éœ€æ±‚ï¼ˆv7.2.36æ–°å¢ï¼‰

**æœªæ”¶ç›˜Kçº¿è¿‡æ»¤**ï¼ˆæ¡ä»¶5ï¼‰ï¼š
- éœ€è¦å½“å‰æ—¶é—´æˆ³ `now_ms`
- è¿‡æ»¤è§„åˆ™ï¼š`now_ms < closeTime + safety_lag_ms`

---

## 2. å½“å‰æ•°æ®è·å–å®ç°æ£€æŸ¥

### 2.1 åˆçº¦Kçº¿è·å– âœ… æ»¡è¶³

**å®ç°ä½ç½®**ï¼š`ats_core/sources/binance.py`

```python
def get_klines(
    symbol: str,
    interval: str,
    limit: int = 300,
    start_time: Optional[Union[int, float]] = None,
    end_time: Optional[Union[int, float]] = None,
) -> List[list]:
    """
    è¿”å›ç¬¦åˆ Binance /fapi/v1/klines è§„èŒƒçš„äºŒç»´æ•°ç»„
    æ¯æ¡è®°å½•å­—æ®µï¼š
      [ openTime, open, high, low, close, volume, closeTime, quoteAssetVolume,
        numberOfTrades, takerBuyBaseVolume, takerBuyQuoteVolume, ignore ]
    """
    # ... å®ç°çœç•¥
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… è¿”å›å®Œæ•´12åˆ—æ•°æ®
- âœ… åŒ…å«closeTimeï¼ˆåˆ—6ï¼‰
- âœ… åŒ…å«quoteAssetVolumeï¼ˆåˆ—7ï¼‰
- âœ… åŒ…å«takerBuyQuoteVolumeï¼ˆåˆ—10ï¼‰
- âœ… openTimeä¸ºæ¯«ç§’çº§æ—¶é—´æˆ³

**ç»“è®º**ï¼š**å®Œå…¨æ»¡è¶³v7.2.36éœ€æ±‚**

---

### 2.2 OIå†å²æ•°æ®è·å– âœ… æ»¡è¶³

**å®ç°ä½ç½®**ï¼š`ats_core/sources/binance.py`

```python
def get_open_interest_hist(symbol: str, period: str = "1h", limit: int = 200) -> List[dict]:
    """
    /futures/data/openInterestHist
    è¿”å›å½¢å¦‚ï¼š
      [{"symbol":"BTCUSDT","sumOpenInterest":"1234.5","sumOpenInterestValue":"...","timestamp":1690000000000}, ...]
    period: "5m"|"15m"|"30m"|"1h"|"2h"|"4h"|"6h"|"12h"|"1d"
    """
    return _get(
        "/futures/data/openInterestHist",
        {"symbol": symbol, "period": period, "limit": limit},
        timeout=8.0,
        retries=2,
    )
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… è¿”å›dictåˆ—è¡¨
- âœ… åŒ…å«timestampï¼ˆæ¯«ç§’çº§ç²¾åº¦ï¼‰
- âœ… åŒ…å«sumOpenInterestå­—æ®µ
- âœ… æ”¯æŒ1hå‘¨æœŸï¼ˆä¸Kçº¿å‘¨æœŸå¯¹é½ï¼‰

**ç»“è®º**ï¼š**å®Œå…¨æ»¡è¶³v7.2.36éœ€æ±‚**

---

### 2.3 ç°è´§Kçº¿è·å– âœ… æ»¡è¶³

**å®ç°ä½ç½®**ï¼š`ats_core/sources/binance.py`

```python
def get_spot_klines(
    symbol: str,
    interval: str,
    limit: int = 300,
    start_time: Optional[Union[int, float]] = None,
    end_time: Optional[Union[int, float]] = None,
) -> List[list]:
    """
    è·å–ç°è´§Kçº¿æ•°æ®ï¼ˆBinance Spot APIï¼‰

    è¿”å›æ ¼å¼ä¸åˆçº¦ç›¸åŒï¼š
      [ openTime, open, high, low, close, volume, closeTime, quoteAssetVolume,
        numberOfTrades, takerBuyBaseVolume, takerBuyQuoteVolume, ignore ]
    """
    # ä½¿ç”¨ç°è´§APIç«¯ç‚¹
    return _get(SPOT_BASE + "/api/v3/klines", params, timeout=10.0, retries=2)
```

**è°ƒç”¨ä½ç½®**ï¼š`ats_core/pipeline/analyze_symbol.py:1694`

```python
# å°è¯•è·å–ç°è´§Kçº¿ï¼ˆç”¨äºCVDç»„åˆè®¡ç®—ï¼‰
# å¦‚æœå¤±è´¥ï¼ˆæŸäº›å¸åªæœ‰åˆçº¦ï¼‰ï¼Œcvd_mix_with_oi_priceä¼šè‡ªåŠ¨é™çº§åˆ°åªç”¨åˆçº¦CVD
try:
    spot_k1 = get_spot_klines(symbol, "1h", 300)
except Exception:
    spot_k1 = None
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… è¿”å›å®Œæ•´12åˆ—æ•°æ®ï¼ˆæ ¼å¼ä¸åˆçº¦ç›¸åŒï¼‰
- âœ… å¼‚å¸¸å¤„ç†å®Œå–„ï¼ˆæ— ç°è´§æ—¶ä¸ä¼šå´©æºƒï¼‰
- âœ… è‡ªåŠ¨é™çº§æœºåˆ¶ï¼ˆspot_k1=Noneæ—¶CVDåªç”¨åˆçº¦ï¼‰

**ç»“è®º**ï¼š**å®Œå…¨æ»¡è¶³v7.2.36éœ€æ±‚**

---

## 3. æ•°æ®é›†æˆGapåˆ†æ

### Gap 1: CVDè°ƒç”¨å‚æ•°æœªæ›´æ–° âš ï¸ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜ä½ç½®**ï¼š`ats_core/pipeline/analyze_symbol.py:490`

```python
# å½“å‰è°ƒç”¨ï¼ˆv7.2.35ç‰ˆæœ¬ï¼‰
cvd_series, cvd_mix = cvd_mix_with_oi_price(k1, oi_data, window=20, spot_klines=spot_k1)
```

**é—®é¢˜**ï¼š
1. âŒ `window=20` - v7.2.35å·²åˆ é™¤æ­¤å‚æ•°ï¼ˆå†—ä½™ï¼‰
2. âŒ ç¼ºå°‘v7.2.36æ–°å¢å‚æ•°ï¼š
   - `use_strict_oi_align=False` - æœªå¯ç”¨ä¸¥æ ¼OIå¯¹é½
   - `oi_align_tolerance_ms=5000` - æœªé…ç½®å®¹å¿åº¦
   - `return_meta=False` - æœªè·å–metaä¿¡æ¯

**å½±å“**ï¼š
- æ¡ä»¶2ï¼ˆå–å‰ä¸å–åï¼‰æœªç”Ÿæ•ˆ
- æ— æ³•è·å–metaä¿¡æ¯ï¼ˆdegradedæ ‡å¿—ã€oi_missing_ratioç­‰ï¼‰

**å»ºè®®ä¿®å¤**ï¼š
```python
# v7.2.36ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
cvd_series, cvd_mix, cvd_meta = cvd_mix_with_oi_price(
    k1, oi_data,
    spot_klines=spot_k1,
    use_strict_oi_align=True,          # å¯ç”¨æ¡ä»¶2
    oi_align_tolerance_ms=5000,        # é…ç½®å®¹å¿åº¦
    return_meta=True                   # è·å–meta
)
```

---

### Gap 2: æœªæ”¶ç›˜Kçº¿æœªè¿‡æ»¤ âŒ é«˜ä¼˜å…ˆçº§

**é—®é¢˜**ï¼šv7.2.36æ¡ä»¶5æœªå®æ–½

**å½“å‰çŠ¶æ€**ï¼š
- âœ… å‡½æ•°å·²å®ç°ï¼š`ats_core/utils/cvd_utils.filter_unclosed_klines()`
- âŒ pipelineä¸­æœªè°ƒç”¨

**å½±å“**ï¼š
- å®ç›˜æ‹‰å–æ—¶å¯èƒ½åŒ…å«"æ­£åœ¨å½¢æˆ"çš„æœ€åä¸€æ ¹Kçº¿
- closeTimeæœªåˆ°ï¼Œæ•°æ®ä¸å®Œæ•´ï¼ˆvolumeã€quoteVolå¯èƒ½å˜åŒ–ï¼‰
- å¯¼è‡´CVDè®¡ç®—ä¸å‡†ç¡®

**å»ºè®®ä¿®å¤**ï¼š
```python
# åœ¨analyze_symbol.pyæ•°æ®è·å–åæ·»åŠ 
import time

# è¿‡æ»¤æœªæ”¶ç›˜Kçº¿ï¼ˆæ¡ä»¶5ï¼‰
from ats_core.utils.cvd_utils import filter_unclosed_klines
from ats_core.config.threshold_config import get_thresholds

config = get_thresholds()
safety_lag_ms = config.get('CVDè®¡ç®—å‚æ•°', {}).get('safety_lag_ms', 5000)
now_ms = int(time.time() * 1000)

k1, filtered_count = filter_unclosed_klines(k1, now_ms, safety_lag_ms)
if spot_k1:
    spot_k1, _ = filter_unclosed_klines(spot_k1, now_ms, safety_lag_ms)
```

---

### Gap 3: é‡å¤æ—¶é—´æˆ³å¼‚å¸¸æœªæ•è· âš ï¸ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜**ï¼šv7.2.36æ¡ä»¶6è‡ªåŠ¨æ£€æµ‹ï¼Œä½†è°ƒç”¨æ–¹æœªæ•è·å¼‚å¸¸

**å½“å‰çŠ¶æ€**ï¼š
- âœ… `align_klines_by_open_time()` è‡ªåŠ¨æŠ›å‡º `ValueError("åˆçº¦Kçº¿å­˜åœ¨é‡å¤openTime")`
- âŒ `cvd_mix_with_oi_price()` å†…éƒ¨è°ƒç”¨ï¼Œä½†å¼‚å¸¸æœªå‘ä¸Šä¼ æ’­
- âŒ `analyze_symbol.py` æœªæ•è·æ­¤å¼‚å¸¸

**å½±å“**ï¼š
- é‡å¤æ—¶é—´æˆ³ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ
- æ— é™çº§å¤„ç†ï¼Œæ— æ—¥å¿—è®°å½•

**å»ºè®®ä¿®å¤**ï¼š
```python
# åœ¨analyze_symbol.pyä¸­æ·»åŠ try-except
try:
    cvd_series, cvd_mix, cvd_meta = cvd_mix_with_oi_price(...)
except ValueError as e:
    if "é‡å¤openTime" in str(e):
        warn(f"âš ï¸  {symbol} CVDè®¡ç®—å¤±è´¥: {e}ï¼Œä½¿ç”¨fallback")
        cvd_series = [0.0] * len(k1)
        cvd_mix = [0.0] * len(k1)
        cvd_meta = {"error": "duplicate_timestamp"}
    else:
        raise
```

---

### Gap 4: Metaä¿¡æ¯æœªæ”¶é›† âš ï¸ ä½ä¼˜å…ˆçº§

**é—®é¢˜**ï¼šv7.2.36æ¡ä»¶1å’Œæ¡ä»¶4çš„metaä¿¡æ¯æœªè¢«ä½¿ç”¨

**å½“å‰çŠ¶æ€**ï¼š
- âœ… å‡½æ•°å·²æ”¯æŒï¼š`cvd_from_klines(..., expose_meta=True)`
- âœ… å‡½æ•°å·²æ”¯æŒï¼š`cvd_combined(..., return_meta=True)`
- âŒ pipelineä¸­æœªå¯ç”¨
- âŒ imbalance_ratioæœªè¢«è®¡ç®—
- âŒ degradedæ ‡å¿—æœªè¢«æ£€æŸ¥

**å½±å“**ï¼š
- æ— æ³•ç›‘æ§CVDè´¨é‡ï¼ˆdegradedã€oi_missing_ratioç­‰ï¼‰
- æ— æ³•ä½¿ç”¨imbalance_ratioç‰¹å¾ï¼ˆæ¡ä»¶1ï¼‰
- ç°åº¦ä¸Šçº¿æ—¶ç¼ºå°‘å…³é”®è§‚å¯ŸæŒ‡æ ‡

**å»ºè®®ä¿®å¤**ï¼š
```python
# æ”¶é›†metaä¿¡æ¯ç”¨äºæ—¥å¿—å’Œç›‘æ§
if cvd_meta:
    if cvd_meta.get('degraded'):
        warn(f"âš ï¸  {symbol} CVDé™çº§: {cvd_meta.get('degrade_reason')}")

    oi_missing = cvd_meta.get('oi_missing_ratio', 0)
    if oi_missing > 0.1:
        warn(f"âš ï¸  {symbol} OIå¯¹é½ç¼ºå¤±ç‡ {oi_missing:.2%}")

    # å¯é€‰ï¼šå°†imbalance_ratioä½œä¸ºé¢å¤–ç‰¹å¾
    # imbalance_ratio = cvd_meta.get('imbalance_ratios', [])
```

---

## 4. æ”¹è¿›å»ºè®®

### 4.1 ç«‹å³å®æ–½ï¼ˆP0 - Blockingï¼‰

#### å»ºè®®1: æ·»åŠ æœªæ”¶ç›˜Kçº¿è¿‡æ»¤

**æ–‡ä»¶**ï¼š`ats_core/pipeline/analyze_symbol.py`
**ä½ç½®**ï¼šæ•°æ®è·å–åã€CVDè®¡ç®—å‰
**ä¿®æ”¹**ï¼š

```python
# åœ¨ç¬¬1697è¡Œåæ·»åŠ ï¼ˆspot_k1è·å–ä¹‹åï¼‰
# ========== v7.2.36: æ¡ä»¶5 - è¿‡æ»¤æœªæ”¶ç›˜Kçº¿ ==========
from ats_core.utils.cvd_utils import filter_unclosed_klines
import time

safety_lag_ms = get_thresholds().get('CVDè®¡ç®—å‚æ•°', {}).get('safety_lag_ms', 5000)
now_ms = int(time.time() * 1000)

# è¿‡æ»¤åˆçº¦Kçº¿
k1, filtered_f = filter_unclosed_klines(k1, now_ms, safety_lag_ms)
if filtered_f > 0:
    log(f"ğŸ” {symbol} åˆçº¦Kçº¿è¿‡æ»¤æœªæ”¶ç›˜: {filtered_f}æ ¹")

# è¿‡æ»¤ç°è´§Kçº¿ï¼ˆå¦‚æœæœ‰ï¼‰
if spot_k1:
    spot_k1, filtered_s = filter_unclosed_klines(spot_k1, now_ms, safety_lag_ms)
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… æ¶ˆé™¤"æ­£åœ¨å½¢æˆ"Kçº¿å¯¼è‡´çš„CVDæŠ–åŠ¨
- âœ… å®ç›˜æ•°æ®è´¨é‡æå‡

---

#### å»ºè®®2: æ›´æ–°CVDè°ƒç”¨å‚æ•°

**æ–‡ä»¶**ï¼š`ats_core/pipeline/analyze_symbol.py`
**ä½ç½®**ï¼šç¬¬490è¡Œ
**ä¿®æ”¹å‰**ï¼š
```python
cvd_series, cvd_mix = cvd_mix_with_oi_price(k1, oi_data, window=20, spot_klines=spot_k1)
```

**ä¿®æ”¹å**ï¼š
```python
# v7.2.36: å¯ç”¨ä¸¥æ ¼OIå¯¹é½ + metaæ”¶é›†
cvd_series, cvd_mix, cvd_meta = cvd_mix_with_oi_price(
    k1, oi_data,
    spot_klines=spot_k1,
    use_strict_oi_align=True,          # æ¡ä»¶2: å–å‰ä¸å–å
    oi_align_tolerance_ms=5000,        # é…ç½®å®¹å¿åº¦
    return_meta=True                   # è·å–metaä¿¡æ¯
)

# æ£€æŸ¥CVDè´¨é‡
if cvd_meta:
    if cvd_meta.get('degraded'):
        warn(f"âš ï¸  {symbol} CVDé™çº§: {cvd_meta.get('degrade_reason')}")
    oi_missing = cvd_meta.get('oi_missing_ratio', 0)
    if oi_missing > 0.1:
        warn(f"âš ï¸  {symbol} OIå¯¹é½ç¼ºå¤±ç‡ {oi_missing:.2%}")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… æ¡ä»¶2ï¼ˆå–å‰ä¸å–åï¼‰ç”Ÿæ•ˆ
- âœ… è·å–metaä¿¡æ¯ç”¨äºç›‘æ§

---

### 4.2 çŸ­æœŸæ”¹è¿›ï¼ˆP1 - Importantï¼‰

#### å»ºè®®3: æ·»åŠ é‡å¤æ—¶é—´æˆ³å¼‚å¸¸å¤„ç†

**æ–‡ä»¶**ï¼š`ats_core/pipeline/analyze_symbol.py`
**ä½ç½®**ï¼šç¬¬490è¡Œï¼ˆCVDè°ƒç”¨å¤„ï¼‰
**ä¿®æ”¹**ï¼š

```python
try:
    cvd_series, cvd_mix, cvd_meta = cvd_mix_with_oi_price(...)
except ValueError as e:
    if "é‡å¤openTime" in str(e):
        error(f"âŒ {symbol} Kçº¿æ•°æ®å¼‚å¸¸: {e}")
        # ä½¿ç”¨é›¶å¡«å……ä½œä¸ºfallback
        cvd_series = [0.0] * len(k1)
        cvd_mix = [0.0] * len(k1)
        cvd_meta = {"error": "duplicate_timestamp", "degraded": True}
    else:
        raise
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… é‡å¤æ—¶é—´æˆ³ä¸ä¼šå¯¼è‡´å´©æºƒ
- âœ… è®°å½•é”™è¯¯æ—¥å¿—ä¾¿äºæ’æŸ¥

---

#### å»ºè®®4: æ·»åŠ CVDè´¨é‡ç›‘æ§æ—¥å¿—

**æ–‡ä»¶**ï¼š`ats_core/pipeline/analyze_symbol.py`
**ä½ç½®**ï¼šCVDè®¡ç®—å
**ä¿®æ”¹**ï¼š

```python
# CVDè´¨é‡ç›‘æ§ï¼ˆv7.2.36ï¼‰
if cvd_meta:
    quality_metrics = {
        "degraded": cvd_meta.get('degraded', False),
        "degrade_reason": cvd_meta.get('degrade_reason', ''),
        "oi_missing_ratio": cvd_meta.get('oi_missing_ratio', 0),
        "mean_mix": cvd_meta.get('mean', 0),
        "std_mix": cvd_meta.get('std', 0),
    }

    # è®°å½•åˆ°æ€§èƒ½æŒ‡æ ‡ï¼ˆä¾¿äºç›‘æ§ï¼‰
    perf['CVDè´¨é‡'] = quality_metrics

    # æç«¯æƒ…å†µå‘Šè­¦
    if quality_metrics['oi_missing_ratio'] > 0.2:
        warn(f"âš ï¸  {symbol} OIæ•°æ®è´¨é‡å·®: ç¼ºå¤±ç‡{quality_metrics['oi_missing_ratio']:.2%}")
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… CVDè´¨é‡å¯è§‚æµ‹
- âœ… ä¾¿äºç°åº¦ä¸Šçº¿æ—¶ç›‘æ§

---

### 4.3 é•¿æœŸä¼˜åŒ–ï¼ˆP2 - Nice to Haveï¼‰

#### å»ºè®®5: å®æ–½imbalance_ratioç‰¹å¾å·¥ç¨‹

**èƒŒæ™¯**ï¼šæ¡ä»¶1ï¼ˆå°ºåº¦å¼‚æ–¹å·®å¯¹å†²ï¼‰å¼•å…¥äº†imbalance_ratioç‰¹å¾ï¼Œç†è®ºè¾¹ç•Œ[-1, 1]ï¼Œå¯ä½œä¸ºé¢å¤–ç‰¹å¾ã€‚

**å®æ–½æ–¹æ¡ˆ**ï¼š
```python
# åœ¨å› å­è®¡ç®—éƒ¨åˆ†æ·»åŠ 
if cvd_meta and cvd_meta.get('imbalance_ratios'):
    imbalance_ratios = cvd_meta['imbalance_ratios']

    # ç»Ÿè®¡ç‰¹å¾
    mean_imb = sum(imbalance_ratios[-96:]) / 96 if len(imbalance_ratios) >= 96 else 0
    std_imb = ...

    # å¯ä½œä¸ºCå› å­çš„è¾…åŠ©ç‰¹å¾
    # ä¾‹å¦‚ï¼šæŒç»­æ­£imbalance_ratio = å¼ºä¹°ç›˜ = Câ†‘
```

**ä¼˜å…ˆçº§**ï¼šä½ï¼ˆéœ€è¦å›æµ‹éªŒè¯æœ‰æ•ˆæ€§ï¼‰

---

#### å»ºè®®6: æ·»åŠ æ•°æ®å®Œæ•´æ€§æ ¡éªŒ

**å®æ–½**ï¼š
```python
def validate_kline_data(klines: List[List], symbol: str) -> bool:
    """v7.2.36: æ•°æ®å®Œæ•´æ€§æ ¡éªŒ"""
    if not klines:
        return False

    # æ£€æŸ¥åˆ—æ•°
    if len(klines[0]) < 12:
        error(f"âŒ {symbol} Kçº¿åˆ—æ•°ä¸è¶³: {len(klines[0])} < 12")
        return False

    # æ£€æŸ¥å…³é”®åˆ—éé›¶
    for i, k in enumerate(klines):
        if k[7] == 0:  # quoteAssetVolume
            warn(f"âš ï¸  {symbol} Kçº¿[{i}] quoteVol=0ï¼ˆå¼‚å¸¸ï¼‰")

    return True
```

**è°ƒç”¨ä½ç½®**ï¼šæ•°æ®è·å–åç«‹å³æ ¡éªŒ

---

## 5. æ€»ç»“ä¸å»ºè®®

### 5.1 æ•°æ®è·å–æ»¡è¶³åº¦è¯„åˆ†

| æ¨¡å— | æ»¡è¶³åº¦ | è¯´æ˜ |
|------|--------|------|
| åˆçº¦Kçº¿è·å– | âœ… 100% | å®Œæ•´12åˆ—ï¼Œæ ¼å¼æ­£ç¡® |
| OIå†å²è·å– | âœ… 100% | timestampç²¾åº¦æ»¡è¶³ |
| ç°è´§Kçº¿è·å– | âœ… 100% | æ ¼å¼æ­£ç¡®ï¼Œå¼‚å¸¸å¤„ç†å®Œå–„ |
| **æ•°æ®é›†æˆ** | âš ï¸ 70% | **å­˜åœ¨4ä¸ªgapéœ€ä¿®å¤** |
| **æ€»ä½“è¯„åˆ†** | âš ï¸ **85%** | **åŸºç¡€æ»¡è¶³ï¼Œéœ€è¡¥é½é›†æˆ** |

---

### 5.2 ç«‹å³è¡ŒåŠ¨å»ºè®®

**P0 - å¿…é¡»ä¿®å¤ï¼ˆé˜»å¡å…¨é¢ä¸Šçº¿ï¼‰**ï¼š
1. âœ… æ·»åŠ æœªæ”¶ç›˜Kçº¿è¿‡æ»¤ï¼ˆå»ºè®®1ï¼‰
2. âœ… æ›´æ–°CVDè°ƒç”¨å‚æ•°ï¼ˆå»ºè®®2ï¼‰

**P1 - çŸ­æœŸæ”¹è¿›ï¼ˆ1å‘¨å†…ï¼‰**ï¼š
3. âœ… æ·»åŠ é‡å¤æ—¶é—´æˆ³å¼‚å¸¸å¤„ç†ï¼ˆå»ºè®®3ï¼‰
4. âœ… æ·»åŠ CVDè´¨é‡ç›‘æ§æ—¥å¿—ï¼ˆå»ºè®®4ï¼‰

**P2 - é•¿æœŸä¼˜åŒ–ï¼ˆæŒ‰éœ€ï¼‰**ï¼š
5. â³ å®æ–½imbalance_ratioç‰¹å¾å·¥ç¨‹ï¼ˆå»ºè®®5ï¼‰
6. â³ æ·»åŠ æ•°æ®å®Œæ•´æ€§æ ¡éªŒï¼ˆå»ºè®®6ï¼‰

---

### 5.3 é£é™©è¯„ä¼°

| é£é™©é¡¹ | ä¸¥é‡ç¨‹åº¦ | å½“å‰çŠ¶æ€ | å»ºè®®ä¿®å¤ä¼˜å…ˆçº§ |
|--------|---------|---------|----------------|
| æœªæ”¶ç›˜Kçº¿æ±¡æŸ“ | ğŸ”´ é«˜ | âŒ æœªè¿‡æ»¤ | P0 |
| OIå¯¹é½ä¸ç²¾ç¡® | ğŸŸ¡ ä¸­ | âš ï¸ æœªå¯ç”¨strict | P0 |
| é‡å¤æ—¶é—´æˆ³å´©æºƒ | ğŸŸ¡ ä¸­ | âš ï¸ æœªæ•è· | P1 |
| Metaä¿¡æ¯ä¸¢å¤± | ğŸŸ¢ ä½ | âš ï¸ æœªæ”¶é›† | P1 |

---

### 5.4 éƒ¨ç½²é¡ºåºå»ºè®®

**é˜¶æ®µ1: ä»£ç ä¿®å¤**ï¼ˆé¢„è®¡1-2å°æ—¶ï¼‰
```bash
# 1. ä¿®æ”¹analyze_symbol.py
# 2. æ·»åŠ æœªæ”¶ç›˜è¿‡æ»¤
# 3. æ›´æ–°CVDè°ƒç”¨å‚æ•°
# 4. æ·»åŠ å¼‚å¸¸å¤„ç†
```

**é˜¶æ®µ2: æµ‹è¯•éªŒè¯**ï¼ˆé¢„è®¡30åˆ†é’Ÿï¼‰
```bash
# è¿è¡ŒéªŒæ”¶æµ‹è¯•
PYTHONPATH=/home/user/cryptosignal python3 tests/test_v7236_validation.py

# è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆå•å¸ç§ï¼‰
python3 -m ats_core.pipeline.analyze_symbol --symbol BTCUSDT --test
```

**é˜¶æ®µ3: ç°åº¦ä¸Šçº¿**ï¼ˆé¢„è®¡1å°æ—¶ï¼‰
```bash
# è§‚å¯ŸCVDè´¨é‡æŒ‡æ ‡
tail -f logs/scanner.log | grep "CVDè´¨é‡"

# ç›‘æ§é™çº§ç‡
grep "CVDé™çº§" logs/scanner.log | wc -l
```

---

## 6. é™„å½•

### 6.1 å®Œæ•´çš„CVDè°ƒç”¨ç¤ºä¾‹ï¼ˆv7.2.36æ ‡å‡†ï¼‰

```python
# ========== v7.2.36æ ‡å‡†è°ƒç”¨æµç¨‹ ==========
import time
from ats_core.sources.binance import get_klines, get_open_interest_hist, get_spot_klines
from ats_core.utils.cvd_utils import filter_unclosed_klines
from ats_core.features.cvd import cvd_mix_with_oi_price
from ats_core.config.threshold_config import get_thresholds

# 1. è·å–åŸå§‹æ•°æ®
symbol = "BTCUSDT"
k1 = get_klines(symbol, "1h", 300)
oi_data = get_open_interest_hist(symbol, "1h", 300)
try:
    spot_k1 = get_spot_klines(symbol, "1h", 300)
except Exception:
    spot_k1 = None

# 2. è¿‡æ»¤æœªæ”¶ç›˜Kçº¿ï¼ˆæ¡ä»¶5ï¼‰
config = get_thresholds()
safety_lag_ms = config.get('CVDè®¡ç®—å‚æ•°', {}).get('safety_lag_ms', 5000)
now_ms = int(time.time() * 1000)

k1, filtered_count = filter_unclosed_klines(k1, now_ms, safety_lag_ms)
if spot_k1:
    spot_k1, _ = filter_unclosed_klines(spot_k1, now_ms, safety_lag_ms)

# 3. CVDè®¡ç®—ï¼ˆå¯ç”¨v7.2.36å¢å¼ºï¼‰
try:
    cvd_series, cvd_mix, cvd_meta = cvd_mix_with_oi_price(
        k1, oi_data,
        spot_klines=spot_k1,
        use_strict_oi_align=True,      # æ¡ä»¶2: å–å‰ä¸å–å
        oi_align_tolerance_ms=5000,     # å®¹å¿åº¦
        return_meta=True                # è·å–meta
    )
except ValueError as e:
    if "é‡å¤openTime" in str(e):
        # é‡å¤æ—¶é—´æˆ³é™çº§å¤„ç†
        cvd_series = [0.0] * len(k1)
        cvd_mix = [0.0] * len(k1)
        cvd_meta = {"error": "duplicate_timestamp", "degraded": True}
    else:
        raise

# 4. è´¨é‡æ£€æŸ¥
if cvd_meta:
    if cvd_meta.get('degraded'):
        print(f"âš ï¸  CVDé™çº§: {cvd_meta.get('degrade_reason')}")

    oi_missing = cvd_meta.get('oi_missing_ratio', 0)
    if oi_missing > 0.1:
        print(f"âš ï¸  OIç¼ºå¤±ç‡: {oi_missing:.2%}")

    print(f"ğŸ“Š CVD Mix: å‡å€¼={cvd_meta['mean']:.2f}, æ ‡å‡†å·®={cvd_meta['std']:.2f}")
```

---

### 6.2 æ•°æ®æ ¼å¼é€ŸæŸ¥è¡¨

**åˆçº¦Kçº¿æ ¼å¼ï¼ˆ12åˆ—ï¼‰**ï¼š
```python
[
    1700000000000,  # [0] openTime (æ¯«ç§’)
    100.0,          # [1] open
    105.0,          # [2] high
    95.0,           # [3] low
    102.0,          # [4] close
    1000.0,         # [5] volume (Baseå•ä½)
    1700003599999,  # [6] closeTime (æ¯«ç§’) â† v7.2.36å…³é”®
    100000.0,       # [7] quoteAssetVolume (USDT) â† v7.2.36å…³é”®
    50,             # [8] numberOfTrades
    600.0,          # [9] takerBuyBaseVolume (Baseå•ä½)
    60000.0,        # [10] takerBuyQuoteVolume (USDT) â† v7.2.36å…³é”®
    0               # [11] ignore
]
```

**OIæ•°æ®æ ¼å¼**ï¼š
```python
{
    "symbol": "BTCUSDT",
    "sumOpenInterest": "1234.5",         # æŒä»“é‡ï¼ˆå¸æ•°é‡ï¼‰
    "sumOpenInterestValue": "123456.7",  # æŒä»“ä»·å€¼ï¼ˆUSDTï¼‰
    "timestamp": 1700000000000           # æ¯«ç§’æ—¶é—´æˆ³ â† v7.2.36å…³é”®
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ä½œè€…**: Claude (Anthropic)
**å®¡æ ¸**: CVD Technical Review Team
**ä¸‹æ¬¡å¤æ ¸**: ç°åº¦ä¸Šçº¿å1å‘¨
