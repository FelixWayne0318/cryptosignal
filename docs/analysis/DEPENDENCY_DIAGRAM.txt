
╔═══════════════════════════════════════════════════════════════════════════╗
║                    CODE DEPENDENCY ARCHITECTURE DIAGRAM                   ║
╚═══════════════════════════════════════════════════════════════════════════╝


LAYER 0: ENTRY POINT
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│                  setup.sh (Bash entry point)                            │
│                     │                                                   │
│       ┌─────────────┴──────────────┬──────────────┐                    │
│       │                            │              │                    │
│  init_databases.py         realtime_signal_scanner.py    auto_restart.sh │
│       │                            │                                   │
│       └────────┬─────────────────┬─┘                                   │
│                │                 │                                     │
│      ats_core.data.       RealtimeSignalScanner                        │
│      trade_recorder       class init & run_periodic()                  │
│      & analysis_db                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 1: MAIN SCANNER ORCHESTRATION
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│                         RealtimeSignalScanner                           │
│                       (realtime_signal_scanner.py)                      │
│                                                                           │
│  Key Methods:                                                           │
│  • scan_once() ────────┐                                               │
│  • run_periodic()      │                                               │
│  • initialize()        │                                               │
│                        ↓                                               │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 2: CORE PROCESSING MODULES
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │
│  │ OptimizedBatch   │  │ v7.2 Enhanced    │  │ Anti-Jitter      │    │
│  │ Scanner          │  │ Analysis         │  │ Deduplication    │    │
│  │ ═════════════════ │  │ ═════════════════ │  │ ═════════════════ │    │
│  │ WebSocket        │  │ analyze_symbol_  │  │ publishing/      │    │
│  │ batch scanning   │  │ v72.py           │  │ anti_jitter.py   │    │
│  │ (0 API calls)    │  │ - F_v2 calc      │  │ - Cooldown mgmt  │    │
│  │ - 200 symbols    │  │ - 4-gate eval    │  │ - Signal dedup   │    │
│  │ - 12-15 sec      │  │ - Confidence     │  │                  │    │
│  └──────────────────┘  │ - EV calc        │  └──────────────────┘    │
│                        │ - Probability    │                          │
│                        │ calibration      │                          │
│                        └──────────────────┘                          │
│                                                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │
│  │ Telegram         │  │ Trade Recorder   │  │ Analysis DB      │    │
│  │ Formatting       │  │ ═════════════════ │  │ ═════════════════ │    │
│  │ ═════════════════ │  │ data/trade_      │  │ data/analysis.db │    │
│  │ outputs/         │  │ history.db       │  │ - 7 professional │    │
│  │ telegram_fmt.py  │  │ - Signal         │  │ tables           │    │
│  │ - Format msgs    │  │ snapshots        │  │ - Market data    │    │
│  │ - v7.2 layout    │  │ - Trade results  │  │ - Factor scores  │    │
│  │ - HTML markup    │  │                  │  │ - Gate evaluation│    │
│  └──────────────────┘  └──────────────────┘  │ - Modulation     │    │
│                                              │ - Outcomes       │    │
│                                              └──────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 3: DATA & CALCULATION ENGINE
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  BATCH SCAN COMPONENTS:                                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│  │ Binance         │  │ Real-time       │  │ Symbol Analysis │        │
│  │ Connection      │  │ Kline Cache     │  │ ═════════════════ │        │
│  │ ═════════════════ │  │ ═════════════════ │  │ analyze_symbol.py │        │
│  │ binance_futures │  │ WebSocket       │  │ - Calc all      │        │
│  │ _client.py      │  │ data feed       │  │ factors         │        │
│  │ - REST API      │  │ - 1h/4h/1d      │  │ - Build scores  │        │
│  │ - Async client  │  │ - 100+ candles  │  │ - Apply gates   │        │
│  │ - Futures data  │  │ per symbol      │  │ - Risk calc     │        │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘        │
│         │                     │                     │                   │
│         └─────────────────────┴─────────────────────┘                   │
│                               │                                         │
│                        Data Quality Check                              │
│                    (data/quality.py)                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 4: FACTOR CALCULATION
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  TECHNICAL FACTORS:                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐     │
│  │ Basis & Funding  │  │ Independence     │  │ Accumulation     │     │
│  │ ═════════════════ │  │ Index            │  │ Detection        │     │
│  │ factors_v2/      │  │ ═════════════════ │  │ ═════════════════ │     │
│  │ basis_funding.py │  │ factors_v2/      │  │ features/        │     │
│  │ - Basis calc     │  │ independence.py  │  │ accumulation_    │     │
│  │ - Funding rate   │  │ - Indep. coeff   │  │ detection.py     │     │
│  │ - Trend score    │  │ - Correlation    │  │ - Accumulation   │     │
│  │                  │  │                  │  │ index            │     │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘     │
│                                                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐     │
│  │ CVD (Cumulative  │  │ Liquidity &      │  │ Multi-Timeframe  │     │
│  │ Volume Delta)    │  │ Price Band       │  │ Analysis         │     │
│  │ ═════════════════ │  │ ═════════════════ │  │ ═════════════════ │     │
│  │ features/cvd.py  │  │ features/        │  │ features/        │     │
│  │ - Volume Delta   │  │ liquidity_       │  │ multi_timeframe_ │     │
│  │ - Cumulative     │  │ priceband.py     │  │ py               │     │
│  │ - Trend          │  │ - Volatility     │  │ - 1h/4h/1d       │     │
│  │ - Divergence     │  │ - Support/resist │  │ - Cross-timeframe│     │
│  │                  │  │ - Liquidity      │  │ confirmation     │     │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 5: SCORING & PROBABILITY
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  SCORING PIPELINE:                                                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐     │
│  │ Base Probability │  │ Calibrated Prob  │  │ Adaptive Weights │     │
│  │ ═════════════════ │  │ ═════════════════ │  │ ═════════════════ │     │
│  │ scoring/         │  │ scoring/         │  │ scoring/         │     │
│  │ probability.py   │  │ probability_v2.py│  │ adaptive_weights │     │
│  │ - Raw factors    │  │ - Empirical calib│  │ .py              │     │
│  │ - Initial score  │  │ - Curve fitting  │  │ - Dynamic adjust │     │
│  │ - Weight apply   │  │ - Confidence     │  │ - Market regime  │     │
│  │                  │  │                  │  │ - Volatility adj │     │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘     │
│         │                     │                     │                   │
│         └─────────────────────┴─────────────────────┘                   │
│                               │                                         │
│                     Signal Scorecard                                   │
│                  (scoring/scorecard.py)                                │
│                   & Scoring Utilities                                  │
│                (scoring/scoring_utils.py)                              │
│                                                                         │
│  EXPECTED VALUE CALCULATION:                                           │
│  ┌──────────────────────────────────────────────────────────┐         │
│  │ EV = P_win * avg_win% - P_loss * avg_loss%              │         │
│  │ scoring/expected_value.py                                │         │
│  └──────────────────────────────────────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 6: GATE FILTERING
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  INTEGRATED GATE SYSTEM (v7.2 Four-Gate):                               │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                   gates/integrated_gates.py                      │  │
│  │                                                                  │  │
│  │  Gate 1: Probability Gate      Gate 3: Modulation Gate         │  │
│  │  ├─ P_calibrated check         ├─ Factor modulation            │  │
│  │  ├─ Against min threshold      ├─ Price band check             │  │
│  │  └─ Statistically sig.         └─ Risk modulation              │  │
│  │                                                                  │  │
│  │  Gate 2: Technical Gate        Gate 4: EV Gate                 │  │
│  │  ├─ Multi-timeframe confirm.   ├─ EV_net positive check        │  │
│  │  ├─ Volume confirmation        ├─ Risk/reward ratio            │  │
│  │  └─ Trend alignment            └─ Stop-loss calibration        │  │
│  │                                                                  │  │
│  │  Final Check: ALL_GATES_PASSED = TRUE                          │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  MODULATION EFFECTS:                                                    │
│  ┌─────────────────────────┐  ┌─────────────────────────┐             │
│  │ Factor Modulators       │  │ Modulator Chain         │             │
│  │ ═════════════════════════ │  │ ═════════════════════════ │             │
│  │ modulators/             │  │ modulators/             │             │
│  │ fi_modulators.py        │  │ modulator_chain.py      │             │
│  │ - Adjust factor weights │  │ - Combine modulators    │             │
│  │ - Market regime impact  │  │ - Apply final adjust    │             │
│  │ - Volatility impact     │  │ - Feed to gates         │             │
│  └─────────────────────────┘  └─────────────────────────┘             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 7: CONFIGURATION & UTILITIES
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  CONFIGURATION SYSTEM:                                                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐     │
│  │ Central Config   │  │ Anti-Jitter      │  │ Binance Source   │     │
│  │ ═════════════════ │  │ Config           │  │ ═════════════════ │     │
│  │ cfg.py           │  │ ═════════════════ │  │ sources/         │     │
│  │ - Global params  │  │ config/          │  │ binance.py       │     │
│  │ - Factor defs    │  │ anti_jitter_     │  │ - API wrapper    │     │
│  │ - Thresholds     │  │ config.py        │  │ - Rate limiting  │     │
│  │ - Factor values  │  │ - Cooldown cfg   │  │ - Error handling │     │
│  └──────────────────┘  │ - Time windows   │  └──────────────────┘     │
│                        │                  │                            │
│                        └──────────────────┘                            │
│                                                                         │
│  UTILITIES:                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐     │
│  │ Logging System   │  │ Backoff Retry    │  │ Outlier Detection│     │
│  │ ═════════════════ │  │ ═════════════════ │  │ ═════════════════ │     │
│  │ logging.py       │  │ backoff.py       │  │ utils/           │     │
│  │ - Unified logs   │  │ - Exponential    │  │ outlier_         │     │
│  │ - Colored output │  │ backoff          │  │ detection.py     │     │
│  │ - Trace & debug  │  │ - Max retries    │  │ - Filter noise   │     │
│  │                  │  │ - Jitter         │  │ - Statistical    │     │
│  └──────────────────┘  └──────────────────┘  │ filter           │     │
│                                              └──────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


LAYER 8: PERSISTENCE & OUTPUT
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  DATABASE PERSISTENCE:              OUTPUT SYSTEMS:                     │
│  ┌───────────────────────────┐      ┌────────────────────────────┐    │
│  │ data/trade_history.db     │      │ Telegram Formatting        │    │
│  │ ├─ signal_snapshots       │      │ ════════════════════════════ │    │
│  │ └─ trade_results          │      │ outputs/telegram_fmt.py    │    │
│  │                           │      │ - v7.2 message layout      │    │
│  │ data/analysis.db (7 tbl)  │      │ - HTML formatting          │    │
│  │ ├─ market_data            │      │ - F因子 display            │    │
│  │ ├─ factor_scores          │      │ - Confidence display       │    │
│  │ ├─ signal_analysis        │      │ - Gate status              │    │
│  │ ├─ gate_evaluation        │      │ - EV display               │    │
│  │ ├─ modulator_effects      │      │ - Telegram API send        │    │
│  │ ├─ signal_outcomes        │      │                            │    │
│  │ └─ scan_statistics        │      │ Reports & Statistics       │    │
│  │                           │      │ ════════════════════════════ │    │
│  │ Statistical Analysis      │      │ analysis/                  │    │
│  │ analysis/scan_statistics. │      │ scan_statistics.py         │    │
│  │ py (Global stats)         │      │ - Scan history             │    │
│  └───────────────────────────┘      │ - Signal counts            │    │
│                                     │ - Success rates            │    │
│                                     └────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


══════════════════════════════════════════════════════════════════════════════
DATAFLOW SUMMARY

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│ Binance WebSocket ──→ Kline Cache ──→ Symbol Analyzer ──→ Factor Calc  │
│ (Real-time 1h/4h/  (100 candles    (preloaded data)     (7 active      │
│  1d data)          per symbol)                           factors)       │
│                                                                │         │
│                                                                ↓         │
│                     ┌─────────────────────────────────────────────────┐ │
│                     │ Probability Calculation & Calibration           │ │
│                     │ (Base → Calibrated → Adaptive weights)          │ │
│                     └──────────────────────────────────────────────────┤ │
│                                                                         │ │
│   v7.2 Enhancements: F_v2 + EV + Confidence Scoring                  │ │
│                                                                         │ │
│   Four-Gate Filtering:                                                │ │
│   Gate 1 (Prob) → Gate 2 (Technical) → Gate 3 (Modulation)           │ │
│   → Gate 4 (EV) → all_gates_passed = TRUE                            │ │
│                                                                         │ │
│   Anti-Jitter Deduplication (Cooldown check)                         │ │
│                                                                         │ │
│   ↓ FINAL PRIME SIGNALS ↓                                            │ │
│                                                                         │ │
│   ├─ Record to trade_history.db                                       │ │
│   ├─ Write to analysis.db                                             │ │
│   ├─ Format as Telegram message (v7.2)                                │ │
│   └─ Send to Telegram API                                             │ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

