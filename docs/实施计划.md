# 改进版方案实施计划

## 🎯 目标：7基础维度 + F调节器

### 当前状态（旧版）
- T、A、S、V、O、E、F（7维）
- 问题：T有硬阈值、A包含CVD重叠、F参与评分导致重复

### 目标状态（改进版）
- **基础7维**：T、M、C、S、V、O、E（参与评分）
- **调节器**：F（调节概率，不参与评分）
- 所有维度软映射 + 多空对称

---

## 📋 实施步骤

### 第1步：修复T（趋势）维度 ✅ 进行中
**文件**：`ats_core/features/trend.py`

**改动**：
1. 添加 `side_long` 参数
2. 去除硬阈值（阶梯式加分）
3. 改用 `directional_score()` 软映射
4. 确保多空对称

**修改后的签名**：
```python
def score_trend(h, l, c, c4, cfg, side_long: bool) -> Tuple[int, int]:
    """
    返回 (T, Tm)
    - T : 0~100 趋势分（做多时上涨好，做空时下跌好）
    - Tm: -1(空) / 0(震荡) / 1(多)
    """
```

---

### 第2步：创建M（动量）维度
**文件**：`ats_core/features/momentum.py`（新建）

**功能**：从A（加速）中分离出价格动量部分
- 指标：30小时价格斜率变化
- **不包含CVD**（CVD移到C维度）
- 使用软映射
- 多空对称

**签名**：
```python
def score_momentum(c: List[float], side_long: bool, params: dict) -> Tuple[int, Dict]:
    """
    价格动量维度
    返回：(M分数, 元数据)
    """
```

---

### 第3步：创建C（CVD资金流）维度
**文件**：`ats_core/features/cvd_flow.py`（新建）

**功能**：从A（加速）中分离出CVD部分
- 指标：CVD 6小时变化
- 使用软映射
- 多空对称（做多时买压强好，做空时卖压强好）

**签名**：
```python
def score_cvd_flow(cvd_series: List[float], side_long: bool, params: dict) -> Tuple[int, Dict]:
    """
    CVD资金流维度
    返回：(C分数, 元数据)
    """
```

---

### 第4步：优化S（结构）维度
**文件**：`ats_core/features/structure_sq.py`

**改动**：
- 当前：线性加权组合
- 改进：使用sigmoid/tanh软映射

**保持签名不变**，只优化内部计算。

---

### 第5步：优化E（环境）维度
**文件**：`ats_core/features/environment.py`

**改动**：
- 当前：线性clamp映射
- 改进：使用sigmoid/tanh软映射

**保持签名不变**，只优化内部计算。

---

### 第6步：修改F维度角色
**文件**：`ats_core/pipeline/analyze_symbol.py`

**改动**：
- F不再参与基础评分
- F作为调节器影响最终概率

**概率计算改为**：
```python
# 基础评分（7维，不包含F）
base_score = weighted_average(T, M, C, S, V, O, E)
P_base = calc_probability(base_score)

# F 作为调节器
F = calc_fund_leading(...)
if F >= 70:
    P_final = P_base * 1.15  # 资金领先，提升
elif F >= 50:
    P_final = P_base
elif F >= 30:
    P_final = P_base * 0.9
else:
    P_final = P_base * 0.7  # 追高风险，降低
```

---

### 第7步：更新主流程
**文件**：`ats_core/pipeline/analyze_symbol.py`

**改动**：
1. 调用新的M、C维度
2. 调用修复后的T维度（传入side_long）
3. 计算7维基础分数
4. F作为调节器调整概率
5. 返回结果包含：
   - 7个基础维度分数
   - F的领先性分数
   - 调整前后概率

---

### 第8步：更新Telegram显示
**文件**：`ats_core/outputs/telegram_fmt.py`

**改动**：分组显示

```
🔹 BTCUSDT · 现价 98,500
📣 正式 · 🟩 做多 72% → 83% · 有效期8h

📊 资金面（领先指标）
• 持仓 🟢 75 (OI+5.8%) • 量能 🟢 72 (1.85×) • 资金流 🟢 70 (CVD+4.2%)
→ 资金动量：72.6 ✅

📈 价格面（滞后指标）
• 趋势 🟡 55 [多头] • 动量 🟢 68
→ 价格动量：50.4 ⚠️

🔍 技术面
• 结构 🟢 65 (θ=0.48) • 环境 🟢 60 (Chop=32)

⚡ 因果分析
资金领先价格+22 → 蓄势待发 ✅
概率调整：72% × 1.15 = 83%

#trade #BTCUSDT
```

---

### 第9步：更新配置文件
**文件**：`config/params.json`

**新的权重配置**：
```json
{
  "weights": {
    "T": 20,  // 趋势（提高，因为改进了）
    "M": 10,  // 动量（新，从A分离）
    "C": 10,  // CVD资金流（新，从A分离）
    "S": 10,  // 结构
    "V": 20,  // 量能（提高，重要性高）
    "O": 15,  // 持仓
    "E": 15   // 环境
    // F 不参与权重，作为调节器
  },

  "momentum": {
    "slope_lookback": 30,
    "slope_scale": 0.01,
    "slope_weight": 1.0
  },

  "cvd_flow": {
    "lookback_hours": 6,
    "cvd_scale": 0.02,
    "cvd_weight": 1.0
  }
}
```

---

### 第10步：测试验证
1. 运行 `test_F_display.py` 验证新格式
2. 测试真实市场数据（BTCUSDT、ETHUSDT）
3. 验证多空对称性
4. 验证F调节器效果

---

## 📊 预期效果对比

| 特性 | 旧版 | 改进版 |
|------|------|--------|
| 硬阈值 | T有硬阈值 | ✅ 全部软映射 |
| 多空对称 | T不对称 | ✅ 完全对称 |
| 信息冗余 | CVD重复显示 | ✅ 无冗余 |
| 因果体现 | 不明显 | ✅ 非常清晰 |
| 防追高 | 不直观 | ✅ 直观展示 |
| 概率调整 | 不可见 | ✅ 72% → 83% 可见 |

---

## 🚀 开始实施

现在开始第1步：修复T（趋势）维度
