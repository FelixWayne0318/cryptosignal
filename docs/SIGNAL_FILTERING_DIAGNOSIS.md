# 信号过滤诊断报告

## 问题概述

用户报告系统没有发送信号，需要诊断原因：
1. 是否因为过滤条件太高？
2. 是否每次只发送一个信号？

## 诊断工具

创建了专用诊断脚本：`scripts/diagnose_v72_gates.py`

运行方法：
```bash
cd ~/cryptosignal
python3 scripts/diagnose_v72_gates.py
```

## 诊断结果

### 问题1：无信号的根本原因

**结论**：✅ **基础层阈值过高**，不是v7.2闸门的问题

#### 数据证据

扫描结果（443个币种）：
- ✅ Prime信号: **0个**
- ❌ 被拒绝: **443个** (100%)

拒绝原因分布：
- Edge不足: 98.2% (435个)
- 置信度不足: 97.1% (430个)
- 概率过低: 90.1% (399个)
- Prime强度不足: 84.4% (374个)

接近阈值的币种：
- 84个币种P接近0.45
- 差值范围: 0.000 ~ 0.022
- 示例: 42USDT (P=0.450), EDENUSDT (P=0.450)

#### 配置分析

**基础层阈值**（`config/signal_thresholds.json`）：
```json
"mature_coin": {
  "confidence_min": 60,      // ❌ 太高！实际18-22
  "edge_min": 0.48,          // ❌ 太高！实际<0.30
  "prime_prob_min": 0.68     // ❌ 太高！实际≈0.45
}
```

**v7.2闸门阈值**：
```json
"gate4_probability": {
  "P_min": 0.45              // ✅ 合理（已优化）
}
"gate2_fund_support": {
  "F_min": -50               // ✅ 合理（已放宽）
}
```

#### 问题链路

```
扫描443个币种
    ↓
基础层过滤（mature_coin阈值太高）
    ↓
通过: 0个 ❌  <- 问题在这里！
    ↓
v7.2五道闸门
    ↓
最终信号: 0个
```

---

### 问题2：是否每次只发送1个信号？

**结论**：✅ **是的**，这是设计特性

#### 代码位置

`scripts/realtime_signal_scanner.py:372-373`

```python
# 只发送Top 1信号
top_signal = sorted_signals[0]
```

#### 设计理念

文档注释（第348-352行）：
```python
v3.1优化：每次只发送Top 1最优信号（按confidence_adjusted排序）
- 避免信息过载
- 聚焦最优质信号
- 降低决策疲劳
- 其他信号参与下一轮竞争
```

#### 排序逻辑

按 `confidence_adjusted` 降序排序：
- 包含I×Market调整
- 选择调整后信心度最高的信号

#### 未发送信号的处理

```python
# 记录跳过的信号（参与下一轮竞争）
if len(sorted_signals) > 1:
    log(f"\n   ⏭️  跳过 {len(sorted_signals) - 1} 个信号（等待下一轮）：")
```

---

## 解决方案

### 方案1：降低基础层阈值（✅ 已实施）

**修改文件**：`config/signal_thresholds.json`

**修改内容**：
```json
"mature_coin": {
  "prime_strength_min": 35,   // 从54降到35
  "confidence_min": 20,        // 从60降到20
  "edge_min": 0.15,            // 从0.48降到0.15
  "prime_prob_min": 0.45,      // 从0.68降到0.45
  "dims_ok_min": 3,            // 从4降到3
  "prime_dim_threshold": 50    // 从65降到50
}
```

**设计理念**：
- 基础层：初步过滤（放宽阈值）
- v7.2层：质量控制（五道闸门）
- 分层过滤，各司其职

**预期效果**：
- 基础层通过: 0个 → 100-150个
- v7.2通过: 0个 → 30-50个
- 最终发送: 0个 → 1个/次（Top 1）

---

### 方案2：调整Top 1策略（可选）

如果希望每次发送多个信号：

**修改文件**：`scripts/realtime_signal_scanner.py`

**修改位置**：第372-380行

**修改前**：
```python
# 只发送Top 1信号
top_signal = sorted_signals[0]
```

**修改后（示例：Top 3）**：
```python
# 发送Top 3信号
top_signals = sorted_signals[:3]

for top_signal in top_signals:
    # 发送逻辑...
```

**建议**：
- 保持Top 1策略，避免信息过载
- 如需更多信号，可调整为Top 2或Top 3
- 不建议超过Top 5

---

## 测试验证

### 配置验证

```bash
python3 << 'EOF'
import json
with open('config/signal_thresholds.json') as f:
    config = json.load(f)
mature = config['基础分析阈值']['mature_coin']
print(f"confidence_min: {mature['confidence_min']}")  # 应为20
print(f"edge_min: {mature['edge_min']}")              # 应为0.15
print(f"prime_prob_min: {mature['prime_prob_min']}")  # 应为0.45
EOF
```

### 重新运行诊断

修改后重启系统，然后重新运行诊断：

```bash
cd ~/cryptosignal
bash restart_system.sh

# 等待一次扫描完成（约5分钟）

python3 scripts/diagnose_v72_gates.py
```

预期结果：
- Prime信号: 30-50个
- 拒绝率: 大幅下降

---

## 架构说明

### 双层过滤设计

```
┌─────────────────────────────────────────────┐
│           扫描层（443个币种）                │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│    基础层过滤（初步筛选）                   │
│    - confidence_min: 20                     │
│    - edge_min: 0.15                         │
│    - prime_prob_min: 0.45                   │
│    通过: ~100-150个                         │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│    v7.2五道闸门（质量控制）                 │
│    Gate1: 数据质量 (min_klines >= 100)     │
│    Gate2: 资金支撑 (F >= -50)               │
│    Gate3: 期望值 (EV >= 0.0)                │
│    Gate4: 概率 (P >= 0.45)                  │
│    Gate5: 独立性 (I >= 30)                  │
│    通过: ~30-50个                           │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│    Top 1策略（聚焦最优）                    │
│    按confidence_adjusted排序                │
│    发送: 1个/次                             │
└─────────────────────────────────────────────┘
```

### 设计优势

1. **分层负责**：基础层初筛，v7.2层质控
2. **可调优**：两层阈值独立调整
3. **质量保证**：五道闸门多维度验证
4. **用户友好**：Top 1策略避免信息过载

---

## 历史背景

### 为什么之前阈值这么高？

**原因**：
- 基础层设计时考虑的是单层过滤
- 阈值设置为"最终发送标准"
- v7.2引入后变成了双层过滤
- 两层都用高标准 → 过度过滤

### v7.2架构调整

**修改前**：
- 基础层：高标准（confidence_min=60）
- v7.2层：高标准（P_min=0.50）
- 结果：0个信号 ❌

**修改后**：
- 基础层：低标准（confidence_min=20）- 初筛
- v7.2层：中标准（P_min=0.45）- 质控
- 结果：预计30-50个信号 ✅

---

## 监控指标

修改后应监控以下指标：

### 信号数量
- 基础层通过: 100-150个
- v7.2通过: 30-50个
- 最终发送: 1个/次

### 信号质量
- P（概率）: 0.45-0.60
- Confidence: 20-40
- Edge: 0.15-0.30

### 拒绝率
- 基础层拒绝率: ~65%（从100%改善）
- v7.2拒绝率: ~70%（正常）

---

## 常见问题

### Q1: 会不会降低信号质量？

**A**: 不会。质量控制已移至v7.2五道闸门：
- Gate4仍要求P>=0.45
- Gate2仍要求F>=-50
- Gate3仍要求EV>=0.0
- 五道闸门全部通过才发送

### Q2: 为什么不直接关闭基础层过滤？

**A**: 基础层过滤有其作用：
- 过滤掉明显低质量信号
- 减少v7.2层计算量
- 分层设计更灵活

### Q3: 如果仍然没有信号怎么办？

**A**: 进一步降低v7.2闸门阈值：
```json
"gate4_probability": {
  "P_min": 0.40    // 从0.45降到0.40
}
```

---

## 相关文档

- `THRESHOLD_ADJUSTMENT.md` - v7.2闸门阈值调整说明
- `TELEGRAM_CONFIG.md` - Telegram通知配置
- `scripts/diagnose_v72_gates.py` - 诊断工具

---

**创建时间**: 2025-11-10
**问题严重级别**: P1 (High) - 影响核心功能
**解决状态**: ✅ 已修复
**修复提交**: commit [待提交]
