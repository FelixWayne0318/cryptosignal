# 代码体检快速检查清单

**使用说明**: 复制此清单到体检报告中，逐项打勾 ✅ 或标记问题 ❌

**适用场景**:
- ⚡ **10 分钟版**: 快速健康检查、PR 前自查
- 📋 **完整版**: 子系统重构后、上线前审查

---

## ⚡ 10 分钟快速检查清单

**目标**: 快速发现 P0 级硬伤

### 1. 核心算法检查（2 分钟）

- [ ] **公式/逻辑正确性**: 核心算法实现与设计文档/数学公式一致？
  - 文件: `_______________`
  - 函数: `_______________`
  - 检查结果: ✅ / ❌ [问题描述]

- [ ] **数据对齐**: 多个序列（时间序列、价格序列）是否正确对齐？
  - 检查: 是否有时间戳对齐逻辑？
  - 检查结果: ✅ / ❌ [问题描述]

### 2. 接口匹配检查（3 分钟）

- [ ] **函数签名**: 函数定义与调用端的参数列表一致？
  - 定义: `def func(param1, param2)` → 调用: `func(arg1, arg2)`
  - 检查结果: ✅ / ❌ [不匹配的参数]

- [ ] **返回值**: 返回值数量和类型一致？
  - 定义: `return (val1, val2)` → 调用: `v1, v2 = func()`
  - 检查结果: ✅ / ❌ [不匹配详情]

### 3. 边界条件检查（2 分钟）

- [ ] **空输入处理**: 输入为空/None 时是否有保护？
  - 检查: `if input is None: return default_value`
  - 检查结果: ✅ / ❌ [缺失位置]

- [ ] **极端值处理**: 0/Inf/NaN 是否有防护？
  - 检查: `np.clip()`, `np.maximum()`, `eps` 保护
  - 检查结果: ✅ / ❌ [缺失位置]

### 4. 配置管理检查（2 分钟）

- [ ] **无新增硬编码**: 新代码中无业务常量硬编码？
  - 检查: 是否有 `param = 0.6` 这样的赋值？
  - 检查结果: ✅ / ❌ [硬编码位置]

### 5. 错误处理检查（1 分钟）

- [ ] **异常捕获**: 关键操作有 try-except？
  - 检查: 回归计算、配置加载等关键路径
  - 检查结果: ✅ / ❌ [缺失位置]

- [ ] **日志记录**: 异常时有 logger.warning/error？
  - 检查结果: ✅ / ❌ [缺失位置]

---

**快速检查结论**:
- 发现 P0 问题: ____ 个
- 发现 P1 问题: ____ 个
- 建议: ⚠️ 需要完整体检 / ✅ 健康状况良好

---

## 📋 完整版检查清单（2 小时）

### Step 1: 核心实现检查（30 分钟）

#### 1.1 算法实现正确性

- [ ] **数学公式**: 算法实现与设计文档中的公式完全一致？
  - 设计公式: `_________________`
  - 代码实现: (文件 + 行号) `_________________`
  - 检查结果: ✅ / ❌ / ⚠️ 部分偏差

- [ ] **数据预处理**: log-return、归一化等预处理步骤正确？
  - 检查: `log(P_t / P_{t-1})` vs `(P_t - P_{t-1}) / P_{t-1}`
  - 检查结果: ✅ / ❌

- [ ] **数值稳定性**: 是否有 epsilon 保护防止除零、log(0) 等？
  - 检查位置: `_________________`
  - 检查结果: ✅ / ❌

#### 1.2 数据流完整性

- [ ] **输入验证**: 函数开头是否验证输入有效性？
  - 检查: `if len(data) < min_points: return ...`
  - 检查结果: ✅ / ❌

- [ ] **中间状态**: 关键中间变量是否有合理范围检查？
  - 示例: `r2 = max(0, 1 - ss_res/ss_tot)` 确保 R² ∈ [0, 1]
  - 检查结果: ✅ / ❌

- [ ] **输出验证**: 返回值是否在预期范围内？
  - 示例: `I_score = int(np.clip(I_raw, 0, 100))`
  - 检查结果: ✅ / ❌

#### 1.3 边界条件处理

- [ ] **空输入**: `if data is None or len(data) == 0: ...`
  - 检查结果: ✅ / ❌ [缺失位置]

- [ ] **数据不足**: `if len(data) < min_required: return neutral_value`
  - 检查结果: ✅ / ❌

- [ ] **极端值**: `np.clip()`, `np.maximum()`, `eps` 保护
  - 检查结果: ✅ / ❌

- [ ] **异常序列**: 全常数、全 NaN 等异常序列的处理？
  - 检查: `if std == 0: ...`
  - 检查结果: ✅ / ❌

#### 1.4 返回值匹配

- [ ] **返回值类型**: 实际返回类型与类型注解一致？
  - 类型注解: `-> Tuple[int, Dict[str, Any]]`
  - 实际返回: `return int_value, dict_value`
  - 检查结果: ✅ / ❌

- [ ] **返回值数量**: 所有路径返回值数量一致？
  - 正常路径: `return I, meta` (2 个)
  - 异常路径: `return 50, {}` (2 个)
  - 检查结果: ✅ / ❌

- [ ] **元数据完整性**: metadata 包含必需字段？
  - 必需字段: `status, n_points, ...`
  - 检查结果: ✅ / ❌

---

### Step 2: 调用链检查（30 分钟）

#### 2.1 调用参数匹配

- [ ] **参数数量**: 调用端传入的参数数量与函数签名一致？
  - 定义: `def func(a, b, c=None)`
  - 调用: `func(x, y)` 或 `func(x, y, z)`
  - 检查结果: ✅ / ❌

- [ ] **参数顺序**: 位置参数顺序正确？
  - 检查: 第 1 个参数对应、第 2 个参数对应...
  - 检查结果: ✅ / ❌

- [ ] **参数类型**: 传入参数类型与期望类型一致？
  - 示例: 期望 `np.ndarray`，传入 `List[float]`
  - 检查结果: ✅ / ❌ [需要类型转换]

#### 2.2 返回值解构正确

- [ ] **解构数量**: 解构的变量数量与返回值数量一致？
  - 返回: `return val1, val2` (2 个)
  - 解构: `v1, v2 = func()` (2 个)
  - 检查结果: ✅ / ❌ **← P0 关键检查**

- [ ] **变量命名**: 解构后的变量名与语义一致？
  - 示例: `I_score, I_meta = score_independence(...)` ✅
  - 反例: `x, y = score_independence(...)` ❌
  - 检查结果: ✅ / ⚠️ 可读性问题

#### 2.3 类型转换无误

- [ ] **List ↔ np.ndarray**: 是否有必要的类型转换？
  ```python
  # 如果函数期望 np.ndarray，调用端需要转换
  data_np = np.array(data_list, dtype=float)
  result = func(data_np)
  ```
  - 检查结果: ✅ / ❌

- [ ] **int ↔ float**: 整数/浮点数转换是否正确？
  - 检查结果: ✅ / ❌

#### 2.4 错误传播正确

- [ ] **异常传播**: 下游异常是否正确传播到上游？
  - 检查: 是否有过度捕获（如 `except Exception: pass`）
  - 检查结果: ✅ / ❌

- [ ] **状态码传播**: metadata 中的 status 是否正确传递？
  - 示例: `if meta['status'] != 'ok': ...`
  - 检查结果: ✅ / ❌

---

### Step 3: 配置管理检查（30 分钟）

#### 3.1 配置文件存在性

- [ ] **numeric_stability.json**: 存在且结构完整？
  - 路径: `config/numeric_stability.json`
  - 必需字段: `eps_var_min, eps_log_price, ...`
  - 检查结果: ✅ / ❌ / ⚠️ 缺少字段

- [ ] **factor_ranges.json**: 存在且结构完整？
  - 路径: `config/factor_ranges.json`
  - 必需字段: `min, max, neutral, ...`
  - 检查结果: ✅ / ❌ / ⚠️

- [ ] **logging.json**: 存在且结构完整？
  - 路径: `config/logging.json`
  - 必需字段: `decimals, fallback, ...`
  - 检查结果: ✅ / ❌ / ⚠️

- [ ] **[其他配置文件]**: 存在？
  - 路径: `_________________`
  - 检查结果: ✅ / ❌

#### 3.2 配置加载器可用

- [ ] **RuntimeConfig 类**: 存在且方法齐全？
  - 文件: `ats_core/config/runtime_config.py`
  - 方法: `get_numeric_stability()`, `get_factor_range()`, ...
  - 检查结果: ✅ / ❌

- [ ] **配置缓存**: 是否有缓存机制避免重复加载？
  - 检查: `_numeric_stability = None` + 懒加载
  - 检查结果: ✅ / ❌ / 不适用

- [ ] **配置校验**: 加载时是否校验配置格式？
  - 检查: `_validate_numeric_stability()` 等方法
  - 检查结果: ✅ / ❌

#### 3.3 魔法数字已配置化

**扫描方法**: 使用 `grep` 或 IDE 搜索以下模式：

- [ ] **浮点数阈值**: `0.6`, `0.9`, `1.2`, `1.5` 等
  - 扫描文件: `_________________`
  - 发现硬编码: Line ___, Line ___, ...
  - 检查结果: ✅ 全部配置化 / ❌ 仍有硬编码

- [ ] **整数参数**: `16`, `24`, `48` 等（样本数、窗口大小）
  - 发现硬编码: Line ___, Line ___, ...
  - 检查结果: ✅ / ❌

- [ ] **epsilon 值**: `1e-10`, `1e-12` 等
  - 发现硬编码: Line ___, Line ___, ...
  - 检查结果: ✅ / ⚠️ 仅在降级默认值中（可接受）

- [ ] **百分比/分数**: `0.5`, `0.8`, `100`, `50` 等
  - 发现硬编码: Line ___, Line ___, ...
  - 检查结果: ✅ / ❌

**魔法数字扫描结果汇总**:
| 文件 | 行号 | 数字 | 用途 | 状态 |
|------|------|------|------|------|
| `___` | Line ___ | `___` | `___` | ✅ 已配置 / ❌ 硬编码 / ⚠️ 降级默认值 |

#### 3.4 降级处理完善

- [ ] **配置加载失败**: 有合理的默认值？
  ```python
  try:
      config = RuntimeConfig.get_config()
  except Exception:
      config = DEFAULT_CONFIG  # ← 降级
  ```
  - 检查结果: ✅ / ❌

- [ ] **配置缺失字段**: 使用 `.get(key, default)` 而非直接索引？
  ```python
  # ✅ 安全
  value = config.get("key", default_value)

  # ❌ 不安全
  value = config["key"]  # KeyError if missing
  ```
  - 检查结果: ✅ / ❌

---

### Step 4: 错误处理和稳定性检查（30 分钟）

#### 4.1 异常捕获合理

- [ ] **精确捕获**: 捕获具体异常类型，而非泛化 `Exception`？
  ```python
  # ✅ 精确
  try:
      ...
  except (ValueError, ZeroDivisionError) as e:
      ...

  # ❌ 过于宽泛
  try:
      ...
  except Exception:
      pass  # 隐藏了真实问题
  ```
  - 检查结果: ✅ / ❌ [过度捕获位置]

- [ ] **不过度捕获**: 不捕获不应该捕获的异常？
  - 示例: `KeyboardInterrupt`, `SystemExit` 不应被捕获
  - 检查结果: ✅ / ❌

#### 4.2 日志记录充分

- [ ] **异常日志**: 异常时记录 warning/error？
  ```python
  except ValueError as e:
      logger.warning(f"计算失败: {e}")  # ← 必需
  ```
  - 检查结果: ✅ / ❌

- [ ] **关键路径日志**: 重要分支有 info 日志？
  - 示例: 配置加载成功、降级处理触发等
  - 检查结果: ✅ / ❌

- [ ] **调试信息**: debug 级别日志包含足够上下文？
  - 示例: `logger.debug(f"Beta计算: n_points={n}, r2={r2:.3f}")`
  - 检查结果: ✅ / ⚠️ 不够详细

#### 4.3 降级策略存在

- [ ] **关键依赖失败**: 外部依赖失败时有备用方案？
  - 示例: BTC K线获取失败 → 使用缓存/返回中性值
  - 检查结果: ✅ / ❌

- [ ] **数据质量降级**: 数据不足时返回中性值/默认值？
  - 示例: `if n_points < min_points: return neutral_value`
  - 检查结果: ✅ / ❌

#### 4.4 边界检查完整

- [ ] **数组越界**: 索引前检查长度？
  ```python
  if len(data) > index:
      value = data[index]
  ```
  - 检查结果: ✅ / ❌

- [ ] **除零保护**: 除法前检查分母非零？
  ```python
  result = numerator / (denominator + eps)  # ← eps 保护
  ```
  - 检查结果: ✅ / ❌

- [ ] **NaN/Inf 检查**: 浮点运算后检查有效性？
  ```python
  if math.isnan(result) or math.isinf(result):
      result = fallback_value
  ```
  - 检查结果: ✅ / ❌

---

## 体检结果汇总

### 发现的问题统计

| 优先级 | 数量 | 问题列表 |
|--------|------|---------|
| **P0 Critical** | ___ | [问题 1], [问题 2], ... |
| **P1 High** | ___ | [问题 1], [问题 2], ... |
| **P2 Medium** | ___ | [问题 1], [问题 2], ... |
| **P3 Low** | ___ | [问题 1], [问题 2], ... |

### 零硬编码达成度

- **已配置化**: ____%
- **仍硬编码**: ____ 个参数/常量

### 总体健康评分

- 🟢 **健康** (90-100%): 仅有 P3 问题或无问题
- 🟡 **一般** (70-89%): 有 P2 问题，无 P0/P1
- 🟠 **需要关注** (50-69%): 有 P1 问题
- 🔴 **不健康** (<50%): 有 P0 问题或大量 P1 问题

**本次评分**: ___ / 100 → 🟢 / 🟡 / 🟠 / 🔴

### 下一步行动

1. **立即修复** (P0): [列出 P0 问题]
2. **本周修复** (P1): [列出 P1 问题]
3. **下个迭代** (P2): [列出 P2 问题]

---

**检查完成时间**: YYYY-MM-DD HH:MM
**检查工程师**: __________
