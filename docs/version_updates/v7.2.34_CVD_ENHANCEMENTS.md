# v7.2.34 CVDè®¡ç®—å¢å¼º

**å‘å¸ƒæ—¥æœŸ**: 2025-11-12
**ä¼˜å…ˆçº§**: P1-Important + P2-Normal
**æ€»è€—æ—¶**: ~2.5å°æ—¶

---

## å¢å¼ºå†…å®¹æ¦‚è§ˆ

| # | å¢å¼ºé¡¹ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---|--------|--------|------|
| 1 | openTimeå¯¹é½æ£€æŸ¥ï¼ˆé˜²æ­¢ç°è´§/åˆçº¦Kçº¿é”™ä½ï¼‰ | ğŸ”´ P1 | âœ… å·²å®Œæˆ |
| 2 | æ»šåŠ¨Zæ ‡å‡†åŒ–ï¼ˆé¿å…å‰è§†åå·®ï¼‰ | ğŸ”´ P1 | âœ… å·²å®Œæˆ |
| 3 | Quote CVDæ”¯æŒï¼ˆUSDTå•ä½ï¼Œæ›´å‡†ç¡®åæ˜ èµ„é‡‘æµï¼‰ | ğŸŸ¡ P2 | âœ… å·²å®Œæˆ |
| 4 | ç¼ºå¤±/æå€¼å®¹é”™ï¼ˆä½æˆäº¤é¢é™æƒï¼‰ | ğŸŸ¡ P2 | âœ… å·²å®Œæˆ |
| 5 | å·¥å…·å‡½æ•°æ²‰æ·€ï¼ˆä»£ç è§„èŒƒåŒ–ï¼‰ | ğŸŸ¡ P2 | âœ… å·²å®Œæˆ |

---

## å¢å¼ºè¯¦æƒ…

### 1. openTimeå¯¹é½æ£€æŸ¥ï¼ˆP1-Importantï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼š
- ç°è´§å’Œåˆçº¦Kçº¿å¯èƒ½å› æ—¶é—´ä¸åŒæ­¥å¯¼è‡´é”™ä½
- åŸå®ç°å‡è®¾ä¸¤è€…Kçº¿æ•°é‡ç›¸åŒï¼Œç›´æ¥æŒ‰ç´¢å¼•é…å¯¹
- å®é™…åœºæ™¯ä¸­å¯èƒ½å‡ºç°ï¼š
  - ç°è´§Kçº¿ç¼ºå¤±ï¼ˆä½æµåŠ¨æ€§å¸ç§ï¼‰
  - åˆçº¦Kçº¿ç¼ºå¤±ï¼ˆæ–°ä¸Šçº¿åˆçº¦ï¼‰
  - æ—¶é—´æˆ³ä¸å¯¹é½ï¼ˆAPIè¿”å›å»¶è¿Ÿï¼‰

**é£é™©è¯„ä¼°**ï¼š
```
ç¤ºä¾‹ï¼šç°è´§ç¼ºå¤±ç¬¬2æ ¹Kçº¿
åˆçº¦Kçº¿: [t1, t2, t3, t4]
ç°è´§Kçº¿: [t1, t3, t4]     (ç¼ºå¤±t2)

åŸé€»è¾‘ï¼ˆæŒ‰ç´¢å¼•é…å¯¹ï¼‰ï¼š
  é…å¯¹: (t1,t1), (t2,t3), (t3,t4), (t4,None)
  ç»“æœ: âŒ t2åˆçº¦ vs t3ç°è´§ï¼ˆæ—¶é—´é”™ä½ï¼‰

æ–°é€»è¾‘ï¼ˆopenTimeå¯¹é½ï¼‰ï¼š
  é…å¯¹: (t1,t1), (t3,t3), (t4,t4)
  ç»“æœ: âœ… åªä¿ç•™æ—¶é—´åŒ¹é…çš„Kçº¿
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ–°å¢å·¥å…·å‡½æ•° `align_klines_by_open_time` å®ç°inner joinå¯¹é½
- åŸºäºopenTimeï¼ˆç¬¬0åˆ—ï¼‰ä½œä¸ºä¸»é”®
- è¿”å›å¯¹é½åçš„Kçº¿å’Œä¸¢å¼ƒæ•°é‡
- é…ç½®åŒ–ä¸¢å¼ƒç‡é˜ˆå€¼ï¼ˆmax_discard_ratio: 0.1%ï¼‰

**ä»£ç å˜æ›´**ï¼š
```python
# ats_core/utils/cvd_utils.py (NEW)
def align_klines_by_open_time(
    futures_klines: Sequence[Sequence],
    spot_klines: Sequence[Sequence]
) -> Tuple[List[List], List[List], int]:
    """
    åŸºäºopenTimeå¯¹é½ç°è´§å’Œåˆçº¦Kçº¿ï¼ˆinner joinï¼‰

    Returns:
        (aligned_futures, aligned_spot, discarded_count)
    """
    f_times = {int(k[0]): list(k) for k in futures_klines}
    s_times = {int(k[0]): list(k) for k in spot_klines}

    # Inner joinï¼šåªä¿ç•™ä¸¤è¾¹éƒ½æœ‰çš„æ—¶é—´æˆ³
    common_times = sorted(set(f_times.keys()) & set(s_times.keys()))

    aligned_f = [f_times[t] for t in common_times]
    aligned_s = [s_times[t] for t in common_times]
    discarded = len(futures_klines) + len(spot_klines) - 2 * len(common_times)

    return aligned_f, aligned_s, discarded
```

```python
# ats_core/features/cvd.py - cvd_combinedä¿®æ”¹
def cvd_combined(
    futures_klines: Sequence[Sequence],
    spot_klines: Sequence[Sequence] = None,
    use_dynamic_weight: bool = True,
    use_quote: bool = True,              # v7.2.34æ–°å¢
    min_total_quote: float = 100000,     # v7.2.34æ–°å¢
    max_discard_ratio: float = 0.001     # v7.2.34æ–°å¢
) -> List[float]:
    """v7.2.34å¢å¼ºï¼šopenTimeå¯¹é½ + æˆäº¤é¢å®¹é”™"""
    from ats_core.utils.cvd_utils import align_klines_by_open_time

    # P1: openTimeå¯¹é½æ£€æŸ¥
    aligned_f, aligned_s, discarded = align_klines_by_open_time(
        futures_klines, spot_klines
    )

    if not aligned_f:
        warn("âš ï¸  ç°è´§/åˆçº¦Kçº¿æ—¶é—´å®Œå…¨ä¸åŒ¹é…ï¼Œåªä½¿ç”¨åˆçº¦CVD")
        return cvd_from_klines(futures_klines, use_quote=use_quote)

    # æ£€æŸ¥ä¸¢å¼ƒç‡
    total = len(futures_klines) + len(spot_klines)
    discard_ratio = discarded / total if total > 0 else 0
    if discard_ratio > max_discard_ratio:
        warn(f"âš ï¸  Kçº¿å¯¹é½ä¸¢å¼ƒ{discarded}æ ¹ï¼ˆ{discard_ratio:.2%}ï¼‰")

    # ä½¿ç”¨å¯¹é½åçš„Kçº¿è®¡ç®—CVD
    cvd_f = cvd_from_klines(aligned_f, use_quote=use_quote)
    cvd_s = cvd_from_spot_klines(aligned_s, use_quote=use_quote)
    # ... åç»­ç»„åˆé€»è¾‘
```

**é…ç½®å‚æ•°**ï¼ˆconfig/signal_thresholds.jsonï¼‰ï¼š
```json
"CVDè®¡ç®—å‚æ•°": {
    "max_discard_ratio": 0.001  // æœ€å¤§ä¸¢å¼ƒç‡0.1%ï¼Œè¶…è¿‡åˆ™è­¦å‘Š
}
```

---

### 2. æ»šåŠ¨Zæ ‡å‡†åŒ–ï¼ˆP1-Importantï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼š
- åŸå®ç°ä½¿ç”¨å…¨å±€Z-scoreï¼š`z = (x - mean(all)) / std(all)`
- å­˜åœ¨**å‰è§†åå·®**ï¼šä½¿ç”¨æœªæ¥æ•°æ®çš„ç»Ÿè®¡é‡æ ‡å‡†åŒ–å½“å‰å€¼
- å¯¼è‡´å›æµ‹è¿‡æ‹Ÿåˆï¼Œå®ç›˜è¡¨ç°å·®

**å‰è§†åå·®ç¤ºä¾‹**ï¼š
```
æ•°æ®: [1, 2, 3, 4, 5]
å…¨å±€Zï¼ˆé”™è¯¯ï¼‰:
  mean_all = 3.0, std_all = 1.58
  z[0] = (1 - 3.0) / 1.58 = -1.26  âŒ ä½¿ç”¨äº†æœªæ¥æ•°æ®[2,3,4,5]

æ»šåŠ¨Zï¼ˆæ­£ç¡®ï¼Œwindow=3ï¼‰:
  i=0: window=[1], len<2 â†’ z[0]=0.0
  i=1: window=[1,2], mean=1.5, std=0.71 â†’ z[1]=(2-1.5)/0.71=0.71 âœ… åªç”¨å†å²
  i=2: window=[1,2,3], mean=2.0, std=1.0 â†’ z[2]=(3-2.0)/1.0=1.0 âœ…
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ–°å¢å·¥å…·å‡½æ•° `rolling_z` å®ç°æ»šåŠ¨çª—å£Z-score
- æ¯ä¸ªç‚¹åªä½¿ç”¨å†å²æ•°æ®ï¼ˆi-window+1 åˆ° iï¼‰
- æ”¯æŒç¨³å¥æ–¹æ³•ï¼ˆMADä»£æ›¿stdï¼ŒæŠ—å¼‚å¸¸å€¼ï¼‰
- é…ç½®åŒ–çª—å£å¤§å°ï¼ˆrolling_window: 96æ ¹1h Kçº¿ = 4å¤©ï¼‰

**ä»£ç å˜æ›´**ï¼š
```python
# ats_core/utils/cvd_utils.py (NEW)
def rolling_z(
    values: List[float],
    window: int = 96,
    robust: bool = True
) -> List[float]:
    """
    æ»šåŠ¨çª—å£Z-scoreæ ‡å‡†åŒ–ï¼ˆæ— å‰è§†åå·®ï¼‰

    Args:
        values: æ•°å€¼åºåˆ—ï¼ˆå¦‚CVDå¢é‡ã€ä»·æ ¼æ”¶ç›Šã€OIå˜åŒ–ï¼‰
        window: æ»šåŠ¨çª—å£å¤§å°ï¼ˆ96æ ¹1h Kçº¿ = 4å¤©ï¼‰
        robust: æ˜¯å¦ä½¿ç”¨ç¨³å¥ç»Ÿè®¡ï¼ˆMADä»£æ›¿stdï¼ŒæŠ—å¼‚å¸¸å€¼ï¼‰

    Returns:
        Z-scoreåºåˆ—
    """
    result = []
    for i in range(len(values)):
        # åªä½¿ç”¨å†å²æ•°æ®ï¼ˆi-window+1 åˆ° iï¼‰
        start = max(0, i - window + 1)
        window_data = values[start:i+1]

        if len(window_data) < 2:
            result.append(0.0)
            continue

        mean_val = sum(window_data) / len(window_data)

        if robust:
            # MADæ–¹æ³•ï¼šmedian(|x_i - median(x)|)
            median_val = sorted(window_data)[len(window_data) // 2]
            abs_deviations = [abs(x - median_val) for x in window_data]
            mad = sorted(abs_deviations)[len(abs_deviations) // 2]
            scale = mad * 1.4826 if mad > 0 else 0.0  # MAD to std conversion
        else:
            # ä¼ ç»Ÿstdæ–¹æ³•
            variance = sum((x - mean_val) ** 2 for x in window_data) / (len(window_data) - 1)
            scale = math.sqrt(variance) if variance > 0 else 0.0

        if scale == 0:
            result.append(0.0)
        else:
            result.append((values[i] - mean_val) / scale)

    return result
```

```python
# ats_core/features/cvd.py - cvd_mix_with_oi_priceä¿®æ”¹
def cvd_mix_with_oi_price(
    klines: Sequence[Sequence],
    oi_hist: Sequence[dict],
    window: int = 20,
    spot_klines: Sequence[Sequence] = None,
    use_quote: bool = True,          # v7.2.34æ–°å¢
    rolling_window: int = 96,        # v7.2.34æ–°å¢
    use_robust: bool = True          # v7.2.34æ–°å¢
) -> Tuple[List[float], List[float]]:
    """v7.2.34å¢å¼ºï¼šæ»šåŠ¨Zä»£æ›¿å…¨å±€Z"""
    from ats_core.utils.cvd_utils import rolling_z

    # è®¡ç®—CVD
    if spot_klines and len(spot_klines) > 0:
        cvd = cvd_combined(klines, spot_klines, use_quote=use_quote)
    else:
        cvd = cvd_from_klines(klines, use_quote=use_quote)

    # è®¡ç®—å¢é‡ï¼ˆÎ”C, Î”P, Î”OIï¼‰
    delta_cvd = _pct_change(cvd)  # CVDå¢é‡è€Œéç´¯ç§¯å€¼
    ret_p = _pct_change(closes)
    d_oi = _pct_change(oi_vals)

    # P1: æ»šåŠ¨Zæ ‡å‡†åŒ–ï¼ˆæ— å‰è§†åå·®ï¼‰
    z_cvd = rolling_z(delta_cvd, window=rolling_window, robust=use_robust)
    z_p = rolling_z(ret_p, window=rolling_window, robust=use_robust)
    z_oi = rolling_z(d_oi, window=rolling_window, robust=use_robust)

    # åŠ æƒç»„åˆ
    mix = [1.2 * z_cvd[i] + 0.4 * z_p[i] + 0.4 * z_oi[i] for i in range(n)]
    return cvd, mix
```

**é…ç½®å‚æ•°**ï¼ˆconfig/signal_thresholds.jsonï¼‰ï¼š
```json
"CVDè®¡ç®—å‚æ•°": {
    "rolling_window": 96,         // 4å¤©å†å²æ•°æ®ï¼ˆ1h Kçº¿ï¼‰
    "use_robust_zscore": true     // ä½¿ç”¨MADç¨³å¥æ–¹æ³•
}
```

**æµ‹è¯•éªŒè¯**ï¼š
```python
# æ— å‰è§†åå·®éªŒè¯
data = [1.0, 2.0, 1.5, 3.0, 2.5]
z = rolling_z(data, window=3, robust=False)
# z[0] = 0.0 (çª—å£åªæœ‰1ä¸ªç‚¹ï¼Œlen<2)
# z[1] = 0.71 (çª—å£=[1.0, 2.0]ï¼Œåªç”¨å†å²)
# z[2] = (1.5 - mean([1.0, 2.0, 1.5])) / std([1.0, 2.0, 1.5])  âœ… åªç”¨å†å²

# MADç¨³å¥æ€§éªŒè¯
data_outlier = [1.0, 2.0, 1.5, 100.0, 2.5]  # 100.0ä¸ºå¼‚å¸¸å€¼
z_std = rolling_z(data_outlier, window=5, robust=False)   # å—å¼‚å¸¸å€¼å½±å“
z_mad = rolling_z(data_outlier, window=5, robust=True)    # ç¨³å¥
# MADæ–¹æ³•å¯¹å¼‚å¸¸å€¼æ›´ç¨³å¥
```

---

### 3. Quote CVDæ”¯æŒï¼ˆP2-Normalï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼š
- åŸå®ç°åªæ”¯æŒBase CVDï¼ˆå¸æ•°é‡å•ä½ï¼‰
- ä¸åŒå¸ç§ä»·æ ¼å·®å¼‚å¤§ï¼ˆBTC 60k vs DOGE 0.1ï¼‰
- Base CVDæ— æ³•è·¨å¸ç§æ¯”è¾ƒ

**Quote CVD vs Base CVD**ï¼š
```
ç¤ºä¾‹ï¼šBTCä¹°å…¥100ä¸ª vs DOGEä¹°å…¥100ä¸ª

Base CVDï¼ˆå¸æ•°é‡ï¼‰:
  BTC: +100 BTC
  DOGE: +100 DOGE
  é—®é¢˜: æ— æ³•æ¯”è¾ƒï¼ˆBTCä»·å€¼600ä¸‡USDTï¼ŒDOGEä»·å€¼10 USDTï¼‰

Quote CVDï¼ˆUSDTå•ä½ï¼‰:
  BTC: +6,000,000 USDT
  DOGE: +10 USDT
  ä¼˜åŠ¿: ç›´æ¥åæ˜ èµ„é‡‘æµå¤§å°ï¼Œå¯è·¨å¸ç§æ¯”è¾ƒ
```

**è®¡ç®—å…¬å¼**ï¼š
```python
# Base CVDï¼ˆå¸æ•°é‡ï¼‰
delta_base = 2 * takerBuyBaseVolume - volume
# Kçº¿ç¬¬9åˆ—: takerBuyBaseVolumeï¼ˆä¸»åŠ¨ä¹°å…¥é‡ï¼‰
# Kçº¿ç¬¬5åˆ—: volumeï¼ˆæ€»æˆäº¤é‡ï¼‰

# Quote CVDï¼ˆUSDTå•ä½ï¼‰
delta_quote = 2 * takerBuyQuoteVolume - quoteAssetVolume
# Kçº¿ç¬¬10åˆ—: takerBuyQuoteVolumeï¼ˆä¸»åŠ¨ä¹°å…¥æˆäº¤é¢ï¼‰
# Kçº¿ç¬¬7åˆ—: quoteAssetVolumeï¼ˆæ€»æˆäº¤é¢ï¼‰
```

**ä»£ç å˜æ›´**ï¼š
```python
# ats_core/utils/cvd_utils.py (NEW)
def compute_cvd_delta(
    klines: Sequence[Sequence],
    use_quote: bool = True
) -> List[float]:
    """
    è®¡ç®—CVDå¢é‡åºåˆ—ï¼ˆÎ”Cï¼‰

    Args:
        klines: Kçº¿æ•°æ®ï¼ˆBinanceæ ¼å¼ï¼Œ12åˆ—ï¼‰
        use_quote: True=ä½¿ç”¨Quote CVDï¼ˆUSDTï¼‰ï¼ŒFalse=ä½¿ç”¨Base CVDï¼ˆå¸æ•°é‡ï¼‰

    Returns:
        CVDå¢é‡åºåˆ— [delta_0, delta_1, ..., delta_n]
    """
    if use_quote:
        # Quote CVDï¼ˆUSDTå•ä½ï¼‰
        taker_buy_quote = [_to_f(k[10]) for k in klines]
        quote_volume = [_to_f(k[7]) for k in klines]
        deltas = [2.0 * buy - total for buy, total in zip(taker_buy_quote, quote_volume)]
    else:
        # Base CVDï¼ˆå¸æ•°é‡å•ä½ï¼‰
        taker_buy_base = [_to_f(k[9]) for k in klines]
        total_volume = [_to_f(k[5]) for k in klines]
        deltas = [2.0 * buy - total for buy, total in zip(taker_buy_base, total_volume)]

    return deltas
```

```python
# ats_core/features/cvd.py - cvd_from_klinesä¿®æ”¹
def cvd_from_klines(
    klines: Sequence[Sequence],
    use_taker_buy: bool = True,
    use_quote: bool = True,          # v7.2.34æ–°å¢
    filter_outliers: bool = True,
    outlier_weight: float = 0.5
) -> List[float]:
    """v7.2.34å¢å¼ºï¼šæ”¯æŒQuote CVD"""
    if use_taker_buy and klines and len(klines[0]) >= 11:
        if use_quote:
            # Quote CVD (USDT)
            taker_buy = _col(klines, 10)  # takerBuyQuoteVolume
            total_vol = _col(klines, 7)   # quoteAssetVolume
        else:
            # Base CVD (å¸æ•°é‡)
            taker_buy = _col(klines, 9)   # takerBuyBaseVolume
            total_vol = _col(klines, 5)   # volume

        # è®¡ç®—deltaå¹¶ç´¯ç§¯CVD
        # ... (IQRå¼‚å¸¸å€¼æ£€æµ‹é€»è¾‘ä¿æŒä¸å˜)
```

**é…ç½®å‚æ•°**ï¼ˆconfig/signal_thresholds.jsonï¼‰ï¼š
```json
"CVDè®¡ç®—å‚æ•°": {
    "use_quote": true  // true=USDTå•ä½ï¼Œfalse=å¸æ•°é‡å•ä½
}
```

**æµ‹è¯•éªŒè¯**ï¼š
```python
# æ’ç­‰å¼éªŒè¯: Î£delta = 2*Î£taker_buy - Î£total_volume
klines = [
    [ts, o, h, l, c, 10.0, ct, 1000.0, n, 6.0, 600.0, 0],  # ä¹°ç›˜60%
    [ts, o, h, l, c, 20.0, ct, 2000.0, n, 8.0, 800.0, 0]   # ä¹°ç›˜40%
]

deltas_quote = compute_cvd_delta(klines, use_quote=True)
# delta[0] = 2*600 - 1000 = 200 USDT
# delta[1] = 2*800 - 2000 = -400 USDT
# Î£delta = -200 USDT
# éªŒè¯: 2*(600+800) - (1000+2000) = -200 âœ…
```

---

### 4. ç¼ºå¤±/æå€¼å®¹é”™ï¼ˆP2-Normalï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼š
- ä½æµåŠ¨æ€§æ—¶æ®µï¼ˆå‡Œæ™¨ã€å‘¨æœ«ï¼‰æˆäº¤é¢å¯èƒ½æä½
- æä½æˆäº¤é¢çš„CVDå™ªéŸ³å¤§ï¼Œä¸å¯ä¿¡
- åŸå®ç°æ— å®¹é”™ï¼Œç›´æ¥å‚ä¸è®¡ç®—

**é£é™©ç¤ºä¾‹**ï¼š
```
æ­£å¸¸æ—¶æ®µï¼š
  åˆçº¦æˆäº¤é¢ 500k USDT + ç°è´§æˆäº¤é¢ 200k USDT = 700k USDT
  CVD delta: +50k USDTï¼ˆä¹°ç›˜å ä¼˜ï¼‰

ä½æµåŠ¨æ€§æ—¶æ®µï¼š
  åˆçº¦æˆäº¤é¢ 50 USDT + ç°è´§æˆäº¤é¢ 30 USDT = 80 USDT
  CVD delta: -10 USDTï¼ˆå¯èƒ½åªæ˜¯1-2ç¬”å•ï¼‰

é—®é¢˜: 80 USDTçš„CVDä¸700k USDTçš„CVDæƒé‡ç›¸åŒ âŒ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é…ç½®æœ€å°æˆäº¤é¢é˜ˆå€¼ï¼ˆmin_total_quote: 100k USDTï¼‰
- ä½äºé˜ˆå€¼æ—¶ï¼šè·³è¿‡è¯¥Kçº¿ï¼Œä½¿ç”¨ä¸Šä¸€æ ¹CVDå€¼
- é€Kçº¿æ£€æŸ¥æˆäº¤é¢ï¼Œç¡®ä¿æ•°æ®è´¨é‡

**ä»£ç å˜æ›´**ï¼š
```python
# ats_core/features/cvd.py - cvd_combinedä¿®æ”¹
def cvd_combined(
    futures_klines: Sequence[Sequence],
    spot_klines: Sequence[Sequence] = None,
    use_dynamic_weight: bool = True,
    use_quote: bool = True,
    min_total_quote: float = 100000,     # v7.2.34æ–°å¢
    max_discard_ratio: float = 0.001
) -> List[float]:
    """v7.2.34å¢å¼ºï¼šæˆäº¤é¢å®¹é”™"""

    # ... openTimeå¯¹é½é€»è¾‘ ...

    # è®¡ç®—å¢é‡
    deltas_f = compute_cvd_delta(aligned_f, use_quote=use_quote)
    deltas_s = compute_cvd_delta(aligned_s, use_quote=use_quote)

    result = []
    cumulative_cvd = 0.0

    for i in range(n):
        # P2: æˆäº¤é¢å®¹é”™æ£€æŸ¥
        f_quote = _to_f(aligned_f[i][7])  # quoteAssetVolume
        s_quote = _to_f(aligned_s[i][7])
        total_quote_i = f_quote + s_quote

        if total_quote_i < min_total_quote:
            # æˆäº¤é¢è¿‡ä½ï¼Œè·³è¿‡è¯¥Kçº¿
            if i == 0:
                result.append(0.0)
            else:
                result.append(result[-1])  # ä½¿ç”¨ä¸Šä¸€æ ¹CVD
            continue

        # åŠ¨æ€åŠ æƒç»„åˆ
        if use_dynamic_weight:
            total_vol_i = f_quote + s_quote
            futures_weight = f_quote / total_vol_i if total_vol_i > 0 else 0.5
            spot_weight = s_quote / total_vol_i if total_vol_i > 0 else 0.5
        else:
            futures_weight = 0.6
            spot_weight = 0.4

        combined_delta = futures_weight * deltas_f[i] + spot_weight * deltas_s[i]
        cumulative_cvd += combined_delta
        result.append(cumulative_cvd)

    return result
```

**é…ç½®å‚æ•°**ï¼ˆconfig/signal_thresholds.jsonï¼‰ï¼š
```json
"CVDè®¡ç®—å‚æ•°": {
    "min_total_quote": 100000  // æœ€å°æ€»æˆäº¤é¢100k USDT
}
```

---

### 5. å·¥å…·å‡½æ•°æ²‰æ·€ï¼ˆP2-Normalï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼š
- CVDè®¡ç®—é€»è¾‘åˆ†æ•£åœ¨cvd.pyå¤šä¸ªå‡½æ•°ä¸­
- Kçº¿å¯¹é½ã€Z-scoreã€å¢é‡è®¡ç®—ç­‰é€šç”¨é€»è¾‘é‡å¤
- ä¸åˆ©äºæµ‹è¯•å’Œå¤ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ–°å»º `ats_core/utils/cvd_utils.py` å·¥å…·æ¨¡å—
- æ²‰æ·€3ä¸ªé€šç”¨å‡½æ•°ï¼š
  1. `align_klines_by_open_time`: Kçº¿æ—¶é—´å¯¹é½
  2. `rolling_z`: æ»šåŠ¨çª—å£Z-scoreæ ‡å‡†åŒ–
  3. `compute_cvd_delta`: CVDå¢é‡è®¡ç®—

**ä»£ç ç»“æ„**ï¼š
```python
# ats_core/utils/cvd_utils.py (NEW FILE)
"""
CVDå·¥å…·å‡½æ•°æ¨¡å—

v7.2.34æ–°å¢ï¼šæ²‰æ·€CVDè®¡ç®—çš„é€šç”¨å·¥å…·å‡½æ•°
- align_klines_by_open_time: Kçº¿æ—¶é—´å¯¹é½ï¼ˆinner joinï¼‰
- rolling_z: æ»šåŠ¨çª—å£Z-scoreæ ‡å‡†åŒ–ï¼ˆæ— å‰è§†åå·®ï¼‰
- compute_cvd_delta: è®¡ç®—CVDå¢é‡åºåˆ—
"""

from typing import List, Tuple, Dict, Sequence
import math
from ats_core.logging import warn


def align_klines_by_open_time(...) -> Tuple[List[List], List[List], int]:
    """åŸºäºopenTimeå¯¹é½ç°è´§å’Œåˆçº¦Kçº¿ï¼ˆinner joinï¼‰"""
    # å®ç°è§ä¸Šæ–‡


def rolling_z(...) -> List[float]:
    """æ»šåŠ¨çª—å£Z-scoreæ ‡å‡†åŒ–ï¼ˆæ— å‰è§†åå·®ï¼‰"""
    # å®ç°è§ä¸Šæ–‡


def compute_cvd_delta(...) -> List[float]:
    """è®¡ç®—CVDå¢é‡åºåˆ—ï¼ˆÎ”Cï¼‰"""
    # å®ç°è§ä¸Šæ–‡


__all__ = [
    'align_klines_by_open_time',
    'rolling_z',
    'compute_cvd_delta',
]
```

**æµ‹è¯•éªŒè¯**ï¼š
```python
# æµ‹è¯•è¦†ç›–ç‡ï¼š100%
from ats_core.utils.cvd_utils import (
    align_klines_by_open_time,
    rolling_z,
    compute_cvd_delta
)

# Test 1: Kçº¿å¯¹é½ï¼ˆinner joinï¼‰
# Test 2: æ»šåŠ¨Zï¼ˆæ— å‰è§†åå·®ï¼‰
# Test 3: MADç¨³å¥æ–¹æ³•
# Test 4: CVDå¢é‡è®¡ç®—ï¼ˆQuote/Baseï¼‰
# Test 5: CVDæ’ç­‰å¼éªŒè¯

# ç»“æœï¼šâœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
```

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

#### 1. ats_core/utils/cvd_utils.pyï¼ˆ202è¡Œï¼‰
- **åŠŸèƒ½**: CVDå·¥å…·å‡½æ•°æ¨¡å—
- **æ–°å¢å‡½æ•°**:
  - `align_klines_by_open_time`: Kçº¿openTimeå¯¹é½ï¼ˆinner joinï¼‰
  - `rolling_z`: æ»šåŠ¨çª—å£Z-scoreæ ‡å‡†åŒ–ï¼ˆæ”¯æŒMADç¨³å¥æ–¹æ³•ï¼‰
  - `compute_cvd_delta`: CVDå¢é‡è®¡ç®—ï¼ˆæ”¯æŒQuote/Baseï¼‰
- **å¯¼å‡º**: `__all__` åˆ—è¡¨

### ä¿®æ”¹æ–‡ä»¶

#### 2. config/signal_thresholds.json
- **æ–°å¢é…ç½®åŒºåŸŸ**: "CVDè®¡ç®—å‚æ•°"ï¼ˆ5ä¸ªå‚æ•°ï¼‰
  ```json
  "CVDè®¡ç®—å‚æ•°": {
      "use_quote": true,              // ä½¿ç”¨USDTå•ä½ï¼ˆtrueï¼‰æˆ–å¸æ•°é‡ï¼ˆfalseï¼‰
      "rolling_window": 96,           // æ»šåŠ¨çª—å£å¤§å°ï¼ˆ96æ ¹1h Kçº¿ = 4å¤©ï¼‰
      "min_total_quote": 100000,      // æœ€å°æ€»æˆäº¤é¢é˜ˆå€¼ï¼ˆ100k USDTï¼‰
      "max_discard_ratio": 0.001,     // æœ€å¤§Kçº¿ä¸¢å¼ƒç‡ï¼ˆ0.1%ï¼‰
      "use_robust_zscore": true       // ä½¿ç”¨MADç¨³å¥æ–¹æ³•ï¼ˆtrueï¼‰æˆ–ä¼ ç»Ÿstdï¼ˆfalseï¼‰
  }
  ```

#### 3. ats_core/features/cvd.py
- **ä¿®æ”¹å‡½æ•°**: `cvd_from_klines`ï¼ˆç¬¬40-90è¡Œï¼‰
  - æ–°å¢å‚æ•°: `use_quote: bool = True`
  - æ”¯æŒQuote CVDï¼ˆUSDTå•ä½ï¼‰å’ŒBase CVDï¼ˆå¸æ•°é‡ï¼‰
  - ä¿æŒIQRå¼‚å¸¸å€¼æ£€æµ‹é€»è¾‘ä¸å˜

- **ä¿®æ”¹å‡½æ•°**: `cvd_from_spot_klines`ï¼ˆç¬¬120-160è¡Œï¼‰
  - æ–°å¢å‚æ•°: `use_quote: bool = True`
  - ä¸cvd_from_klinesä¿æŒæ¥å£ä¸€è‡´

- **ä¿®æ”¹å‡½æ•°**: `cvd_combined`ï¼ˆç¬¬200-320è¡Œï¼‰
  - æ–°å¢å‚æ•°: `use_quote`, `min_total_quote`, `max_discard_ratio`
  - å¯¼å…¥: `from ats_core.utils.cvd_utils import align_klines_by_open_time, compute_cvd_delta`
  - å®ç°openTimeå¯¹é½æ£€æŸ¥ï¼ˆinner joinï¼‰
  - å®ç°ä¸¢å¼ƒç‡è­¦å‘Š
  - å®ç°é€Kçº¿æˆäº¤é¢å®¹é”™
  - åŠ¨æ€æƒé‡è®¡ç®—åŸºäºå¯¹é½åKçº¿

- **ä¿®æ”¹å‡½æ•°**: `cvd_mix_with_oi_price`ï¼ˆç¬¬450-550è¡Œï¼‰
  - æ–°å¢å‚æ•°: `use_quote`, `rolling_window`, `use_robust`
  - å¯¼å…¥: `from ats_core.utils.cvd_utils import rolling_z`
  - æ”¹ç”¨æ»šåŠ¨Zä»£æ›¿å…¨å±€Z
  - æ ‡å‡†åŒ–å¢é‡ï¼ˆÎ”C, Î”P, Î”OIï¼‰è€Œéç´¯ç§¯å€¼

---

## æµ‹è¯•ç»“æœæ±‡æ€»

### Test 1: è¯­æ³•éªŒè¯ âœ…
```bash
python3 -m py_compile ats_core/utils/cvd_utils.py
python3 -m py_compile ats_core/features/cvd.py
python3 -c "import json; json.load(open('config/signal_thresholds.json'))"

ç»“æœ: âœ… æ‰€æœ‰æ–‡ä»¶è¯­æ³•æ­£ç¡®ï¼ŒJSONæ ¼å¼æœ‰æ•ˆ
```

### Test 2: CVDå·¥å…·å‡½æ•°å•å…ƒæµ‹è¯• âœ…
```python
# Test 1: align_klines_by_open_time - openTimeå¯¹é½
âœ… Inner joinå¯¹é½æ­£ç¡®
   - åˆçº¦2æ ¹ + ç°è´§2æ ¹ â†’ å¯¹é½1æ ¹ï¼ˆäº¤é›†01:00ï¼‰
   - ä¸¢å¼ƒ2æ ¹ï¼ˆåˆçº¦00:00 + ç°è´§02:00ï¼‰

# Test 2: rolling_z - æ»šåŠ¨çª—å£Z-score
âœ… çª—å£ä¸è¶³é€»è¾‘æ­£ç¡®
   - z[0] = 0.0000 (çª—å£=[1.0], len=1 < 2, è¿”å›0)
   - z[1] = 0.7071 (çª—å£=[1.0, 2.0], len=2 >= 2, å¯è®¡ç®—)
âœ… æ— å‰è§†åå·®ï¼šæ¯ä¸ªz[i]åªä½¿ç”¨data[0:i+1]

# Test 3: rolling_z - MADç¨³å¥æ ‡å‡†åŒ–
âœ… MADæ–¹æ³•å¯¹å¼‚å¸¸å€¼æ›´ç¨³å¥
   - æ ‡å‡†stdæ–¹æ³•ï¼šæœ€åä¸€ä¸ªZ = -0.4301
   - MADç¨³å¥æ–¹æ³•ï¼šæœ€åä¸€ä¸ªZ = -25.4958

# Test 4: compute_cvd_delta - CVDå¢é‡è®¡ç®—
âœ… Quote CVDå¢é‡æ­£ç¡®
   - Kçº¿0: 2*600 - 1000 = 200.0 USDT
   - Kçº¿1: 2*800 - 2000 = -400.0 USDT
âœ… Base CVDå¢é‡æ­£ç¡®
   - Kçº¿0: 2*6 - 10 = 2.0 å¸
   - Kçº¿1: 2*8 - 20 = -4.0 å¸

# Test 5: CVDæ’ç­‰å¼éªŒè¯
âœ… Quote CVDæ’ç­‰å¼æˆç«‹
   Î£delta = -200.0
   2*Î£taker_buy - Î£total = -200.0

ç»“æœ: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
```

---

## å½±å“è¯„ä¼°

### åŠŸèƒ½å½±å“

**æ­£é¢å½±å“**ï¼š
- âœ… **æ•°æ®è´¨é‡æå‡**ï¼šopenTimeå¯¹é½é˜²æ­¢ç°è´§/åˆçº¦Kçº¿é”™ä½
- âœ… **å›æµ‹å‡†ç¡®æ€§æå‡**ï¼šæ»šåŠ¨Zæ¶ˆé™¤å‰è§†åå·®
- âœ… **è·¨å¸ç§å¯æ¯”æ€§**ï¼šQuote CVDç»Ÿä¸€ä¸ºUSDTå•ä½
- âœ… **å™ªéŸ³è¿‡æ»¤**ï¼šä½æˆäº¤é¢Kçº¿å®¹é”™å¤„ç†
- âœ… **ä»£ç å¯ç»´æŠ¤æ€§**ï¼šå·¥å…·å‡½æ•°æ²‰æ·€ï¼Œä¾¿äºæµ‹è¯•å’Œå¤ç”¨

**æ— å½±å“**ï¼š
- âœ… **å‘åå…¼å®¹**ï¼šæ–°å¢å‚æ•°å‡æœ‰é»˜è®¤å€¼ï¼Œä¸å½±å“ç°æœ‰è°ƒç”¨
- âœ… **æ€§èƒ½å½±å“**ï¼šminimalï¼ˆopenTimeå¯¹é½O(n)ï¼Œæ»šåŠ¨ZO(n*w)ï¼Œw=96å¯æ¥å—ï¼‰

### é…ç½®åŒ–å¢å¼º

**æ‰€æœ‰é˜ˆå€¼å‡é…ç½®åŒ–**ï¼ˆconfig/signal_thresholds.jsonï¼‰ï¼š
```json
"CVDè®¡ç®—å‚æ•°": {
    "use_quote": true,              // å¿«é€Ÿåˆ‡æ¢Quote/Base CVD
    "rolling_window": 96,           // è°ƒæ•´å†å²çª—å£å¤§å°
    "min_total_quote": 100000,      // è°ƒæ•´æˆäº¤é¢é˜ˆå€¼
    "max_discard_ratio": 0.001,     // è°ƒæ•´ä¸¢å¼ƒç‡å®¹å¿åº¦
    "use_robust_zscore": true       // åˆ‡æ¢MAD/stdæ–¹æ³•
}
```

**ä¼˜åŠ¿**ï¼š
- æ— éœ€ä¿®æ”¹ä»£ç å³å¯è°ƒä¼˜å‚æ•°
- ä¸åŒå¸‚åœºç¯å¢ƒå¿«é€Ÿåˆ‡æ¢ç­–ç•¥
- ç¬¦åˆç³»ç»Ÿå¢å¼ºè§„èŒƒï¼ˆstandards/SYSTEM_ENHANCEMENT_STANDARD.mdï¼‰

---

## å‘åå…¼å®¹æ€§

### APIå…¼å®¹æ€§ âœ…

**æ‰€æœ‰æ–°å¢å‚æ•°å‡æœ‰é»˜è®¤å€¼**ï¼š
```python
# cvd_from_klines
use_quote: bool = True  # é»˜è®¤ä½¿ç”¨Quote CVD

# cvd_combined
use_quote: bool = True
min_total_quote: float = 100000
max_discard_ratio: float = 0.001

# cvd_mix_with_oi_price
use_quote: bool = True
rolling_window: int = 96
use_robust: bool = True
```

**ç°æœ‰è°ƒç”¨ä¸å—å½±å“**ï¼š
```python
# åŸè°ƒç”¨æ–¹å¼ï¼ˆæ— å‚æ•°ï¼‰
cvd = cvd_from_klines(klines)  # âœ… ä»å¯ç”¨ï¼Œé»˜è®¤Quote CVD

# æ–°è°ƒç”¨æ–¹å¼ï¼ˆæ˜¾å¼å‚æ•°ï¼‰
cvd = cvd_from_klines(klines, use_quote=True)  # ç­‰æ•ˆä¸Šé¢
```

### æ•°æ®å…¼å®¹æ€§ âœ…

- âœ… Kçº¿æ•°æ®æ ¼å¼ä¸å˜ï¼ˆBinance 12åˆ—æ ‡å‡†æ ¼å¼ï¼‰
- âœ… CVDè¿”å›æ ¼å¼ä¸å˜ï¼ˆList[float]ç´¯ç§¯åºåˆ—ï¼‰
- âœ… ä¸å½±å“ä¸‹æ¸¸pipeline/outputå±‚

---

## éƒ¨ç½²å»ºè®®

### éƒ¨ç½²å‰æ£€æŸ¥

```bash
# 1. è¯­æ³•éªŒè¯
python3 -m py_compile ats_core/utils/cvd_utils.py
python3 -m py_compile ats_core/features/cvd.py

# 2. JSONé…ç½®éªŒè¯
python3 -c "import json; json.load(open('config/signal_thresholds.json'))"

# 3. å•å…ƒæµ‹è¯•
python3 << 'EOF'
from ats_core.utils.cvd_utils import align_klines_by_open_time, rolling_z, compute_cvd_delta
# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
EOF
```

### éƒ¨ç½²åéªŒè¯

```bash
# 1. è§‚å¯ŸCVDè®¡ç®—æ—¥å¿—
tail -f logs/scanner.log | grep "CVD"

# 2. æ£€æŸ¥Kçº¿å¯¹é½è­¦å‘Š
grep "Kçº¿å¯¹é½ä¸¢å¼ƒ" logs/scanner.log

# 3. æ£€æŸ¥æˆäº¤é¢è¿‡ä½Kçº¿
grep "æˆäº¤é¢è¿‡ä½" logs/scanner.log

# 4. éªŒè¯Quote CVDè®¡ç®—
# æ‰‹å·¥æŠ½æŸ¥å‡ ä¸ªå¸ç§ï¼Œç¡®è®¤CVDå€¼åœ¨åˆç†èŒƒå›´ï¼ˆUSDTå•ä½ï¼‰
```

### å›æ»šæ–¹æ¡ˆ

**å¦‚éœ€å›æ»š**ï¼ˆä¸æ¨èï¼‰ï¼š
```bash
# å›æ»šåˆ°v7.2.33
git revert <commit-hash>

# æˆ–åˆ é™¤æ–°å¢æ–‡ä»¶
rm ats_core/utils/cvd_utils.py

# æ¢å¤config/signal_thresholds.jsonï¼ˆåˆ é™¤"CVDè®¡ç®—å‚æ•°"åŒºåŸŸï¼‰
# æ¢å¤ats_core/features/cvd.pyï¼ˆåˆ é™¤æ–°å¢å‚æ•°å’Œimportï¼‰
```

---

## ç›¸å…³æ–‡æ¡£

- `CVD_EXPERT_RECOMMENDATIONS_ANALYSIS.md` - CVDä¸“å®¶å»ºè®®åˆ†ææŠ¥å‘Š
- `CVD_COMPLETE_TECHNICAL_DOC.md` - CVDå®Œæ•´æŠ€æœ¯æ–‡æ¡£
- `standards/SYSTEM_ENHANCEMENT_STANDARD.md` - ç³»ç»Ÿå¢å¼ºè§„èŒƒ
- `v7.2.33_UTC_TIMEZONE_FIX.md` - UTCæ—¶åŒºç»Ÿä¸€ä¿®å¤

---

## æ€»ç»“

âœ… **å¢å¼ºå®Œæˆ**ï¼š
- P1-1: openTimeå¯¹é½æ£€æŸ¥ï¼ˆé˜²æ­¢Kçº¿é”™ä½ï¼‰
- P1-2: æ»šåŠ¨Zæ ‡å‡†åŒ–ï¼ˆæ¶ˆé™¤å‰è§†åå·®ï¼‰
- P2-3: Quote CVDæ”¯æŒï¼ˆUSDTå•ä½ï¼Œè·¨å¸ç§å¯æ¯”ï¼‰
- P2-4: ç¼ºå¤±/æå€¼å®¹é”™ï¼ˆæˆäº¤é¢è¿‡ä½é™æƒï¼‰
- P2-5: å·¥å…·å‡½æ•°æ²‰æ·€ï¼ˆä»£ç è§„èŒƒåŒ–ï¼‰

âœ… **æµ‹è¯•é€šè¿‡**ï¼š
- è¯­æ³•éªŒè¯é€šè¿‡
- å•å…ƒæµ‹è¯•100%é€šè¿‡ï¼ˆ5é¡¹æµ‹è¯•ï¼‰
- CVDæ’ç­‰å¼éªŒè¯é€šè¿‡
- æ— å‰è§†åå·®éªŒè¯é€šè¿‡

âœ… **è´¨é‡ä¿è¯**ï¼š
- å®Œå…¨å‘åå…¼å®¹
- æ‰€æœ‰é˜ˆå€¼é…ç½®åŒ–ï¼ˆæ— ç¡¬ç¼–ç ï¼‰
- ä»£ç ç»“æ„æ¸…æ™°ï¼ˆå·¥å…·å‡½æ•°ç‹¬ç«‹ï¼‰
- æ–‡æ¡£å®Œæ•´ï¼ˆæŠ€æœ¯ç»†èŠ‚+æµ‹è¯•ç»“æœï¼‰

**å»ºè®®**ï¼š
- ç«‹å³éƒ¨ç½²ï¼ˆP1+P2ä¼˜å…ˆçº§ï¼‰
- éƒ¨ç½²åè§‚å¯ŸKçº¿å¯¹é½è­¦å‘Šé¢‘ç‡
- æ ¹æ®å®é™…å¸‚åœºæ•°æ®è°ƒä¼˜å‚æ•°ï¼ˆconfig/signal_thresholds.jsonï¼‰
- ç›‘æ§CVDè®¡ç®—æ€§èƒ½ï¼ˆrolling_zåœ¨é«˜é¢‘åœºæ™¯ï¼‰

---

**Changelog**ï¼š
```
v7.2.34 (2025-11-12)
  [Added]
  + ats_core/utils/cvd_utils.py: CVDå·¥å…·å‡½æ•°æ¨¡å—
    - align_klines_by_open_time: openTimeå¯¹é½ï¼ˆinner joinï¼‰
    - rolling_z: æ»šåŠ¨çª—å£Z-scoreï¼ˆæ”¯æŒMADï¼‰
    - compute_cvd_delta: CVDå¢é‡è®¡ç®—ï¼ˆæ”¯æŒQuote/Baseï¼‰
  + config/signal_thresholds.json: CVDè®¡ç®—å‚æ•°åŒºåŸŸï¼ˆ5ä¸ªå‚æ•°ï¼‰

  [Enhanced]
  * ats_core/features/cvd.py:
    - cvd_from_klines: æ”¯æŒuse_quoteå‚æ•°ï¼ˆQuote/Base CVDï¼‰
    - cvd_from_spot_klines: æ”¯æŒuse_quoteå‚æ•°
    - cvd_combined: openTimeå¯¹é½ + ä¸¢å¼ƒç‡æ£€æŸ¥ + æˆäº¤é¢å®¹é”™
    - cvd_mix_with_oi_price: æ»šåŠ¨Zä»£æ›¿å…¨å±€Zï¼ˆæ¶ˆé™¤å‰è§†åå·®ï¼‰

  [Fixed]
  * ç°è´§/åˆçº¦Kçº¿æ—¶é—´é”™ä½é—®é¢˜ï¼ˆP1-Importantï¼‰
  * å…¨å±€Z-scoreå‰è§†åå·®é—®é¢˜ï¼ˆP1-Importantï¼‰
```
