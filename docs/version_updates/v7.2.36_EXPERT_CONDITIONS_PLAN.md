# v7.2.36 CVD专家深度复核 - 必补条件实施计划

**发布日期**: 2025-11-12
**优先级**: P1-Blocking (阻塞全面上线的必要条件)
**基于**: v7.2.35 CVD专家复核修复

---

## 专家结论

✅ **v7.2.35可以灰度上线**，但必须附带以下**6个必补条件**才能全面rollout。

⚠️ **不满足这些条件的风险**：
- 小币/冷时段产生偏差
- 边界时间数据质量问题
- 回测虚胖，实盘打脸

---

## 必补条件（6项Blocking Issues）

### 1. ΔC的"尺度异方差"对冲

**问题分析**：
```
现状：仅用ΔC_quote（USDT单位），但在低成交额窗口：
- ΔC的波动性随quoteVol急剧变化
- Z-score虽能部分吸收，但会放大尾部
- 缺少"归一化比率"特征

示例：
高流动期：quoteVol=10M, ΔC=500k → imbalance=5%
低流动期：quoteVol=10k, ΔC=5k → imbalance=50% (同样买盘占优，但绝对值差1000倍)
Z-score会把第二种情况误判为"超强信号"
```

**解决方案**：
```python
# 新增并行特征（理论边界[-1, 1]）
imbalance_ratio = ΔC_quote / max(quoteAssetVolume, ε)

# ε防止除0，建议1.0 USDT
```

**实施要求**：
- ✅ 不改变现有mix配方（权重保持1.2:0.4:0.4）
- ✅ 在meta输出ratio供回测对比
- ✅ 预留将来替换权重的开关

**配置新增**：
```json
"expose_meta.imbalance_ratio": true
```

---

### 2. OI对齐的"取前不取后"规则

**问题分析**：
```
现状：v7.2.35的align_oi_to_klines简单按timestamp匹配
风险：有些交易所OI帧时间戳落在bar内/后移几秒

错误示例：
K线closeTime: 1700003599999 (01:00:00结束)
OI timestamp:  1700003600500 (01:00:00.5，稍晚)
当前逻辑：不匹配（丢失数据）

正确做法：
向下取邻（last OI timestamp <= closeTime）
```

**解决方案**：
```python
def align_oi_to_klines_strict(
    oi_hist: Sequence[dict],
    klines: Sequence[Sequence]
) -> Tuple[List[float], float]:
    """
    取前不取后对齐规则

    Returns:
        (oi_vals, missing_ratio)
    """
    # 对每个K线的closeTime，找最近的 oi_ts <= closeTime
    # 如果找不到，用"延迟1栈"（前一根的OI）
    # 再找不到，填0
```

**验收标准**：
- 抽3个时段（高/常/低流动）随机20条
- 人工spot-check时间戳匹配率 ≥99%

**配置新增**：
```json
"oi_align_mode": "backward_fill",  // 向下取邻+延迟1栈
"oi_align_tolerance_ms": 5000      // 最大容忍时间差
```

---

### 3. 动态阈值再加"绝对下限+IQR护栏"

**问题分析**：
```
现状：min_quote = factor × rolling_median
风险：节假日整体成交额压低，median被拖累

示例：
正常期：median=100k, 阈值=5k
节假日：median=10k, 阈值=500 (过低！)
```

**解决方案**：
```python
# 增强公式
min_total_quote_i = max(
    factor × median,           # v7.2.35原逻辑
    iqr_floor,                 # IQR护栏（新增）
    fallback                   # 绝对下限
)

# IQR护栏计算
iqr_floor = max(0, Q1 - 1.5 × IQR)

# 最后clamp到[fallback, +∞)
```

**实施要求**：
- Q1 = 25th percentile
- IQR = Q3 - Q1
- 防止在极端情况下阈值过低

**配置新增**：
```json
"min_quote_iqr_floor_enable": true
```

---

### 4. 对齐降级触发后的"回写标记"

**问题分析**：
```
现状：丢弃率>5%自动降级为单侧CVD，但没有标记
风险：下游把"降级数据"与"正常双侧数据"混堆做回测

后果：
- 回测误判信号强度
- 实盘与回测口径不一致
```

**解决方案**：
```python
# cvd_combined返回值增强
def cvd_combined(...) -> Tuple[List[float], dict]:
    """
    Returns:
        (cvd_series, meta)
        meta = {
            "degraded": bool,           # 是否降级
            "degrade_reason": str,      # 降级原因
            "discard_ratio": float,     # 丢弃率
            "futures_weight": float,
            "spot_weight": float,
            "skipped_count": int,
            "skipped_ratio": float
        }
    """
```

**灰度观察**：
- 统计symbol×interval的degraded_ratio
- >5%的标的列入观察池

**配置已有**（无需新增）：
```json
"max_discard_ratio": 0.05
```

---

### 5. 最后一根未收盘K线过滤

**问题分析**：
```
现状：实盘拉取时常出现"正在形成"的最后一根K线
风险：未完成的K线数据不完整

示例：
当前时间：01:00:05（刚过01:00）
最后一根：openTime=01:00:00, closeTime=01:59:59（还在形成中）
问题：这根K线的volume/CVD还在变化
```

**解决方案**：
```python
def filter_unclosed_klines(
    klines: Sequence[Sequence],
    now_ms: int,
    safety_lag_ms: int = 5000
) -> Tuple[List[List], int]:
    """
    过滤未收盘K线

    规则：now < closeTime + safety_lag_ms 一律不参与计算

    Returns:
        (filtered_klines, filtered_count)
    """
```

**日志增强**：
- 输出被过滤根数
- 避免误判"数据缺失"

**配置新增**：
```json
"safety_lag_ms": 5000  // 默认5秒安全延迟
```

---

### 6. 滚动Z的窗口边界一致性

**问题分析**：
```
现状：价格/OI/ΔC的有效样本长度可能不同
风险：rolling_z对不同长度序列做Z-score，窗口起点不一致

示例：
cvd长度：240根
closes长度：240根
oi_vals长度：230根（OI数据有缺失）

当前逻辑：
z_cvd = rolling_z(delta_cvd, window=96)  # 从第0根开始
z_oi = rolling_z(d_oi, window=96)        # 也从第0根开始，但实际只有230根

问题：索引[230:]的z_oi是基于不足230根的数据
```

**解决方案**：
```python
# 统一索引切齐
n = min(len(cvd), len(closes), len(oi_vals))
cvd = cvd[-n:]
closes = closes[-n:]
oi_vals = oi_vals[-n:]

# 再做变换
delta_cvd = _diff(cvd)
ret_p = _pct_change(closes)
d_oi = _pct_change(oi_vals)

# 统一rolling_z（此时三者长度相同）
z_cvd = rolling_z(delta_cvd, window=rolling_window)
z_p = rolling_z(ret_p, window=rolling_window)
z_oi = rolling_z(d_oi, window=rolling_window)
```

**单元测试**：
- 构造不同长度序列
- 确认首window-1根全为0

**配置已有**（无需新增）：
```json
"rolling_window": 96
```

---

## 高性价比改进（3项建议）

### 1. 权重模式声明式配置

**现状**：v7.2.35采用区间权重，但配置中不明确

**改进**：
```json
"weight_mode": "block_total",      // 固定声明
"use_per_kline_weight": false      // 保留实现但默认关闭
```

**优势**：
- 避免未来混淆
- 明确当前策略

---

### 2. 异常值软截断只对ΔC生效

**现状**：v7.2.35的outlier_handling可能对所有变量生效

**改进**：
```json
"outlier_handling": "iqr",
"outlier.apply_to": "delta_cvd"  // 明确只对ΔC
```

**理由**：
- 价格收益/ΔOI天然受限（百分比变化）
- 只有ΔC需要软截断

---

### 3. 日志降噪

**现状**：每根K线都输出统计日志，可能造成日志风暴

**改进**：
```python
# 每60根聚合输出一次
if i % 60 == 0:
    log(f"[{symbol}/{interval}] CVD统计: ...")
```

**配置新增**：
```json
"log_aggregate_every": 60
```

---

## 配置文件完整清单

### config/signal_thresholds.json新增参数

```json
"CVD计算参数": {
    "_version": "v4.0",
    "_enhancements": [
        "v7.2.34: P1-openTime对齐, P1-滚动Z, P2-Quote CVD",
        "v7.2.35: P1-CVD增量修复, P1-OI对齐, P1-动态阈值",
        "v7.2.36: 6个必补条件+3个高性价比改进"
    ],

    // v7.2.35参数（保留）
    "use_quote": true,
    "rolling_window": 96,
    "use_robust_zscore": true,
    "min_quote_factor": 0.05,
    "min_quote_window": 96,
    "min_quote_fallback": 10000,
    "max_discard_ratio": 0.05,

    // v7.2.36新增（必补条件）
    "expose_meta.imbalance_ratio": true,      // 条件1
    "oi_align_mode": "backward_fill",         // 条件2
    "oi_align_tolerance_ms": 5000,            // 条件2
    "min_quote_iqr_floor_enable": true,       // 条件3
    "safety_lag_ms": 5000,                    // 条件5

    // v7.2.36新增（高性价比改进）
    "weight_mode": "block_total",             // 改进1
    "use_per_kline_weight": false,            // 改进1
    "outlier.apply_to": "delta_cvd",          // 改进2
    "log_aggregate_every": 60                 // 改进3
}
```

---

## 验收用例清单（14项）

### v7.2.35已有测试（8项）
1. ✅ ΔC与pct_change区分
2. ✅ spot为空通路
3. ✅ 对齐强约束
4. ✅ 动态阈值
5. ✅ 权重模式一致
6. ✅ 滚动Z无前视
7. ✅ 异常值软截断
8. ✅ 端到端对账

### v7.2.36新增测试（6项）
9. **比值边界测试** - 验证|imbalance_ratio| ≤ 1 + 1e-6
10. **取前不取后测试** - OI时间戳略晚于closeTime不被错误匹配
11. **未收盘过滤测试** - 最后一根正在形成的K线不进入计算
12. **IQR护栏生效测试** - 节假日超低量期阈值不低于fallback
13. **降级可观测测试** - 10%丢弃率触发degraded=true
14. **重复时间戳防御测试** - 重复openTime触发assert并fail fast

---

## 灰度与回滚策略

### 灰度方案
- **范围**: 20%标的
- **时长**: 1小时
- **观察指标**:
  1. `discard_ratio` - K线对齐丢弃率
  2. `skipped_ratio` - 成交额过滤跳过率
  3. `degraded_ratio` - 自动降级比率
  4. `|mix|>3σ频次` - 极端值出现频率

### 回滚条件
⚠️ **立即切回v7.2.34**，如果满足以下任一条件：
- 任一标的`degraded_ratio > 10%`
- `|mix|>3σ`占比较历史提升>30%

### 回滚简化
✅ **快速回滚**（只需修改配置）：
```json
{
    "weight_mode": "block_total",
    "min_quote_iqr_floor_enable": false,  // 关闭IQR护栏
    "outlier_handling": "iqr",            // 关闭软截断
    "oi_align_mode": "simple"             // 简化OI对齐
}
```

---

## 文件修改清单

### 1. config/signal_thresholds.json
- 新增10个配置参数（6必补+3改进+1已有调整）

### 2. ats_core/utils/cvd_utils.py
**新增函数**：
- `align_oi_to_klines_strict` - 取前不取后对齐
- `compute_dynamic_min_quote_enhanced` - IQR护栏增强
- `filter_unclosed_klines` - 未收盘K线过滤
- `apply_outlier_handling` - 异常值软截断（仅对ΔC）

**增强函数**：
- `align_klines_by_open_time` - 添加重复时间戳检测

### 3. ats_core/features/cvd.py
**修改函数**：
- `cvd_from_klines` - 输出imbalance_ratio到meta
- `cvd_combined` - 返回meta字典（degraded标志）
- `cvd_mix_with_oi_price` - 统一索引切齐+mix_meta输出

---

## 专家点评总结

✅ **v7.2.35方向正确**：
- 修掉ΔC百分比bug
- 补OI对齐和动态阈值
- 这些是影响胜率的真因子

⚠️ **容易踩雷的地方**：
- 低流动时段（需要imbalance_ratio+IQR护栏）
- 对齐降级的可观测性（需要degraded标志）

✅ **做完v7.2.36后的收益**：
- C因子具备"跨币、跨时段可比"的基本素质
- 回测不虚胖，实盘不打脸
- 后续可考虑multi-TF口径统一与权重模式切换

---

## 下一步行动

1. ✅ 修改config/signal_thresholds.json（10个新参数）
2. ✅ 修改ats_core/utils/cvd_utils.py（4个新函数+增强）
3. ✅ 修改ats_core/features/cvd.py（3个函数增强+meta输出）
4. ✅ 运行14项验收测试
5. ✅ 创建v7.2.36技术文档
6. ✅ 提交Git commit

**预估耗时**: ~4小时（核心修复+测试验证+文档）
