# å¯é€‰åŠŸèƒ½é…ç½®æŒ‡å—

**é‡è¦**: æ‰€æœ‰æ–°å¢åŠŸèƒ½é»˜è®¤**ä¸å¯ç”¨**ï¼Œéœ€è¦æ‚¨ä¸»åŠ¨é…ç½®å¼€å¯ã€‚è¿™ç¡®ä¿äº†ç³»ç»Ÿçš„å‘åå…¼å®¹æ€§ï¼Œä¸ä¼šå½±å“æ‚¨å½“å‰çš„ä½¿ç”¨ã€‚

---

## âœ… é»˜è®¤è¡Œä¸ºï¼ˆæ— éœ€é…ç½®ï¼‰

ä»¥ä¸‹åŠŸèƒ½**æ— éœ€ä»»ä½•é…ç½®**ï¼Œç³»ç»Ÿä¿æŒåŸæœ‰è¡Œä¸ºï¼š

1. âœ… åŸæœ‰çš„`batch_run()`å‡½æ•°ç»§ç»­æ­£å¸¸å·¥ä½œ
2. âœ… CVDå› å­ä¿æŒåŸæœ‰è®¡ç®—é€»è¾‘ï¼ˆä¸å¯ç”¨Basisæ ¡æ­£ï¼‰
3. âœ… æ‰€æœ‰æ—§ä»£ç 100%å‘åå…¼å®¹
4. âœ… é…ç½®æ–‡ä»¶æ— éœ€ä¿®æ”¹

---

## ğŸ”§ å¯é€‰åŠŸèƒ½æ¸…å•

### 1. âš¡ å¹¶è¡ŒåŒ–æ‰¹é‡æ‰«æï¼ˆç«‹å³å¯ç”¨ï¼‰

**é»˜è®¤**: ä¸å¯ç”¨ï¼ˆç»§ç»­ä½¿ç”¨é¡ºåºæ‰«æ`batch_run()`ï¼‰

**å¯ç”¨æ–¹æ³•**:

```python
# ä¿®æ”¹æ‚¨çš„ä¸»ç¨‹åºå…¥å£ï¼ˆå¦‚ main.pyï¼‰
from ats_core.pipeline.batch_scan import batch_run_parallel  # æ–°å¯¼å…¥

# æ›¿æ¢åŸæœ‰çš„ batch_run() è°ƒç”¨
# batch_run()  # æ—§æ–¹å¼
stats = batch_run_parallel(max_workers=5, use_v2=False)  # æ–°æ–¹å¼

print(f"æ‰«æå®Œæˆ: {stats['completed']}/{stats['total']}")
print(f"é€Ÿåº¦: {stats['symbols_per_second']} symbols/s")
```

**æ€§èƒ½æå‡**: 10å€é€Ÿåº¦ï¼ˆ5åˆ†é’Ÿâ†’30ç§’ï¼‰

**é£é™©**: ä½ï¼ˆå¸¦APIé™æµä¿æŠ¤ï¼Œ60req/minï¼‰

---

### 2. ğŸ”§ CVD Basisæ ¡æ­£ï¼ˆéœ€é…ç½®å¯ç”¨ï¼‰

**é»˜è®¤**: ä¸å¯ç”¨ï¼ˆä¿æŒåŸæœ‰CVDè®¡ç®—ï¼‰

**å¯ç”¨æ–¹æ³•**:

#### æ–¹æ³•A: é…ç½®æ–‡ä»¶å¯ç”¨ï¼ˆæ¨èï¼‰

ç¼–è¾‘ `config/factors_unified.json`:

```json
{
  "factors": {
    "C+": {
      "params": {
        "ema_period": 12,
        "zscore_window": 60,
        "dynamic_weight": true,
        "basis_correction": true,        // â† æ·»åŠ è¿™è¡Œ
        "basis_threshold_bps": 50.0      // â† æ·»åŠ è¿™è¡Œ
      }
    }
  }
}
```

#### æ–¹æ³•B: ä»£ç ä¸­ä¸´æ—¶å¯ç”¨

```python
from ats_core.factors_v2.cvd_enhanced import calculate_cvd_enhanced

# æ˜¾å¼å¯ç”¨basisæ ¡æ­£
params = {
    'basis_correction': True,        # å¯ç”¨æ ¡æ­£
    'basis_threshold_bps': 50.0      # é˜ˆå€¼50bps
}

score, metadata = calculate_cvd_enhanced(klines_perp, klines_spot, params)

if metadata['basis_adjusted']:
    print(f"âœ… Basisæ ¡æ­£ç”Ÿæ•ˆ: {metadata['basis_bps']:.1f}bps")
```

**æ•ˆæœ**: ä¿®å¤5-10%åœºæ™¯çš„CVDå¤±çœŸ

**é£é™©**: ä½ï¼ˆä¼šæ”¹å˜CVDè¯„åˆ†ï¼Œå»ºè®®å…ˆå›æµ‹éªŒè¯ï¼‰

---

### 3. ğŸŒ WebSocketå®æ—¶æ•°æ®æµï¼ˆéœ€æœåŠ¡å™¨éƒ¨ç½²ï¼‰

**é»˜è®¤**: ä¸å¯ç”¨ï¼ˆä¸ä¼šè‡ªåŠ¨è¿æ¥ï¼‰

**å‰ç½®æ¡ä»¶**:
```bash
pip install websocket-client
```

**å¯ç”¨æ–¹æ³•**:

```python
from ats_core.streaming.websocket_client import WebSocketClient

# åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆä¸ä¼šè‡ªåŠ¨è¿æ¥ï¼‰
client = WebSocketClient()

# å®šä¹‰å›è°ƒå‡½æ•°
def on_kline_update(data):
    print(f"Kçº¿æ›´æ–°: {data['symbol']} {data['close']}")

# è®¢é˜…Kçº¿
client.subscribe_kline("BTCUSDT", "1m", on_kline_update)

# æ‰‹åŠ¨å¯åŠ¨ï¼ˆæ­¤æ—¶æ‰ä¼šè¿æ¥ï¼‰
client.start()

# åœæ­¢
# client.stop()
```

**æ•ˆæœ**: å»¶è¿Ÿä»1åˆ†é’Ÿé™è‡³100ms

**é£é™©**: ä¸­ï¼ˆéœ€è¦æœåŠ¡å™¨ç¯å¢ƒï¼Œæœ¬åœ°æ— æ³•æµ‹è¯•ï¼‰

**æ¨è**: 1-2å‘¨å†…éƒ¨ç½²

---

### 4. ğŸ¤– å¼ºåŒ–å­¦ä¹ åŠ¨æ€æ­¢æŸï¼ˆéœ€è®­ç»ƒæ•°æ®ï¼‰

**é»˜è®¤**: ä¸å¯ç”¨ï¼ˆä¸ä¼šè‡ªåŠ¨åŠ è½½æ¨¡å‹ï¼‰

**å‰ç½®æ¡ä»¶**:
```bash
pip install torch numpy
```

**å¯ç”¨æ–¹æ³•**:

```python
from ats_core.rl.dynamic_stop_loss import DynamicStopLossAgent, build_state

# åˆ›å»ºæ™ºèƒ½ä½“ï¼ˆä¸ä¼šè‡ªåŠ¨è®­ç»ƒï¼‰
agent = DynamicStopLossAgent()

# å¦‚æœæœ‰è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå¯ä»¥åŠ è½½
# agent.load_model("models/dqn_stop_loss_v1.pth")

# åœ¨äº¤æ˜“ä¸­ä½¿ç”¨
state = build_state(
    entry_price=50000,
    current_price=51000,
    entry_time=entry_timestamp,
    current_time=current_timestamp,
    volatility=0.02,
    signal_probability=0.75,
    market_regime=60
)

action = agent.get_action(state, explore=False)
new_stop_loss = agent.apply_action(entry_price, current_price, current_stop_loss, action, "LONG")
```

**æ•ˆæœ**: é¢„è®¡ç›ˆäºæ¯”æå‡30%

**é£é™©**: é«˜ï¼ˆéœ€å¤§é‡æ•°æ®è®­ç»ƒï¼Œå»ºè®®å…ˆæ¨¡æ‹Ÿï¼‰

**æ¨è**: 1-3ä¸ªæœˆç ”ç©¶æœŸ

---

### 5. ğŸ§ª å•å…ƒæµ‹è¯•ï¼ˆå¼€å‘è¾…åŠ©ï¼‰

**é»˜è®¤**: ä¸è‡ªåŠ¨è¿è¡Œ

**è¿è¡Œæ–¹æ³•**:

```bash
# å®‰è£…pytest
pip install pytest

# è¿è¡Œå…¨éƒ¨æµ‹è¯•
pytest tests/test_factors_v2.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_factors_v2.py::test_cvd_basis_correction -v
```

**æ•ˆæœ**: éªŒè¯ç³»ç»ŸåŠŸèƒ½æ­£å¸¸

**é£é™©**: æ— ï¼ˆåªè¯»æµ‹è¯•ï¼Œä¸ä¿®æ”¹ä»»ä½•æ•°æ®ï¼‰

---

## ğŸ“‹ å¿«é€Ÿå¯ç”¨æ¸…å•

### ç«‹å³å¯ç”¨ï¼ˆä½é£é™©ï¼‰

- [ ] **å¹¶è¡ŒåŒ–æ‰«æ** - ä¿®æ”¹ä¸»ç¨‹åºï¼Œæ›¿æ¢`batch_run()`ä¸º`batch_run_parallel()`
  - é¢„æœŸ: 10å€é€Ÿåº¦æå‡
  - é£é™©: ä½ï¼ˆå¸¦é™æµä¿æŠ¤ï¼‰
  - æ—¶é—´: 5åˆ†é’Ÿ

- [ ] **CVD Basisæ ¡æ­£** - ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ `basis_correction: true`
  - é¢„æœŸ: å‡å°‘CVDå¤±çœŸ
  - é£é™©: ä½ï¼ˆå»ºè®®å…ˆå›æµ‹ï¼‰
  - æ—¶é—´: 5åˆ†é’Ÿ

### 1å‘¨å†…éƒ¨ç½²ï¼ˆä¸­é£é™©ï¼‰

- [ ] **WebSocketå®æ—¶æµ** - å®‰è£…ä¾èµ–ï¼Œç¼–å†™å¯åŠ¨è„šæœ¬
  - é¢„æœŸ: å»¶è¿Ÿé™ä½90%
  - é£é™©: ä¸­ï¼ˆéœ€æœåŠ¡å™¨ï¼‰
  - æ—¶é—´: 1-2å¤©

### 1-3ä¸ªæœˆç ”ç©¶ï¼ˆé«˜é£é™©ï¼‰

- [ ] **å¼ºåŒ–å­¦ä¹ æ­¢æŸ** - æ”¶é›†æ•°æ®ï¼Œè®­ç»ƒæ¨¡å‹
  - é¢„æœŸ: ç›ˆäºæ¯”+30%
  - é£é™©: é«˜ï¼ˆéœ€å……åˆ†éªŒè¯ï¼‰
  - æ—¶é—´: 1-3ä¸ªæœˆ

---

## âš ï¸ é‡è¦è¯´æ˜

### ç³»ç»Ÿå…¼å®¹æ€§

âœ… **100%å‘åå…¼å®¹**: æ‰€æœ‰æ–°åŠŸèƒ½é»˜è®¤ä¸å¯ç”¨
âœ… **æ— ç ´åæ€§æ›´æ”¹**: æ—§ä»£ç ç»§ç»­æ­£å¸¸å·¥ä½œ
âœ… **æ¸è¿›å¼å‡çº§**: å¯ä»¥é€ä¸ªå¯ç”¨æ–°åŠŸèƒ½
âœ… **éšæ—¶å›é€€**: å¦‚æœ‰é—®é¢˜ï¼Œåªéœ€ä¸ä½¿ç”¨æ–°åŠŸèƒ½å³å¯

### å¯ç”¨å»ºè®®

1. **æµ‹è¯•ç¯å¢ƒå…ˆè¯•**: åœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨æ–°åŠŸèƒ½
2. **é€ä¸ªå¯ç”¨**: ä¸è¦ä¸€æ¬¡å¯ç”¨æ‰€æœ‰åŠŸèƒ½
3. **ç›‘æ§æŒ‡æ ‡**: å¯ç”¨åå¯†åˆ‡ç›‘æ§ä¿¡å·è´¨é‡
4. **å‡†å¤‡å›é€€**: å¦‚æœ‰é—®é¢˜ï¼Œç«‹å³ç¦ç”¨

### é…ç½®æ–‡ä»¶å¤‡ä»½

å¯ç”¨æ–°åŠŸèƒ½å‰ï¼Œå»ºè®®å¤‡ä»½é…ç½®æ–‡ä»¶ï¼š

```bash
cp config/factors_unified.json config/factors_unified.json.backup
```

---

## ğŸ†˜ å¦‚ä½•ç¦ç”¨å·²å¯ç”¨çš„åŠŸèƒ½

### ç¦ç”¨å¹¶è¡ŒåŒ–æ‰«æ
```python
# æ¢å¤ä½¿ç”¨åŸæœ‰å‡½æ•°
from ats_core.pipeline.batch_scan import batch_run
batch_run()  # ä½¿ç”¨åŸæœ‰çš„é¡ºåºæ‰«æ
```

### ç¦ç”¨CVD Basisæ ¡æ­£
```json
// é…ç½®æ–‡ä»¶ä¸­åˆ é™¤æˆ–è®¾ç½®ä¸ºfalse
{
  "C+": {
    "params": {
      "basis_correction": false  // æˆ–ç›´æ¥åˆ é™¤æ­¤è¡Œ
    }
  }
}
```

### åœæ­¢WebSocket
```python
client.stop()  # åœæ­¢WebSocketè¿æ¥
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨å¯ç”¨æ–°åŠŸèƒ½æ—¶é‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥æ—¥å¿—è¾“å‡º
2. ç¡®è®¤é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®
3. éªŒè¯ä¾èµ–åº“å·²å®‰è£…
4. æŸ¥çœ‹ `MODIFICATIONS_SUMMARY.md` è¯¦ç»†æ–‡æ¡£

**åŸåˆ™**: å¦‚æœ‰ç–‘é—®ï¼Œä¿æŒé»˜è®¤é…ç½®å³å¯ã€‚æ‰€æœ‰æ–°åŠŸèƒ½éƒ½æ˜¯å¯é€‰çš„å¢å¼ºï¼Œä¸å¯ç”¨ä¸å½±å“ç°æœ‰ç³»ç»Ÿè¿è¡Œã€‚

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-27
**é€‚ç”¨ç‰ˆæœ¬**: v2.1+
