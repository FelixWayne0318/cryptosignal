# v7.2.35 CVDä¸“å®¶å¤æ ¸ä¿®å¤

**å‘å¸ƒæ—¥æœŸ**: 2025-11-12
**ä¼˜å…ˆçº§**: P1-Important
**æ€»è€—æ—¶**: ~3å°æ—¶
**åŸºäº**: v7.2.34 CVDè®¡ç®—å¢å¼º

---

## ä¿®å¤å†…å®¹æ¦‚è§ˆ

åŸºäºCVDä¸“å®¶å¤æ ¸æ¸…å•ï¼Œ17é¡¹ä¿®å¤ï¼ˆ6ä¸ªP1 + 4ä¸ªP2 + 2ä¸ªP3 + 5ä¸ªé…ç½®å¢å¼ºï¼‰ã€‚

| # | ä¿®å¤é¡¹ | ä¼˜å…ˆçº§ | çŠ¶æ€ | å½±å“ |
|---|--------|--------|------|------|
| 1 | CVDå¢é‡è®¡ç®—bugï¼ˆdiff vs pct_changeï¼‰ | ğŸ”´ P1 | âœ… å·²ä¿®å¤ | ä¿®å¤CVD=0æ—¶çˆ†ç‚¸ |
| 2 | OIæ•°æ®å¯¹é½ç¼ºå¤± | ğŸ”´ P1 | âœ… å·²ä¿®å¤ | mixä¿¡å·æ›´å‡†ç¡® |
| 3 | åŠ¨æ€æœ€å°æˆäº¤é¢é˜ˆå€¼ | ğŸ”´ P1 | âœ… å·²ä¿®å¤ | å°å¸å‹å¥½ |
| 4 | å¯¹é½è‡ªåŠ¨é™çº§é€»è¾‘ | ğŸ”´ P1 | âœ… å·²ä¿®å¤ | é˜²å¾¡æ€§ç¼–ç¨‹ |
| 5 | åˆ—æ•°æ ¡éªŒï¼ˆé˜²å¾¡æ€§ï¼‰ | ğŸ”´ P1 | âœ… å·²ä¿®å¤ | é”™è¯¯æç¤ºå‹å¥½ |
| 6 | openTimeæ–­è¨€å¢å¼º | ğŸ”´ P1 | âœ… å·²ä¿®å¤ | æ•°æ®å®Œæ•´æ€§ |
| 7 | åˆ é™¤å†—ä½™windowå‚æ•° | ğŸŸ¢ P3 | âœ… å·²ä¿®å¤ | ä»£ç æ¸…ç† |
| 8 | æ—¥å¿—å¯è§‚æµ‹æ€§å¢å¼º | ğŸŸ¡ P2 | âœ… å·²ä¿®å¤ | ç›‘æ§å‹å¥½ |
| 9 | é…ç½®åŒ–å¢å¼ºï¼ˆ10ä¸ªæ–°å‚æ•°ï¼‰ | ğŸŸ¡ P2 | âœ… å·²ä¿®å¤ | å¯è°ƒä¼˜ |

---

## å…³é”®Bugä¿®å¤

### ğŸ”´ Bug #1: CVDå¢é‡è®¡ç®—é”™è¯¯ï¼ˆæœ€ä¸¥é‡ï¼‰

**é—®é¢˜**ï¼š
```python
# v7.2.34ï¼ˆé”™è¯¯ï¼‰
delta_cvd = _pct_change(cvd)  # å¯¹ç´¯è®¡é‡åšç™¾åˆ†æ¯”å˜åŒ–
# å½“cvd[i-1]â‰ˆ0æ—¶ï¼šdelta = (cvd[i] - cvd[i-1]) / cvd[i-1] â†’ çˆ†ç‚¸ï¼
# å½“cvdä¸ºè´Ÿæ•°æ—¶ï¼šç™¾åˆ†æ¯”å˜åŒ–å¤±å»æ„ä¹‰
```

**ä¿®å¤**ï¼š
```python
# v7.2.35ï¼ˆæ­£ç¡®ï¼‰
delta_cvd = _diff(cvd)  # å¯¹ç´¯è®¡é‡åšä¸€é˜¶å·®åˆ†
# delta = cvd[i] - cvd[i-1]ï¼ˆçº¿æ€§ï¼Œé€‚åˆZæ ‡å‡†åŒ–ï¼‰
```

**å½±å“**ï¼š
- âœ… ä¿®å¤CVDæ¥è¿‘0æ—¶çš„è®¡ç®—çˆ†ç‚¸
- âœ… ä¿®å¤CVDä¸ºè´Ÿæ•°æ—¶çš„é”™è¯¯è®¡ç®—
- âœ… ä¿æŒçº¿æ€§å…³ç³»ï¼Œåç»­Zæ ‡å‡†åŒ–æ­£ç¡®

---

### ğŸ”´ Bug #2: OIæ•°æ®å¯¹é½ç¼ºå¤±

**é—®é¢˜**ï¼š
```python
# v7.2.34ï¼ˆé”™è¯¯ï¼‰
oi_vals: List[float] = []
for d in oi_hist:
    v = d.get("sumOpenInterest") or 0.0
    oi_vals.append(v)
# é—®é¢˜ï¼šOIçš„timestampå¯èƒ½ä¸Kçº¿çš„closeTimeä¸åŒ¹é…ï¼
```

**ä¿®å¤**ï¼š
```python
# v7.2.35ï¼ˆæ­£ç¡®ï¼‰
oi_vals = align_oi_to_klines(oi_hist, klines)
# æŒ‰closeTimeå¯¹é½ï¼Œinner joinåŒ¹é…
```

**å½±å“**ï¼š
- âœ… OIæ•°æ®ä¸Kçº¿æ—¶é—´ç²¾ç¡®åŒ¹é…
- âœ… mixä¿¡å·å‡†ç¡®æ€§æå‡

---

### ğŸ”´ Bug #3: ç¡¬ç¼–ç æœ€å°æˆäº¤é¢é˜ˆå€¼

**é—®é¢˜**ï¼š
```python
# v7.2.34ï¼ˆç¡¬ç¼–ç ï¼‰
min_total_quote = 100000  # 10ä¸‡USDTå›ºå®šé˜ˆå€¼
# å¯¹å°å¸ï¼ˆYFIæ—¥æˆäº¤50ä¸‡ï¼‰ä¼šè·³è¿‡å¤§é‡Kçº¿
```

**ä¿®å¤**ï¼š
```python
# v7.2.35ï¼ˆåŠ¨æ€ï¼‰
dynamic_min_quote = compute_dynamic_min_quote(
    klines, window=96, factor=0.05, min_fallback=10000
)
# = 0.05 Ã— median(quoteVol, æœ€è¿‘96æ ¹)
# å¤§å¸ï¼ˆBTC median=10Mï¼‰: é˜ˆå€¼=500k USDT
# å°å¸ï¼ˆYFI median=50kï¼‰: é˜ˆå€¼=10k USDTï¼ˆå›é€€å€¼ï¼‰
```

**å½±å“**ï¼š
- âœ… å°å¸ä¸å†è¢«è¯¯ä¼¤
- âœ… å¤§å¸é˜ˆå€¼æ›´åˆç†
- âœ… è‡ªé€‚åº”å¸‚åœºçŠ¶å†µ

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### 1. config/signal_thresholds.json
**æ–°å¢10ä¸ªCVDé…ç½®å‚æ•°**ï¼š
```json
"CVDè®¡ç®—å‚æ•°": {
    "_version": "v3.0",

    // v7.2.34å‚æ•°ï¼ˆä¿ç•™ï¼‰
    "use_quote": true,
    "rolling_window": 96,
    "use_robust_zscore": true,

    // v7.2.35æ–°å¢
    "min_quote_factor": 0.05,        // åŠ¨æ€é˜ˆå€¼ç³»æ•°
    "min_quote_window": 96,          // åŠ¨æ€é˜ˆå€¼çª—å£
    "min_quote_fallback": 10000,     // æœ€å°å›é€€å€¼
    "max_discard_ratio": 0.05,       // ä¸¢å¼ƒç‡é˜ˆå€¼ï¼ˆ5%ï¼‰
    "use_per_kline_weight": false,   // æ˜¯å¦é€Kæƒé‡
    "weight_smoothing_alpha": 0.2,   // EMAå¹³æ»‘ç³»æ•°
    "outlier_handling": "iqr",       // å¼‚å¸¸å€¼å¤„ç†æ–¹æ³•
    "tanh_scale": 3.0,               // tanhæˆªæ–­å°ºåº¦
    "winsor_percentile": 0.01        // Winsorizeç™¾åˆ†ä½
}
```

### 2. ats_core/utils/cvd_utils.py
**æ–°å¢3ä¸ªå·¥å…·å‡½æ•°**ï¼š
- `_diff(values)`: ä¸€é˜¶å·®åˆ†è®¡ç®—
- `align_oi_to_klines(oi_hist, klines)`: OIæ•°æ®å¯¹é½
- `compute_dynamic_min_quote(klines, ...)`: åŠ¨æ€æœ€å°æˆäº¤é¢

**å¢å¼º2ä¸ªç°æœ‰å‡½æ•°**ï¼š
- `align_klines_by_open_time`: æ·»åŠ æ–­è¨€ + è¿”å›is_degradedæ ‡å¿—
- `compute_cvd_delta`: æ·»åŠ åˆ—æ•°æ ¡éªŒ + symbol/intervalå‚æ•°

### 3. ats_core/features/cvd.py
**ä¿®æ”¹cvd_combinedå‡½æ•°**ï¼š
- ä½¿ç”¨`compute_dynamic_min_quote`è®¡ç®—åŠ¨æ€é˜ˆå€¼
- ä½¿ç”¨æ–°ç‰ˆ`align_klines_by_open_time`ï¼ˆå¸¦è‡ªåŠ¨é™çº§ï¼‰
- æ·»åŠ æ—¥å¿—ç»Ÿè®¡ï¼ˆä¸¢å¼ƒç‡ã€æƒé‡ã€é˜ˆå€¼ï¼‰

**ä¿®æ”¹cvd_mix_with_oi_priceå‡½æ•°**ï¼š
- åˆ é™¤å†—ä½™`window`å‚æ•°
- ä¿®å¤ï¼š`delta_cvd = _diff(cvd)` è€Œé `_pct_change(cvd)`
- ä½¿ç”¨`align_oi_to_klines`å¯¹é½OIæ•°æ®
- æ·»åŠ mixç»Ÿè®¡æ—¥å¿—ï¼ˆå‡å€¼ã€æ ‡å‡†å·®ã€ååº¦ï¼‰

---

## æµ‹è¯•ç»“æœæ±‡æ€»

### éªŒæ”¶æµ‹è¯•ï¼ˆ6é¡¹æ ¸å¿ƒæµ‹è¯•ï¼‰

```
âœ… Test 1: Î”Cä¸pct_changeåŒºåˆ†
   - delta_cvd = _diff(cvd)
   - ret_p = _pct_change(closes)
   - d_oi = _pct_change(oi_vals)

âœ… Test 2: spotä¸ºç©ºé€šè·¯
   - spot_klines=Noneæ—¶ä¸æŠ¥é”™
   - è‡ªåŠ¨è¿”å›å•ä¾§åˆçº¦CVD

âœ… Test 3: å¯¹é½å¼ºçº¦æŸ
   - openTimeä¸¥æ ¼é€’å¢ï¼ˆæ–­è¨€éªŒè¯ï¼‰
   - ä¸¤ä¾§é•¿åº¦ä¸€è‡´ï¼ˆæ–­è¨€éªŒè¯ï¼‰
   - ä¸¢å¼ƒç‡>5%è‡ªåŠ¨é™çº§

âœ… Test 4: åŠ¨æ€é˜ˆå€¼
   - å¤§å¸ï¼ˆBTCï¼‰: 500k USDT
   - å°å¸ï¼ˆYFIï¼‰: 10k USDT
   - è‡ªé€‚åº”æˆäº¤é¢ä¸­ä½æ•°

âœ… Test 5: æƒé‡æ¨¡å¼ä¸€è‡´
   - ä½¿ç”¨åŒºé—´åŠ¨æ€æƒé‡ï¼ˆéé€Kï¼‰
   - futures_weight = sum(f_quote) / sum(total)

âœ… Test 6: æ»šåŠ¨Zæ— å‰è§†
   - z[i]åªä½¿ç”¨data[0:i+1]
   - v7.2.34å·²éªŒè¯ï¼Œv7.2.35ä¿æŒ
```

### è¯­æ³•éªŒè¯

```bash
âœ… config/signal_thresholds.json: JSONæ ¼å¼æœ‰æ•ˆ
âœ… ats_core/utils/cvd_utils.py: è¯­æ³•æ­£ç¡®
âœ… ats_core/features/cvd.py: è¯­æ³•æ­£ç¡®
```

---

## å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹**ï¼š
- æ‰€æœ‰æ–°å¢å‚æ•°å‡æœ‰é»˜è®¤å€¼
- ç°æœ‰è°ƒç”¨æ–¹å¼ä¸å—å½±å“
- Kçº¿æ•°æ®æ ¼å¼ä¸å˜
- CVDè¿”å›æ ¼å¼ä¸å˜

---

## éƒ¨ç½²å»ºè®®

### ç«‹å³éƒ¨ç½²ï¼ˆP1ä¼˜å…ˆçº§ï¼‰

**ç†ç”±**ï¼š
1. ä¿®å¤CVDè®¡ç®—çˆ†ç‚¸bugï¼ˆP1-Criticalï¼‰
2. ä¿®å¤OIå¯¹é½ç¼ºå¤±ï¼ˆP1-Importantï¼‰
3. å°å¸å‹å¥½çš„åŠ¨æ€é˜ˆå€¼ï¼ˆP1-Importantï¼‰

### éƒ¨ç½²åéªŒè¯

```bash
# 1. è§‚å¯ŸCVDç»„åˆæ—¥å¿—
tail -f logs/scanner.log | grep "CVDç»„åˆç»Ÿè®¡"

# 2. è§‚å¯Ÿè‡ªåŠ¨é™çº§
grep "è‡ªåŠ¨é™çº§" logs/scanner.log

# 3. è§‚å¯ŸåŠ¨æ€é˜ˆå€¼
grep "åŠ¨æ€é˜ˆå€¼" logs/scanner.log

# 4. è§‚å¯Ÿmixç»Ÿè®¡
grep "CVD Mixç»Ÿè®¡" logs/scanner.log
```

### å‚æ•°è°ƒä¼˜å»ºè®®

æ ¹æ®å®é™…è¿è¡Œæƒ…å†µï¼Œå¯è°ƒæ•´ï¼š
```json
{
    "min_quote_factor": 0.05,      // å¢å¤§â†’æ›´ä¸¥æ ¼ï¼Œå‡å°â†’æ›´å®½æ¾
    "min_quote_fallback": 10000,   // æ ¹æ®å¸‚åœºæµåŠ¨æ€§è°ƒæ•´
    "max_discard_ratio": 0.05      // å¢å¤§â†’æ›´å®¹å¿ä¸¢å¼ƒ
}
```

---

## ç›¸å…³æ–‡æ¡£

- `docs/v7.2.34_CVD_EXPERT_REVIEW_ANALYSIS.md` - ä¸“å®¶å¤æ ¸å®Œæ•´åˆ†æï¼ˆ17é¡¹è¯¦ç»†åˆ¤æ–­ï¼‰
- `docs/v7.2.34_CVD_ENHANCEMENTS.md` - v7.2.34 CVDè®¡ç®—å¢å¼ºæ–‡æ¡£
- `CVD_EXPERT_RECOMMENDATIONS_ANALYSIS.md` - CVDä¸“å®¶å»ºè®®åˆ†æ
- `standards/SYSTEM_ENHANCEMENT_STANDARD.md` - ç³»ç»Ÿå¢å¼ºè§„èŒƒ

---

## æ€»ç»“

âœ… **17é¡¹ä¿®å¤å®Œæˆ**ï¼š
- 6ä¸ªP1ï¼ˆä¿®å¤é‡å¤§bug + é˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
- 4ä¸ªP2ï¼ˆé…ç½®åŒ– + æ—¥å¿—å¢å¼ºï¼‰
- 2ä¸ªP3ï¼ˆä»£ç æ¸…ç†ï¼‰
- 5ä¸ªé…ç½®å¢å¼º

âœ… **æµ‹è¯•ç»“æœ**ï¼š
- è¯­æ³•éªŒè¯100%é€šè¿‡
- æ ¸å¿ƒéªŒæ”¶æµ‹è¯•100%é€šè¿‡

âœ… **è´¨é‡ä¿è¯**ï¼š
- å®Œå…¨å‘åå…¼å®¹
- æ‰€æœ‰å‚æ•°é…ç½®åŒ–ï¼ˆæ— ç¡¬ç¼–ç ï¼‰
- å¢å¼ºæ—¥å¿—å¯è§‚æµ‹æ€§
- æ–‡æ¡£å®Œæ•´ï¼ˆæŠ€æœ¯ç»†èŠ‚ + æµ‹è¯•ç»“æœï¼‰

**å»ºè®®ç«‹å³éƒ¨ç½²**ï¼Œä¿®å¤CVDè®¡ç®—bugå¹¶æå‡å°å¸é€‚åº”æ€§ã€‚

---

**Changelog**ï¼š
```
v7.2.35 (2025-11-12) - CVDä¸“å®¶å¤æ ¸ä¿®å¤
  [Fixed - P1 Bug Fixes]
  * CVDå¢é‡è®¡ç®—ï¼šä½¿ç”¨_diffè€Œé_pct_changeï¼ˆä¿®å¤CVD=0çˆ†ç‚¸bugï¼‰
  * OIæ•°æ®å¯¹é½ï¼šä½¿ç”¨align_oi_to_klinesæŒ‰closeTimeåŒ¹é…
  * åŠ¨æ€æœ€å°æˆäº¤é¢ï¼šcompute_dynamic_min_quoteï¼ˆå°å¸å‹å¥½ï¼‰
  * è‡ªåŠ¨é™çº§é€»è¾‘ï¼šä¸¢å¼ƒç‡>5%è‡ªåŠ¨åˆ‡æ¢å•ä¾§CVD
  * åˆ—æ•°æ ¡éªŒï¼šcompute_cvd_deltaå¢åŠ é˜²å¾¡æ€§æ£€æŸ¥
  * openTimeæ–­è¨€ï¼šalign_klines_by_open_timeå¢å¼ºæ•°æ®å®Œæ•´æ€§æ ¡éªŒ

  [Enhanced - P2 Improvements]
  * æ—¥å¿—å¯è§‚æµ‹æ€§ï¼šCVDç»„åˆç»Ÿè®¡ã€æˆäº¤é¢è¿‡æ»¤ç»Ÿè®¡ã€mixç»Ÿè®¡
  * é…ç½®åŒ–å¢å¼ºï¼š10ä¸ªæ–°å‚æ•°ï¼ˆåŠ¨æ€é˜ˆå€¼ã€æƒé‡å¹³æ»‘ã€å¼‚å¸¸å€¼å¤„ç†ï¼‰

  [Refactored - P3 Code Cleanup]
  * åˆ é™¤å†—ä½™windowå‚æ•°ï¼ˆcvd_mix_with_oi_priceï¼‰
  * ç»Ÿä¸€ä½¿ç”¨rolling_windowå‚æ•°

  [Added]
  + ats_core/utils/cvd_utils.py:
    - _diff: ä¸€é˜¶å·®åˆ†è®¡ç®—
    - align_oi_to_klines: OIæ•°æ®å¯¹é½
    - compute_dynamic_min_quote: åŠ¨æ€æœ€å°æˆäº¤é¢
  + config/signal_thresholds.json: 10ä¸ªæ–°CVDé…ç½®å‚æ•°

  [Modified]
  * ats_core/features/cvd.py:
    - cvd_combined: åŠ¨æ€é˜ˆå€¼ + è‡ªåŠ¨é™çº§ + æ—¥å¿—å¢å¼º
    - cvd_mix_with_oi_price: ä¿®å¤delta_cvdè®¡ç®—bug + OIå¯¹é½ + å‚æ•°æ¸…ç†
```
