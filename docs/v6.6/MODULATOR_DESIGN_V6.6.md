# v6.6 å››è°ƒåˆ¶å™¨ç»Ÿä¸€æ¶æ„è¯¦ç»†è®¾è®¡

**ç‰ˆæœ¬**: v6.6 Beta
**æ—¥æœŸ**: 2025-11-03
**çŠ¶æ€**: è®¾è®¡ä¸­

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šL/S/F/I è°ƒåˆ¶å™¨ç»Ÿä¸€æ¡†æ¶

### 1.1 æ ¸å¿ƒç†å¿µ

**ç”¨æˆ·å†³ç­–**ï¼šé‡‡ç”¨æ–¹æ¡ˆB - L/S/F/Iç»Ÿä¸€è°ƒåˆ¶å™¨æ¶æ„

**è®¾è®¡å“²å­¦**ï¼š
- **å…¨è´¨é‡è°ƒåˆ¶**ï¼šL/S/F/Iéƒ½æ˜¯è´¨é‡æŒ‡æ ‡ï¼Œç»Ÿä¸€ç”¨è°ƒåˆ¶å™¨æ¨¡å¼
- **æ— ç¡¬é—¨æ§›**ï¼šç§»é™¤æ‰§è¡Œå±‚ç¡¬é—¨æ§›ï¼Œæ”¹ä¸ºå¹³æ»‘è°ƒåˆ¶
- **ååŒä½œç”¨**ï¼š4ä¸ªè°ƒåˆ¶å™¨å…±åŒå½±å“æœ€ç»ˆå†³ç­–
- **åˆ†å·¥æ˜ç¡®**ï¼šæ¯ä¸ªè°ƒåˆ¶å™¨æœ‰ä¸“å±çš„è°ƒåˆ¶å¯¹è±¡

### 1.2 å››è°ƒåˆ¶å™¨åˆ†å·¥

| è°ƒåˆ¶å™¨ | æ€§è´¨ | èŒƒå›´ | ä¸»è¦è°ƒåˆ¶å¯¹è±¡ | è°ƒåˆ¶é€»è¾‘ |
|--------|------|------|-------------|---------|
| **L** (æµåŠ¨æ€§) | æ‰§è¡Œè´¨é‡ | 0-100 | **position_size**, cost_eff | Lä½â†’å°ä»“ä½ï¼ŒLé«˜â†’å¤§ä»“ä½ |
| **S** (ç»“æ„) | ä¿¡å·è´¨é‡ | Â±100 | **confidence**, Teff | Så¥½â†’é«˜confidenceï¼ŒSå·®â†’ä½confidence |
| **F** (æ‹¥æŒ¤åº¦) | å¸‚åœºç¯å¢ƒ | Â±100 | **Teff**, p_min | Fé«˜(æ‹¥æŒ¤)â†’ä¿å®ˆï¼ŒFä½â†’æ¿€è¿› |
| **I** (ç‹¬ç«‹æ€§) | ç›¸å…³æ€§ | Â±100 | **Teff**, cost_eff | Ié«˜(ç‹¬ç«‹)â†’æ¿€è¿›ï¼ŒIä½(è·Ÿéš)â†’ä¿å®ˆ |

### 1.3 è°ƒåˆ¶å™¨è¾“å‡ºç»Ÿä¸€æ¥å£

```python
@dataclass
class ModulatorOutput:
    """è°ƒåˆ¶å™¨ç»Ÿä¸€è¾“å‡º"""

    # æ¸©åº¦è°ƒåˆ¶ï¼ˆå½±å“æ¦‚ç‡æ›²çº¿ï¼‰
    Teff: float  # æœ‰æ•ˆæ¸©åº¦ [25, 100]

    # æˆæœ¬è°ƒåˆ¶ï¼ˆå½±å“EVè®¡ç®—ï¼‰
    cost_eff: float  # æœ‰æ•ˆæˆæœ¬ [-0.005, +0.01]

    # é˜ˆå€¼è°ƒåˆ¶ï¼ˆå½±å“å‘å¸ƒé—¨æ§›ï¼‰
    p_min: float  # æœ€å°æ¦‚ç‡ [0.50, 0.75]
    delta_p_min: float  # æ¦‚ç‡å˜åŒ– [0.02, 0.05]

    # ç½®ä¿¡åº¦è°ƒåˆ¶ï¼ˆå½±å“ä»“ä½å’ŒPrimeè¯„åˆ†ï¼‰
    confidence_mult: float  # ç½®ä¿¡åº¦å€æ•° [0.5, 1.5]

    # ä»“ä½è°ƒåˆ¶ï¼ˆå½±å“ä»“ä½å¤§å°ï¼‰
    position_mult: float  # ä»“ä½å€æ•° [0.3, 1.0]

    # è¯Šæ–­ä¿¡æ¯
    details: Dict[str, Any]
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå„è°ƒåˆ¶å™¨è¯¦ç»†è®¾è®¡

### 2.1 Lè°ƒåˆ¶å™¨ï¼ˆæµåŠ¨æ€§ï¼‰

**è¾“å…¥**: `L âˆˆ [0, 100]` (0=æå·®ï¼Œ100=æå¥½)

**æ ¸å¿ƒæ€æƒ³**ï¼š
- æµåŠ¨æ€§å¥½ â†’ å¯ä»¥å¼€å¤§ä»“ä½ï¼Œé™ä½æˆæœ¬æƒ©ç½š
- æµåŠ¨æ€§å·® â†’ åªèƒ½å¼€å°ä»“ä½ï¼Œå¢åŠ æˆæœ¬æƒ©ç½š
- **ä¸å®Œå…¨æ‹’ç»**ï¼Œä½†é€šè¿‡å°ä»“ä½æ§åˆ¶é£é™©

**è°ƒåˆ¶å…¬å¼**ï¼š

```python
def modulate_liquidity(L: float) -> dict:
    """
    Lè°ƒåˆ¶å™¨ï¼šåŸºäºæµåŠ¨æ€§è´¨é‡è°ƒåˆ¶ä»“ä½å’Œæˆæœ¬

    Args:
        L: æµåŠ¨æ€§åˆ†æ•° [0, 100]

    Returns:
        è°ƒåˆ¶å‚æ•°
    """
    # å½’ä¸€åŒ–åˆ°[0, 1]
    L_norm = L / 100.0

    # 1. ä»“ä½è°ƒåˆ¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    # é€»è¾‘ï¼šLè¶Šä½ï¼Œä»“ä½è¶Šå°
    # L=100 â†’ 100%ä»“ä½
    # L=80  â†’ 90%ä»“ä½
    # L=60  â†’ 70%ä»“ä½
    # L=40  â†’ 45%ä»“ä½
    # L=20  â†’ 30%ä»“ä½ï¼ˆæœ€å°ä»“ä½ï¼‰
    if L_norm >= 0.8:
        position_mult = 0.9 + 0.1 * (L_norm - 0.8) / 0.2
    elif L_norm >= 0.6:
        position_mult = 0.7 + 0.2 * (L_norm - 0.6) / 0.2
    elif L_norm >= 0.4:
        position_mult = 0.45 + 0.25 * (L_norm - 0.4) / 0.2
    else:
        position_mult = 0.3 + 0.15 * L_norm / 0.4

    # 2. æˆæœ¬è°ƒåˆ¶
    # é€»è¾‘ï¼šLè¶Šä½ï¼Œæˆæœ¬æƒ©ç½šè¶Šé«˜
    # L=100 â†’ cost=0 (æ— é¢å¤–æˆæœ¬)
    # L=50  â†’ cost=+0.003 (0.3%é¢å¤–æˆæœ¬)
    # L=20  â†’ cost=+0.008 (0.8%é¢å¤–æˆæœ¬)
    cost_eff = 0.01 * (1.0 - L_norm)  # 0 to 0.01

    # 3. Teffè°ƒåˆ¶ï¼ˆå¯é€‰ï¼‰
    # é€»è¾‘ï¼šæµåŠ¨æ€§å·®æ—¶ç•¥å¾®æé«˜æ¸©åº¦ï¼ˆæ›´ä¿å®ˆï¼‰
    # L=100 â†’ Teff_mult=1.0
    # L=50  â†’ Teff_mult=1.1
    # L=20  â†’ Teff_mult=1.2
    Teff_mult = 1.0 + 0.2 * (1.0 - L_norm)

    return {
        "position_mult": position_mult,
        "cost_eff": cost_eff,
        "Teff_mult": Teff_mult,
        "L_norm": L_norm
    }
```

**å…³é”®è®¾è®¡**ï¼š
- **åˆ†æ®µå‡½æ•°**ï¼šL>80æ—¶ä»“ä½ä¸‹é™æ…¢ï¼ŒL<40æ—¶ä»“ä½ä¸‹é™å¿«
- **æœ€å°ä»“ä½30%**ï¼šå³ä½¿L=0ï¼Œä»ä¿ç•™30%ä»“ä½ï¼ˆé¿å…å®Œå…¨é”™è¿‡æœºä¼šï¼‰
- **æˆæœ¬æƒ©ç½š**ï¼šLä½æ—¶å¢åŠ æˆæœ¬ï¼Œé™ä½EVï¼Œè‡ªç„¶è¿‡æ»¤ä½è´¨é‡ä¿¡å·

---

### 2.2 Sè°ƒåˆ¶å™¨ï¼ˆç»“æ„ï¼‰

**è¾“å…¥**: `S âˆˆ [-100, +100]` (-100=ç»“æ„æ··ä¹±ï¼Œ+100=ç»“æ„å®Œæ•´)

**æ ¸å¿ƒæ€æƒ³**ï¼š
- ç»“æ„å¥½ â†’ ä¿¡å·å¯é æ€§é«˜ â†’ æé«˜confidence
- ç»“æ„å·® â†’ ä¿¡å·å¯é æ€§ä½ â†’ é™ä½confidence
- é€šè¿‡confidenceå½±å“ä»“ä½å’ŒPrimeè¯„åˆ†

**è°ƒåˆ¶å…¬å¼**ï¼š

```python
def modulate_structure(S: float) -> dict:
    """
    Sè°ƒåˆ¶å™¨ï¼šåŸºäºç»“æ„è´¨é‡è°ƒåˆ¶ç½®ä¿¡åº¦

    Args:
        S: ç»“æ„åˆ†æ•° [-100, +100]

    Returns:
        è°ƒåˆ¶å‚æ•°
    """
    # å½’ä¸€åŒ–åˆ°[0, 1]
    S_norm = (S + 100) / 200.0

    # 1. ç½®ä¿¡åº¦è°ƒåˆ¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    # é€»è¾‘ï¼šSè¶Šå¥½ï¼Œconfidenceå€å¢è¶Šå¤§
    # S=+100 â†’ confidenceÃ—1.3 (æå‡30%)
    # S=+50  â†’ confidenceÃ—1.15
    # S=0    â†’ confidenceÃ—1.0 (ä¸å˜)
    # S=-50  â†’ confidenceÃ—0.85
    # S=-100 â†’ confidenceÃ—0.7 (é™ä½30%)
    confidence_mult = 0.7 + 0.6 * S_norm

    # 2. Teffè°ƒåˆ¶ï¼ˆå¯é€‰ï¼‰
    # é€»è¾‘ï¼šç»“æ„å¥½æ—¶ç•¥å¾®é™ä½æ¸©åº¦ï¼ˆæ›´æ¿€è¿›ï¼‰
    # S=+100 â†’ Teff_mult=0.9
    # S=0    â†’ Teff_mult=1.0
    # S=-100 â†’ Teff_mult=1.1
    Teff_mult = 1.0 - 0.1 * (S_norm - 0.5)

    return {
        "confidence_mult": confidence_mult,
        "Teff_mult": Teff_mult,
        "S_norm": S_norm
    }
```

**å…³é”®è®¾è®¡**ï¼š
- **å¯¹ç§°è°ƒåˆ¶**ï¼šSå¥½å’ŒSå·®çš„å½±å“å¯¹ç§°ï¼ˆÂ±30%ï¼‰
- **å½±å“é“¾**ï¼šconfidence â†’ position_size (via Kelly) â†’ ä»“ä½è‡ªç„¶è°ƒæ•´
- **è¾…åŠ©Teff**ï¼šç»“æ„å¥½æ—¶ç¨å¾®æ¿€è¿›ï¼Œç»“æ„å·®æ—¶ç¨å¾®ä¿å®ˆ

---

### 2.3 Fè°ƒåˆ¶å™¨ï¼ˆæ‹¥æŒ¤åº¦ï¼‰

**è¾“å…¥**: `F âˆˆ [-100, +100]` (-100=ä¸æ‹¥æŒ¤ï¼Œ+100=æåº¦æ‹¥æŒ¤)

**æ ¸å¿ƒæ€æƒ³**ï¼š
- æ‹¥æŒ¤åº¦é«˜ â†’ å¸‚åœºå…±è¯†å¼º â†’ é£é™©é«˜ â†’ æé«˜é—¨æ§›
- æ‹¥æŒ¤åº¦ä½ â†’ å¸‚åœºåˆ†æ­§å¤§ â†’ æœºä¼šå¤š â†’ é™ä½é—¨æ§›

**è°ƒåˆ¶å…¬å¼**ï¼š

```python
def modulate_funding(F: float) -> dict:
    """
    Fè°ƒåˆ¶å™¨ï¼šåŸºäºæ‹¥æŒ¤åº¦è°ƒåˆ¶æ¸©åº¦å’Œé—¨æ§›

    Args:
        F: æ‹¥æŒ¤åº¦åˆ†æ•° [-100, +100]

    Returns:
        è°ƒåˆ¶å‚æ•°
    """
    # å½’ä¸€åŒ–åˆ°[0, 1]
    F_norm = (F + 100) / 200.0

    # åº”ç”¨tanhå¹³æ»‘ï¼ˆä¸­å¿ƒåŒ–åˆ°0.5ï¼‰
    gamma = 4.0
    g_F = math.tanh(gamma * (F_norm - 0.5))  # [-1, +1]

    # 1. Teffè°ƒåˆ¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    # é€»è¾‘ï¼šFé«˜(æ‹¥æŒ¤) â†’ Teffé«˜ â†’ æ¦‚ç‡æ›´ä¿å®ˆ
    # F=+100 â†’ Teff_mult=1.3
    # F=0    â†’ Teff_mult=1.0
    # F=-100 â†’ Teff_mult=0.85
    beta_F = 0.15
    Teff_mult = 1.0 + beta_F * g_F

    # 2. p_minè°ƒåˆ¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    # é€»è¾‘ï¼šFé«˜ â†’ p_miné«˜ â†’ æ›´éš¾å‘å¸ƒ
    # F=+100 â†’ p_min=0.58+0.05=0.63
    # F=0    â†’ p_min=0.58
    # F=-100 â†’ p_min=0.58
    theta_F = 0.05
    p_min_adj = theta_F * max(0.0, g_F)  # åªåœ¨F>0æ—¶æé«˜é—¨æ§›

    return {
        "Teff_mult": Teff_mult,
        "p_min_adj": p_min_adj,
        "g_F": g_F,
        "F_norm": F_norm
    }
```

**å…³é”®è®¾è®¡**ï¼š
- **éå¯¹ç§°é—¨æ§›**ï¼šåªåœ¨æ‹¥æŒ¤æ—¶æé«˜p_minï¼Œä¸æ‹¥æŒ¤æ—¶ä¸é™ä½ï¼ˆé¿å…è¿‡åº¦æ¿€è¿›ï¼‰
- **tanhå¹³æ»‘**ï¼šé¿å…æç«¯å€¼çš„çªå˜
- **å½±å“é“¾**ï¼šTeffâ†‘ â†’ Pæ›´ä¿å®ˆ, p_minâ†‘ â†’ å‘å¸ƒæ›´éš¾

---

### 2.4 Iè°ƒåˆ¶å™¨ï¼ˆç‹¬ç«‹æ€§ï¼‰

**è¾“å…¥**: `I âˆˆ [-100, +100]` (-100=å®Œå…¨è·Ÿéšï¼Œ+100=å®Œå…¨ç‹¬ç«‹)

**æ ¸å¿ƒæ€æƒ³**ï¼š
- ç‹¬ç«‹æ€§é«˜ â†’ ä¸å—å¤§ç›˜å½±å“ â†’ å¯ä»¥æ¿€è¿›
- ç‹¬ç«‹æ€§ä½ â†’ è·Ÿéšå¤§ç›˜ â†’ éœ€è¦ä¿å®ˆ

**è°ƒåˆ¶å…¬å¼**ï¼š

```python
def modulate_independence(I: float) -> dict:
    """
    Iè°ƒåˆ¶å™¨ï¼šåŸºäºç‹¬ç«‹æ€§è°ƒåˆ¶æ¸©åº¦å’Œæˆæœ¬

    Args:
        I: ç‹¬ç«‹æ€§åˆ†æ•° [-100, +100]

    Returns:
        è°ƒåˆ¶å‚æ•°
    """
    # å½’ä¸€åŒ–åˆ°[0, 1]
    I_norm = (I + 100) / 200.0

    # åº”ç”¨tanhå¹³æ»‘
    gamma = 4.0
    g_I = math.tanh(gamma * (I_norm - 0.5))  # [-1, +1]

    # 1. Teffè°ƒåˆ¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    # é€»è¾‘ï¼šIé«˜(ç‹¬ç«‹) â†’ Teffä½ â†’ æ¦‚ç‡æ›´æ¿€è¿›
    #       Iä½(è·Ÿéš) â†’ Teffé«˜ â†’ æ¦‚ç‡æ›´ä¿å®ˆ
    # I=+100 â†’ Teff_mult=0.9
    # I=0    â†’ Teff_mult=1.0
    # I=-100 â†’ Teff_mult=1.1
    beta_I = 0.10
    Teff_mult = 1.0 / (1.0 + beta_I * g_I)  # å…¬å¼ï¼š1/(1+Î²IÂ·gI)

    # 2. æˆæœ¬è°ƒåˆ¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    # é€»è¾‘ï¼šIä½(è·Ÿéš) â†’ å¢åŠ æˆæœ¬æƒ©ç½š
    #       Ié«˜(ç‹¬ç«‹) â†’ é™ä½æˆæœ¬ï¼ˆå¥–åŠ±ï¼‰
    # I=-100 â†’ cost=+0.005 (æƒ©ç½š)
    # I=0    â†’ cost=0
    # I=+100 â†’ cost=-0.003 (å¥–åŠ±)
    if I_norm < 0.3:
        cost_eff = 0.005  # ä½ç‹¬ç«‹æ€§æƒ©ç½š
    elif I_norm > 0.7:
        cost_eff = -0.003 * (I_norm - 0.7) / 0.3  # é«˜ç‹¬ç«‹æ€§å¥–åŠ±
    else:
        cost_eff = 0.0  # ä¸­æ€§

    return {
        "Teff_mult": Teff_mult,
        "cost_eff": cost_eff,
        "g_I": g_I,
        "I_norm": I_norm
    }
```

**å…³é”®è®¾è®¡**ï¼š
- **åŒå‘ä½œç”¨**ï¼šç‹¬ç«‹æ€§æ—¢å½±å“Teffä¹Ÿå½±å“cost
- **éå¯¹ç§°æˆæœ¬**ï¼šæƒ©ç½š(0.5%)å¤§äºå¥–åŠ±(0.3%)ï¼Œä¿æŒè°¨æ…
- **å¹³æ»‘è¿‡æ¸¡**ï¼šä¸­é—´åŒºåŸŸ(0.3-0.7)æˆæœ¬ä¸º0

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå››è°ƒåˆ¶å™¨ååŒæœºåˆ¶

### 3.1 è°ƒåˆ¶å™¨èåˆç­–ç•¥

**é—®é¢˜**ï¼š4ä¸ªè°ƒåˆ¶å™¨éƒ½å¯èƒ½è°ƒåˆ¶Teffï¼Œå¦‚ä½•èåˆï¼Ÿ

**æ–¹æ¡ˆ1ï¼šä¹˜æ³•èåˆ**ï¼ˆæ¨èï¼‰

```python
def fuse_modulators(L_out, S_out, F_out, I_out, T0=50.0):
    """
    èåˆ4ä¸ªè°ƒåˆ¶å™¨çš„è¾“å‡º

    Args:
        L_out, S_out, F_out, I_out: å„è°ƒåˆ¶å™¨è¾“å‡º
        T0: åŸºç¡€æ¸©åº¦

    Returns:
        æœ€ç»ˆè°ƒåˆ¶å‚æ•°
    """
    # 1. Teffèåˆï¼ˆä¹˜æ³•ï¼‰
    Teff = T0 * L_out["Teff_mult"] * S_out["Teff_mult"] * \
           F_out["Teff_mult"] * I_out["Teff_mult"]

    # é™åˆ¶èŒƒå›´
    Teff = max(25.0, min(100.0, Teff))

    # 2. cost_effèåˆï¼ˆåŠ æ³•ï¼‰
    cost_eff = L_out["cost_eff"] + I_out["cost_eff"]

    # 3. p_minèåˆï¼ˆåŠ æ³•ï¼‰
    p_min_base = 0.58
    p_min = p_min_base + F_out["p_min_adj"]
    p_min = max(0.50, min(0.75, p_min))

    # 4. confidenceèåˆï¼ˆä¹˜æ³•ï¼‰
    confidence_mult = S_out["confidence_mult"]

    # 5. positionèåˆï¼ˆä¹˜æ³•ï¼‰
    position_mult = L_out["position_mult"]

    return {
        "Teff": Teff,
        "cost_eff": cost_eff,
        "p_min": p_min,
        "delta_p_min": 0.03,  # å›ºå®š
        "confidence_mult": confidence_mult,
        "position_mult": position_mult
    }
```

**èåˆè§„åˆ™æ€»ç»“**ï¼š

| å‚æ•° | èåˆæ–¹å¼ | æ¥æº | è¯´æ˜ |
|------|---------|------|------|
| **Teff** | ä¹˜æ³• | LÃ—SÃ—FÃ—I | 4ä¸ªè°ƒåˆ¶å™¨éƒ½å½±å“ |
| **cost_eff** | åŠ æ³• | L+I | Lå’ŒIçš„æˆæœ¬ç´¯åŠ  |
| **p_min** | åŠ æ³• | base+F | åªæœ‰Få½±å“é—¨æ§› |
| **confidence_mult** | ç›´æ¥ | S | åªæœ‰Så½±å“ç½®ä¿¡åº¦ |
| **position_mult** | ç›´æ¥ | L | åªæœ‰Lå½±å“ä»“ä½ |

### 3.2 æç«¯æƒ…å†µåˆ†æ

**åœºæ™¯1ï¼šå…¨éƒ¨ä¼˜ç§€**
- L=100, S=+100, F=-100, I=+100
- Teff = 50 Ã— 1.0 Ã— 0.95 Ã— 0.85 Ã— 0.91 â‰ˆ **36.8** (æ¿€è¿›)
- cost_eff = 0 + (-0.003) = **-0.003** (å¥–åŠ±)
- position_mult = 1.0 (æ»¡ä»“)
- confidence_mult = 1.3 (é«˜ä¿¡å¿ƒ)
- **ç»“æœ**ï¼šé«˜æ¦‚ç‡ã€é«˜ä»“ä½ã€é«˜ç½®ä¿¡åº¦ â†’ ç†æƒ³ä¿¡å· âœ…

**åœºæ™¯2ï¼šå…¨éƒ¨ç³Ÿç³•**
- L=20, S=-100, F=+100, I=-100
- Teff = 50 Ã— 1.16 Ã— 1.05 Ã— 1.14 Ã— 1.10 â‰ˆ **76.8** (ä¿å®ˆ)
- cost_eff = 0.008 + 0.005 = **0.013** (é«˜æˆæœ¬)
- position_mult = 0.35 (å°ä»“ä½)
- confidence_mult = 0.7 (ä½ä¿¡å¿ƒ)
- **ç»“æœ**ï¼šä½æ¦‚ç‡ã€å°ä»“ä½ã€ä½ç½®ä¿¡åº¦ â†’ è‡ªç„¶è¿‡æ»¤ âœ…

**åœºæ™¯3ï¼šæµåŠ¨æ€§æå·®ä½†ä¿¡å·æå¥½**
- L=10, S=+100, F=-50, I=+100
- Teff = 50 Ã— 1.18 Ã— 0.95 Ã— 0.93 Ã— 0.91 â‰ˆ **48.5** (ç•¥ä¿å®ˆ)
- cost_eff = 0.009 + (-0.003) = **0.006** (ä»æœ‰æˆæœ¬)
- position_mult = **0.33** (å°ä»“ä½)
- confidence_mult = 1.3 (é«˜ä¿¡å¿ƒ)
- **ç»“æœ**ï¼šé«˜æ¦‚ç‡ä½†å°ä»“ä½ â†’ **ä¸ä¼šå®Œå…¨æ‹’ç»ï¼Œä½†æ§åˆ¶é£é™©** âœ…

---

## ç¬¬å››éƒ¨åˆ†ï¼šå¯¹æ¯”ç¡¬é—¨æ§›æ–¹æ¡ˆ

### 4.1 ç¡¬é—¨æ§›æ–¹æ¡ˆçš„é—®é¢˜

**åœºæ™¯**ï¼šL=20 (æµåŠ¨æ€§å¾ˆå·®), ä½†edge=0.9 (æå¼ºä¿¡å·)

**ç¡¬é—¨æ§›æ–¹æ¡ˆ**:
```
if L < 60:
    return None, "æµåŠ¨æ€§ä¸è¶³ï¼Œæ‹’ç»å¼€ä»“"
```
â†’ **å®Œå…¨é”™è¿‡é«˜æ”¶ç›Šæœºä¼š**

**è°ƒåˆ¶å™¨æ–¹æ¡ˆ**:
```
position_mult = 0.33  # å¼€33%ä»“ä½
cost_eff = 0.009      # é«˜æˆæœ¬
```
â†’ **å°ä»“ä½å‚ä¸ï¼Œæ§åˆ¶é£é™©ä½†ä¸é”™è¿‡æœºä¼š**

### 4.2 è°ƒåˆ¶å™¨æ–¹æ¡ˆçš„ä¼˜åŠ¿

1. **å¹³æ»‘è°ƒèŠ‚**ï¼šæ— 0æˆ–1çš„ç¡¬æˆªæ–­
2. **é£é™©å¯æ§**ï¼šé€šè¿‡å°ä»“ä½è€Œéæ‹’ç»æ¥æ§åˆ¶é£é™©
3. **æ”¶ç›Šæœ€å¤§åŒ–**ï¼šä¸ä¼šå®Œå…¨é”™è¿‡é«˜è´¨é‡ä¿¡å·
4. **è‡ªç„¶è¿‡æ»¤**ï¼šæå·®ä¿¡å·å› costå¤ªé«˜ï¼ŒEV<0è‡ªç„¶è¢«è¿‡æ»¤

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®ç°ä»£ç æ¡†æ¶

### 5.1 ModulatorChainç±»

```python
# ats_core/modulators/modulator_chain.py

import math
from typing import Dict, Any, Tuple
from dataclasses import dataclass

@dataclass
class ModulatorOutput:
    """ç»Ÿä¸€è°ƒåˆ¶å™¨è¾“å‡º"""
    Teff: float
    cost_eff: float
    p_min: float
    delta_p_min: float
    confidence_mult: float
    position_mult: float
    details: Dict[str, Any]


class ModulatorChain:
    """
    L/S/F/Iå››è°ƒåˆ¶å™¨é“¾

    ç»Ÿä¸€å¤„ç†æ‰€æœ‰è´¨é‡æŒ‡æ ‡çš„è°ƒåˆ¶
    """

    def __init__(self, params: Dict = None):
        """
        åˆå§‹åŒ–è°ƒåˆ¶å™¨é“¾

        Args:
            params: è°ƒåˆ¶å™¨å‚æ•°
        """
        self.params = params or {}
        self.T0 = self.params.get("T0", 50.0)

    def modulate_all(
        self,
        L: float,  # [0, 100]
        S: float,  # [-100, +100]
        F: float,  # [-100, +100]
        I: float,  # [-100, +100]
        symbol: str = "default"
    ) -> ModulatorOutput:
        """
        æ‰§è¡Œå››è°ƒåˆ¶å™¨é“¾

        Args:
            L: æµåŠ¨æ€§åˆ†æ•°
            S: ç»“æ„åˆ†æ•°
            F: æ‹¥æŒ¤åº¦åˆ†æ•°
            I: ç‹¬ç«‹æ€§åˆ†æ•°
            symbol: äº¤æ˜“å¯¹ï¼ˆç”¨äºçŠ¶æ€ç®¡ç†ï¼‰

        Returns:
            ModulatorOutput
        """
        # è°ƒç”¨å„è°ƒåˆ¶å™¨
        L_out = self._modulate_liquidity(L)
        S_out = self._modulate_structure(S)
        F_out = self._modulate_funding(F)
        I_out = self._modulate_independence(I)

        # èåˆç»“æœ
        result = self._fuse(L_out, S_out, F_out, I_out)

        return ModulatorOutput(
            Teff=result["Teff"],
            cost_eff=result["cost_eff"],
            p_min=result["p_min"],
            delta_p_min=result["delta_p_min"],
            confidence_mult=result["confidence_mult"],
            position_mult=result["position_mult"],
            details={
                "L": L_out,
                "S": S_out,
                "F": F_out,
                "I": I_out
            }
        )

    def _modulate_liquidity(self, L: float) -> dict:
        """Lè°ƒåˆ¶å™¨"""
        # [å®ç°å¦‚2.1èŠ‚]
        pass

    def _modulate_structure(self, S: float) -> dict:
        """Sè°ƒåˆ¶å™¨"""
        # [å®ç°å¦‚2.2èŠ‚]
        pass

    def _modulate_funding(self, F: float) -> dict:
        """Fè°ƒåˆ¶å™¨"""
        # [å®ç°å¦‚2.3èŠ‚]
        pass

    def _modulate_independence(self, I: float) -> dict:
        """Iè°ƒåˆ¶å™¨"""
        # [å®ç°å¦‚2.4èŠ‚]
        pass

    def _fuse(self, L_out, S_out, F_out, I_out) -> dict:
        """èåˆè°ƒåˆ¶å™¨è¾“å‡º"""
        # [å®ç°å¦‚3.1èŠ‚]
        pass


# å…¨å±€å®ä¾‹
_modulator_chain: ModulatorChain = None

def get_modulator_chain(params: Dict = None) -> ModulatorChain:
    """è·å–å…¨å±€è°ƒåˆ¶å™¨é“¾å®ä¾‹"""
    global _modulator_chain
    if _modulator_chain is None:
        _modulator_chain = ModulatorChain(params)
    return _modulator_chain
```

### 5.2 é›†æˆåˆ°analyze_symbol

```python
# ats_core/pipeline/analyze_symbol.py

from ats_core.modulators.modulator_chain import get_modulator_chain

def _analyze_symbol_core(...):
    # ... è®¡ç®—L/S/F/Iå› å­ ...

    # Aå±‚ï¼šæ–¹å‘å› å­ï¼ˆ6ä¸ªï¼‰
    scores = {
        "T": T, "M": M, "C": C, "V": V, "O": O, "B": B
    }

    # ScorecardåŠ æƒ
    edge, confidence_base = scorecard(scores, weights)

    # Bå±‚ï¼šå››è°ƒåˆ¶å™¨
    modulator = get_modulator_chain()
    mod_out = modulator.modulate_all(L, S, F, I, symbol)

    # åº”ç”¨è°ƒåˆ¶
    Teff = mod_out.Teff
    cost_eff = mod_out.cost_eff
    p_min = mod_out.p_min
    confidence = confidence_base * mod_out.confidence_mult

    # æ¦‚ç‡è®¡ç®—ï¼ˆä½¿ç”¨Teffï¼‰
    P = map_probability_sigmoid(edge, prior, quality, Teff)

    # EVè®¡ç®—ï¼ˆä½¿ç”¨cost_effï¼‰
    EV = calculate_ev(P, cost_eff)

    # ä»“ä½è®¡ç®—ï¼ˆä½¿ç”¨position_multï¼‰
    position_size_base = kelly_position(P, EV)
    position_size = position_size_base * mod_out.position_mult

    # ... è¿”å›ç»“æœ ...
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šé£é™©ä¸ç¼“è§£

### 6.1 æ½œåœ¨é£é™©

| é£é™© | æè¿° | ä¸¥é‡åº¦ |
|------|------|--------|
| **è¿‡åº¦ä¿å®ˆ** | 4ä¸ªè°ƒåˆ¶å™¨å åŠ ï¼ŒTeffå¯èƒ½è¿‡é«˜ï¼Œä¿¡å·é‡éª¤å‡ | ğŸ”´ é«˜ |
| **æµåŠ¨æ€§é™·é˜±** | æµåŠ¨æ€§æå·®çš„å¸ç§ä»å¼€ä»“ï¼Œæ»‘ç‚¹è¿‡å¤§ | ğŸŸ¡ ä¸­ |
| **å‚æ•°æ•æ„Ÿ** | 4ä¸ªè°ƒåˆ¶å™¨å‚æ•°ä¼—å¤šï¼Œè°ƒä¼˜å›°éš¾ | ğŸŸ¡ ä¸­ |
| **è°ƒè¯•å›°éš¾** | 4ä¸ªè°ƒåˆ¶å™¨äº¤äº’å¤æ‚ï¼Œéš¾ä»¥å®šä½é—®é¢˜ | ğŸŸ¢ ä½ |

### 6.2 ç¼“è§£æªæ–½

**1. é˜²æ­¢è¿‡åº¦ä¿å®ˆ**
```python
# Teffèåˆæ—¶åŠ æƒé‡
Teff = T0 * (
    0.6 * regime_mult +  # 60%æƒé‡ï¼šå¸‚åœºç¯å¢ƒ
    0.4 * (L_mult * S_mult * F_mult * I_mult)  # 40%æƒé‡ï¼šè°ƒåˆ¶å™¨
)
```

**2. æµåŠ¨æ€§åº•çº¿**
```python
# å³ä½¿ç”¨è°ƒåˆ¶å™¨ï¼Œä»ä¿ç•™Lçš„æœ€ä½é™åˆ¶
if L < 20:  # æç«¯æµåŠ¨æ€§å·®
    position_mult = min(position_mult, 0.2)  # æœ€å¤š20%ä»“ä½
```

**3. å‚æ•°åˆ†ç»„**
```python
# æä¾›é¢„è®¾å‚æ•°ç»„åˆ
MODULATOR_PRESETS = {
    "conservative": {  # ä¿å®ˆï¼šè°ƒåˆ¶å¼ºçƒˆ
        "L_min_position": 0.3,
        "S_confidence_range": (0.6, 1.4),
        # ...
    },
    "balanced": {  # å¹³è¡¡ï¼šé»˜è®¤
        "L_min_position": 0.4,
        "S_confidence_range": (0.7, 1.3),
        # ...
    },
    "aggressive": {  # æ¿€è¿›ï¼šè°ƒåˆ¶æ¸©å’Œ
        "L_min_position": 0.5,
        "S_confidence_range": (0.8, 1.2),
        # ...
    }
}
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæµ‹è¯•ä¸éªŒè¯

### 7.1 å•å…ƒæµ‹è¯•ç”¨ä¾‹

```python
def test_extreme_good():
    """å…¨éƒ¨æŒ‡æ ‡ä¼˜ç§€"""
    mod = ModulatorChain()
    out = mod.modulate_all(L=100, S=100, F=-100, I=100)

    assert out.Teff < 50  # æ¿€è¿›
    assert out.cost_eff < 0  # æœ‰å¥–åŠ±
    assert out.position_mult > 0.9  # å¤§ä»“ä½
    assert out.confidence_mult > 1.2  # é«˜ç½®ä¿¡åº¦

def test_extreme_bad():
    """å…¨éƒ¨æŒ‡æ ‡ç³Ÿç³•"""
    mod = ModulatorChain()
    out = mod.modulate_all(L=20, S=-100, F=100, I=-100)

    assert out.Teff > 60  # ä¿å®ˆ
    assert out.cost_eff > 0.01  # é«˜æˆæœ¬
    assert out.position_mult < 0.4  # å°ä»“ä½
    assert out.confidence_mult < 0.8  # ä½ç½®ä¿¡åº¦

def test_mixed_liquidity_poor_signal_good():
    """æµåŠ¨æ€§å·®ä½†ä¿¡å·å¥½"""
    mod = ModulatorChain()
    out = mod.modulate_all(L=15, S=80, F=-50, I=80)

    assert out.position_mult < 0.4  # å°ä»“ä½ï¼ˆå…³é”®ï¼‰
    assert out.confidence_mult > 1.1  # é«˜ç½®ä¿¡åº¦
    # å…³é”®ï¼šä¸ä¼šå®Œå…¨æ‹’ç»ï¼Œä½†ä»“ä½æ§åˆ¶å¾—å½“
```

### 7.2 å›æµ‹éªŒè¯æŒ‡æ ‡

- **ä¿¡å·é‡å˜åŒ–**ï¼šv6.5 vs v6.6
- **å¤æ™®æ¯”ç‡**ï¼šé£é™©è°ƒæ•´åæ”¶ç›Š
- **æœ€å¤§å›æ’¤**ï¼šæç«¯æƒ…å†µè¡¨ç°
- **ä»“ä½åˆ†å¸ƒ**ï¼šposition_multçš„å®é™…åˆ†å¸ƒ

---

## ç¬¬å…«éƒ¨åˆ†ï¼šå®æ–½è·¯çº¿

**Phase 1: å®ç°ModulatorChain** (4å°æ—¶)
1. å®ç°4ä¸ªè°ƒåˆ¶å™¨å‡½æ•° (2h)
2. å®ç°èåˆé€»è¾‘ (1h)
3. å•å…ƒæµ‹è¯• (1h)

**Phase 2: é›†æˆåˆ°analyze_symbol** (2å°æ—¶)
1. ä¿®æ”¹analyze_symbol.pyè°ƒç”¨ (1h)
2. ç§»é™¤æ—§çš„F/Iè°ƒåˆ¶å™¨è°ƒç”¨ (0.5h)
3. éªŒè¯æ•°æ®æµ (0.5h)

**Phase 3: å‚æ•°è°ƒä¼˜** (3å°æ—¶)
1. é»˜è®¤å‚æ•°è®¾ç½® (1h)
2. å›æµ‹éªŒè¯ (2h)

**æ€»è®¡**: 9å°æ—¶

---

**å¾…ç¡®è®¤**ï¼š
- [ ] æ˜¯å¦åŒæ„Lçš„æœ€å°ä»“ä½30%ï¼Ÿ
- [ ] æ˜¯å¦åŒæ„Sçš„confidenceè°ƒåˆ¶èŒƒå›´70%-130%ï¼Ÿ
- [ ] æ˜¯å¦åŒæ„Teffçš„ä¹˜æ³•èåˆæ–¹å¼ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦Lçš„åº•çº¿ä¿æŠ¤ï¼ˆL<20æ—¶positionâ‰¤20%ï¼‰ï¼Ÿ
