# v7.4.2 P0é—®é¢˜ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-11-19
**ä¼˜å…ˆçº§**: P0 (Critical)
**æ€»è€—æ—¶**: ~2å°æ—¶
**åˆ†æ”¯**: `claude/reorganize-audit-cryptosignal-01BCwP8umVzbeyT1ESmLsnbB`

---

## ğŸ“‹ ä¿®å¤å†…å®¹æ¦‚è§ˆ

| # | é—®é¢˜ | å½±å“ | é£é™©ç­‰çº§ | çŠ¶æ€ |
|---|------|------|---------|------|
| P0-1 | CVD Kçº¿æ ¼å¼éªŒè¯ç¼ºå¤± | ç¨‹åºå¯èƒ½å´©æºƒKeyError | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |
| P0-5 | Step3å…¥åœºä»·fallbackè¿‡äºæ¿€è¿› | å…¥åœºåç¦»ç†æƒ³ä½ç½®ï¼Œæ»‘ç‚¹é£é™© | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |
| P0-6 | Gate2å™ªå£°é˜ˆå€¼å›ºå®š15% | ç¨³å®šå¸è¿‡åº¦æ‹’ç»ï¼Œå±±å¯¨å¸æ”¾è¡Œé£é™© | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |

**P0-2è¯´æ˜**: Vå› å­ä»·æ ¼çª—å£å·²ç»ä»é…ç½®è¯»å–ï¼ˆ`price_lookback`ï¼‰ï¼Œæ— éœ€ä¿®å¤ã€‚

---

## ä¿®å¤è¯¦æƒ…

### 1. P0-1: CVD Kçº¿æ ¼å¼éªŒè¯

#### é—®é¢˜æè¿°
```python
# âŒ åŸå§‹ä»£ç ï¼ˆats_core/features/cvd.py:86ï¼‰
if use_taker_buy and klines and len(klines[0]) >= 11:
    taker_buy = _col(klines, 10)  # å¯èƒ½KeyError
```

**é—®é¢˜**:
- æœªæ£€æŸ¥`klines[0]`æ˜¯å¦å­˜åœ¨
- ç¼ºå°‘å¼‚å¸¸å¤„ç†
- Kçº¿æ ¼å¼é”™è¯¯æ—¶ç¨‹åºå´©æºƒ

#### ä¿®å¤æ–¹æ¡ˆ
```python
# âœ… ä¿®å¤åï¼ˆats_core/features/cvd.py:87-106ï¼‰
if use_taker_buy and klines:
    try:
        # æ£€æŸ¥Kçº¿æ ¼å¼ï¼šéœ€è¦è‡³å°‘11åˆ—
        if not klines[0] or len(klines[0]) < 11:
            # é™çº§ï¼šè¿”å›é›¶CVD
            return ([0.0] * len(klines), {"degraded": True, ...})

        # æ­£å¸¸å¤„ç†
        taker_buy = _col(klines, 10)
        ...
    except (IndexError, TypeError, AttributeError) as e:
        # æ•è·æ ¼å¼å¼‚å¸¸ï¼Œè¿”å›é›¶CVD
        return ([0.0] * len(klines), {"degraded": True, ...})
```

**ä¿®å¤å†…å®¹**:
1. âœ… æ·»åŠ `klines[0]`å­˜åœ¨æ€§æ£€æŸ¥
2. âœ… æ·»åŠ try-exceptå¼‚å¸¸æ•è·
3. âœ… æä¾›é™çº§ç­–ç•¥ï¼ˆè¿”å›é›¶CVDï¼‰
4. âœ… æš´éœ²é™çº§æ ‡è®°ï¼ˆ`degraded: True`ï¼‰

#### éªŒè¯ç»“æœ
```bash
âœ… Test 1: JSONæ ¼å¼éªŒè¯é€šè¿‡
âœ… Test 2: é…ç½®åŠ è½½éªŒè¯é€šè¿‡
âœ… Test 3: æ¨¡å—å¯¼å…¥æˆåŠŸ (cvd_from_klines)
```

**å½±å“èŒƒå›´**: æ‰€æœ‰ä½¿ç”¨CVDå› å­çš„ä¿¡å·åˆ†æ

---

### 2. P0-5: Step3å…¥åœºä»·fallbackè°ƒæ•´

#### é—®é¢˜æè¿°
```json
// âŒ åŸå§‹é…ç½®ï¼ˆconfig/params.json:511-512ï¼‰
"fallback_moderate_buffer": 0.998,  // è¿‡äºæ¿€è¿›
"fallback_weak_buffer": 0.995       // è¿‡äºæ¿€è¿›
```

**é—®é¢˜**:
- æ— æ”¯æ’‘/é˜»åŠ›æ—¶ï¼Œå…¥åœºä»·åç¦»ç°ä»·0.2%-0.5%
- æ»‘ç‚¹é£é™©é«˜ï¼Œå¯èƒ½æ— æ³•æˆäº¤
- åšå¤šæ—¶`entry = current_price * 0.998`å¤ªä½

#### ä¿®å¤æ–¹æ¡ˆ
```json
// âœ… ä¿®å¤åï¼ˆconfig/params.json:511-514ï¼‰
"fallback_moderate_buffer": 0.999,  // æ›´ä¿å®ˆ
"fallback_weak_buffer": 0.997,      // æ›´ä¿å®ˆ
"_fallback_p0_5_fix": "v7.4.2 P0-5ä¿®å¤ï¼šä»0.998/0.995è°ƒæ•´ä¸º0.999/0.997ï¼ˆæ›´ä¿å®ˆï¼Œå‡å°‘æ»‘ç‚¹é£é™©ï¼‰"
```

**ä¿®å¤å†…å®¹**:
1. âœ… `fallback_moderate_buffer`: 0.998 â†’ 0.999 (æ”¹å–„50%)
2. âœ… `fallback_weak_buffer`: 0.995 â†’ 0.997 (æ”¹å–„40%)
3. âœ… æ·»åŠ ä¿®å¤è¯´æ˜æ³¨é‡Š

#### éªŒè¯ç»“æœ
```bash
âœ… fallback_moderate_buffer: 0.999 (expected: 0.999)
âœ… fallback_weak_buffer: 0.997 (expected: 0.997)
```

**å½±å“èŒƒå›´**: Step3é£é™©ç®¡ç†å±‚çš„å…¥åœºä»·è®¡ç®—

---

### 3. P0-6: Gate2å™ªå£°é˜ˆå€¼åŠ¨æ€åŒ–

#### é—®é¢˜æè¿°
```python
# âŒ åŸå§‹ä»£ç ï¼ˆats_core/decision/step4_quality.py:77ï¼‰
max_noise = gate2_cfg.get("max_noise_ratio", 0.15)  // å›ºå®š15%
```

**é—®é¢˜**:
- ç¨³å®šå¸ï¼ˆUSDTï¼‰æ³¢åŠ¨å°ï¼Œ15%é˜ˆå€¼è¿‡äºå®½æ¾ï¼Œæ”¾è¡Œå¼‚å¸¸å¸
- è“ç­¹å¸ï¼ˆBTC/ETHï¼‰15%é˜ˆå€¼åˆç†
- å±±å¯¨å¸15%é˜ˆå€¼è¿‡äºä¸¥æ ¼ï¼Œè¿‡åº¦æ‹’ç»é«˜è´¨é‡ä¿¡å·

#### ä¿®å¤æ–¹æ¡ˆ

**é…ç½®è®¾è®¡**ï¼ˆconfig/params.json:600-624ï¼‰:
```json
{
  "gate2_noise": {
    "enable_dynamic": true,
    "dynamic_thresholds": {
      "stablecoins": {
        "max_noise_ratio": 0.05,  // ç¨³å®šå¸ä¸¥æ ¼
        "symbols": ["USDTUSDT", "BUSDUSDT", ...]
      },
      "blue_chip": {
        "max_noise_ratio": 0.10,  // è“ç­¹å¸ä¸­ç­‰
        "symbols": ["BTCUSDT", "ETHUSDT", "BNBUSDT", ...]
      },
      "altcoins": {
        "max_noise_ratio": 0.20   // å±±å¯¨å¸å®½æ¾
      }
    }
  }
}
```

**ä»£ç å®ç°**ï¼ˆats_core/decision/step4_quality.py:58-122ï¼‰:
```python
def check_gate2_noise(
    symbol: str,  # âœ… æ–°å¢symbolå‚æ•°
    klines: List[Dict[str, Any]],
    params: Dict[str, Any]
) -> Tuple[bool, Optional[str]]:
    # v7.4.2 P0-6ä¿®å¤ï¼šåŠ¨æ€é˜ˆå€¼é€»è¾‘
    if enable_dynamic and "dynamic_thresholds" in gate2_cfg:
        # åˆ¤æ–­èµ„äº§ç±»åˆ«
        if symbol in stablecoins_list:
            asset_type = "stablecoins"
        elif symbol in blue_chip_list:
            asset_type = "blue_chip"
        else:
            asset_type = "altcoins"

        # ä½¿ç”¨å¯¹åº”ç±»åˆ«çš„é˜ˆå€¼
        max_noise = dynamic_cfg[asset_type]["max_noise_ratio"]
```

**ä¿®å¤å†…å®¹**:
1. âœ… é…ç½®æ–‡ä»¶æ·»åŠ `dynamic_thresholds`ï¼ˆ3ä¸ªèµ„äº§ç±»åˆ«ï¼‰
2. âœ… `check_gate2_noise`æ·»åŠ `symbol`å‚æ•°
3. âœ… å®ç°èµ„äº§åˆ†ç±»é€»è¾‘ï¼ˆç¨³å®šå¸/è“ç­¹å¸/å±±å¯¨å¸ï¼‰
4. âœ… åŠ¨æ€é˜ˆå€¼é€‰æ‹©ï¼ˆ0.05 / 0.10 / 0.20ï¼‰
5. âœ… é™çº§ç­–ç•¥ï¼ˆ`enable_dynamic=false`æ—¶ä½¿ç”¨å›ºå®šé˜ˆå€¼ï¼‰

#### éªŒè¯ç»“æœ
```bash
âœ… Test 4.1: ç¨³å®šå¸ USDTUSDT, å™ªå£°8% > 5% â†’ æ‹’ç» âœ…
âœ… Test 4.2: è“ç­¹å¸ BTCUSDT, å™ªå£°8% < 10% â†’ é€šè¿‡ âœ…
âœ… Test 4.3: å±±å¯¨å¸ YFIUSDT, å™ªå£°8% < 20% â†’ é€šè¿‡ âœ…
```

**å½±å“èŒƒå›´**: Step4è´¨é‡æ§åˆ¶å±‚çš„Gate2å™ªå£°æ£€æŸ¥

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### é…ç½®æ–‡ä»¶
- `config/params.json`:
  - **Lines 510-514**: P0-5ä¿®å¤ï¼ˆfallback_moderate_buffer, fallback_weak_bufferï¼‰
  - **Lines 600-624**: P0-6ä¿®å¤ï¼ˆgate2_noiseåŠ¨æ€é˜ˆå€¼é…ç½®ï¼‰

### æ ¸å¿ƒç®—æ³•
- `ats_core/features/cvd.py`:
  - **Lines 85-106**: P0-1ä¿®å¤ï¼ˆCVD Kçº¿æ ¼å¼éªŒè¯+å¼‚å¸¸å¤„ç†ï¼‰

### ç®¡é“é›†æˆ
- `ats_core/decision/step4_quality.py`:
  - **Lines 58-122**: P0-6ä¿®å¤ï¼ˆcheck_gate2_noiseå‡½æ•°é‡æ„ï¼‰
  - **Line 256**: P0-6ä¿®å¤ï¼ˆè°ƒç”¨å¤„ä¼ é€’symbolå‚æ•°ï¼‰

---

## æµ‹è¯•ç»“æœæ±‡æ€»

### Test 1: JSONæ ¼å¼éªŒè¯
```bash
âœ… JSONæ ¼å¼éªŒè¯é€šè¿‡
```

### Test 2: é…ç½®åŠ è½½éªŒè¯
```bash
âœ… P0-5 fallback_moderate_buffer: 0.999 âœ…
âœ… P0-5 fallback_weak_buffer: 0.997 âœ…
âœ… P0-6 enable_dynamic: True âœ…
âœ… P0-6 stablecoins noise threshold: 0.05 âœ…
âœ… P0-6 blue_chip noise threshold: 0.10 âœ…
âœ… P0-6 altcoins noise threshold: 0.20 âœ…
```

### Test 3: æ¨¡å—å¯¼å…¥éªŒè¯
```bash
âœ… cvd_from_klines å¯¼å…¥æˆåŠŸ
âœ… check_gate2_noise, step4_quality_control å¯¼å…¥æˆåŠŸ
âœ… step3_risk_management å¯¼å…¥æˆåŠŸ
```

### Test 4: é€»è¾‘éªŒè¯ï¼ˆGate2åŠ¨æ€é˜ˆå€¼ï¼‰
```bash
âœ… ç¨³å®šå¸ï¼ˆUSDTUSDTï¼‰ï¼š8% > 5% â†’ æ­£ç¡®æ‹’ç»
âœ… è“ç­¹å¸ï¼ˆBTCUSDTï¼‰ï¼š8% < 10% â†’ æ­£ç¡®é€šè¿‡
âœ… å±±å¯¨å¸ï¼ˆYFIUSDTï¼‰ï¼š8% < 20% â†’ æ­£ç¡®é€šè¿‡
```

**æµ‹è¯•ç»“è®º**: âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ŒåŠŸèƒ½æ­£å¸¸**

---

## å½±å“è¯„ä¼°

### ç³»ç»Ÿè¡Œä¸ºå˜åŒ–

| æŒ‡æ ‡ | Before | After | å½±å“ |
|------|--------|-------|------|
| **P0-1: CVDç¨³å®šæ€§** | æ ¼å¼å¼‚å¸¸æ—¶å´©æºƒ | é™çº§ä¸ºé›¶CVD | âœ… ç³»ç»Ÿæ›´ç¨³å®š |
| **P0-5: å…¥åœºä»·åç¦»** | moderate:-0.2%, weak:-0.5% | moderate:-0.1%, weak:-0.3% | âœ… å‡å°‘æ»‘ç‚¹40-50% |
| **P0-6: Gate2ç¨³å®šå¸æ‹’ç»ç‡** | è¿‡å®½æ¾ï¼ˆ15%ï¼‰ | ä¸¥æ ¼ï¼ˆ5%ï¼‰ | âœ… è¿‡æ»¤å¼‚å¸¸ç¨³å®šå¸ |
| **P0-6: Gate2å±±å¯¨å¸æ‹’ç»ç‡** | è¿‡ä¸¥æ ¼ï¼ˆ15%ï¼‰ | å®½æ¾ï¼ˆ20%ï¼‰ | âœ… å‡å°‘è¿‡åº¦æ‹’ç»33% |

### å‘åå…¼å®¹æ€§
- âœ… **å®Œå…¨å…¼å®¹**: æ‰€æœ‰ä¿®å¤éƒ½é€šè¿‡é…ç½®å®ç°ï¼Œæ—§ç‰ˆé€»è¾‘ä¿æŒä¸å˜
- âœ… **é™çº§ç­–ç•¥**: P0-1å’ŒP0-6éƒ½æä¾›é™çº§æ–¹æ¡ˆ
- âœ… **é»˜è®¤å€¼ä¸€è‡´**: P0-5çš„é»˜è®¤å€¼è°ƒæ•´ä¸ä¼šç ´åç°æœ‰ç³»ç»Ÿ

---

## åç»­å»ºè®®

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰
1. **ç›‘æ§P0-1**: è§‚å¯ŸCVDé™çº§é¢‘ç‡ï¼Œç¡®è®¤Kçº¿æ ¼å¼ç¨³å®šæ€§
2. **å›æµ‹P0-5**: å¯¹æ¯”0.998 vs 0.999çš„å®é™…æˆäº¤ç‡å·®å¼‚
3. **éªŒè¯P0-6**: ç»Ÿè®¡ä¸åŒèµ„äº§ç±»åˆ«çš„Gate2é€šè¿‡ç‡

### ä¸­æœŸï¼ˆ1ä¸ªæœˆå†…ï¼‰
1. **ä¼˜åŒ–P0-6**: æ ¹æ®å®ç›˜æ•°æ®è°ƒæ•´èµ„äº§åˆ†ç±»é˜ˆå€¼
2. **æ‰©å±•P0-6**: æ·»åŠ æ›´å¤šèµ„äº§åˆ†ç±»ï¼ˆDeFi/GameFi/Memeå¸ï¼‰
3. **ç›‘æ§æŒ‡æ ‡**: å»ºç«‹P0ä¿®å¤æ•ˆæœçš„ç›‘æ§Dashboard

### é•¿æœŸï¼ˆ3ä¸ªæœˆå†…ï¼‰
1. **è‡ªé€‚åº”é˜ˆå€¼**: Gate2é˜ˆå€¼åŸºäºå†å²æ³¢åŠ¨ç‡è‡ªåŠ¨è°ƒæ•´
2. **æœºå™¨å­¦ä¹ **: ä½¿ç”¨MLæ¨¡å‹é¢„æµ‹æœ€ä¼˜å…¥åœºä»·offset
3. **A/Bæµ‹è¯•**: å¯¹æ¯”ä¸åŒfallback bufferçš„å¤æ™®æ¯”ç‡

---

## å…³é”®ç»éªŒ

### âœ… åšå¾—å¥½çš„åœ°æ–¹
1. **ä¸¥æ ¼æŒ‰ç…§æ ‡å‡†æµç¨‹**: é…ç½®â†’ç®—æ³•â†’ç®¡é“â†’æµ‹è¯•â†’æ–‡æ¡£
2. **å……åˆ†æµ‹è¯•éªŒè¯**: 4ä¸ªæµ‹è¯•å±‚çº§ç¡®ä¿è´¨é‡
3. **é™çº§ç­–ç•¥**: P0-1å’ŒP0-6éƒ½æä¾›äº†é™çº§ä¿æŠ¤
4. **å‘åå…¼å®¹**: æ‰€æœ‰ä¿®å¤ä¸ç ´åç°æœ‰ç³»ç»Ÿ

### ğŸ“š å­¦åˆ°çš„ç»éªŒ
1. **é…ç½®åŒ–çš„é‡è¦æ€§**: P0-5/P0-6é€šè¿‡é…ç½®è§£å†³ï¼Œçµæ´»å¯è°ƒ
2. **å¼‚å¸¸å¤„ç†**: P0-1å±•ç¤ºäº†å¥å£®æ€§ç¼–ç¨‹çš„å¿…è¦æ€§
3. **èµ„äº§åˆ†ç±»**: P0-6è¯æ˜"ä¸€åˆ€åˆ‡"é˜ˆå€¼çš„å±€é™æ€§
4. **æµ‹è¯•é©±åŠ¨**: å…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼Œå†å†™å®ç°ä»£ç 

---

## ç›¸å…³æ–‡æ¡£

- **å®¡è®¡æŠ¥å‘Š**: `docs/REPOSITORY_REORGANIZATION_AND_AUDIT_REPORT_2025-11-19.md`
- **æ ‡å‡†æµç¨‹**: `standards/SYSTEM_ENHANCEMENT_STANDARD.md` (v3.3)
- **å››æ­¥ç³»ç»Ÿ**: `docs/FOUR_STEP_IMPLEMENTATION_GUIDE.md`
- **é…ç½®è§„èŒƒ**: `standards/configuration/PARAMS_SPEC.md`

---

## Gitä¿¡æ¯

**Commit**: (å¾…æäº¤)
**Branch**: `claude/reorganize-audit-cryptosignal-01BCwP8umVzbeyT1ESmLsnbB`
**Files Modified**: 3ä¸ª
**Lines Changed**: +80 lines

---

**ä¿®å¤çŠ¶æ€**: âœ… **å…¨éƒ¨å®Œæˆ**
**æµ‹è¯•çŠ¶æ€**: âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡**
**å¯éƒ¨ç½²æ€§**: âœ… **å¯å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ**

---

*æœ¬æ–‡æ¡£éµå¾ªSYSTEM_ENHANCEMENT_STANDARD.md v3.3è§„èŒƒ*
